<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIS Workflows Uploader for Intune</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            margin-bottom: 20px;
            color: #2a5298;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 svg {
            width: 24px;
            height: 24px;
        }

        .auth-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-status {
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: 500;
        }

        .auth-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .auth-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #2a5298;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3c72;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn svg {
            pointer-events: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: auto !important;
        }

        .workflow-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }

        .workflow-item {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .workflow-item:hover {
            background: #f0f0f0;
        }

        .workflow-item.selected {
            background: #e3f2fd;
            border: 1px solid #2196F3;
        }

        .workflow-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .upload-options {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .progress-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            width: 0%;
            transition: width 0.5s ease;
        }

        .results-section {
            display: none;
            margin-top: 20px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .results-table th,
        .results-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .status-success {
            color: #28a745;
            font-weight: 500;
        }

        .status-error {
            color: #dc3545;
            font-weight: 500;
        }

        .status-skipped {
            color: #ffc107;
            font-weight: 500;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .footer {
            text-align: center;
            color: white;
            padding: 20px;
            opacity: 0.8;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .how-to-section {
            background: #f0f8ff;
            border: 2px solid #2a5298;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .how-to-section h3 {
            color: #2a5298;
            margin-bottom: 15px;
        }

        .how-to-section h4 {
            color: #1e3c72;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .how-to-section ol {
            margin-left: 20px;
        }

        .how-to-section li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .how-to-section code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .collapsible {
            cursor: pointer;
            padding: 10px;
            background: #2a5298;
            color: white;
            border: none;
            border-radius: 5px;
            width: 100%;
            text-align: left;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible:hover {
            background: #1e3c72;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.active {
            max-height: 3000px;
            transition: max-height 0.5s ease-in;
        }

        .collapsible::after {
            content: '\25BC';
            font-size: 12px;
            transition: transform 0.3s;
        }

        .collapsible.active::after {
            transform: rotate(180deg);
        }

        .redirect-uri-box {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .redirect-uri-box h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .redirect-uri-display {
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.9em;
        }

        .copy-btn {
            padding: 5px 15px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .copy-btn:hover {
            background: #138496;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CIS Workflows Uploader</h1>
            <p>Upload CIS compliance workflows to Microsoft Intune</p>
        </div>

        <div class="alert alert-warning">
            <strong>⚠️ Sandboxed Environment Detected!</strong>
            <p>You're running this in a restricted environment (Google Colab, etc.). Some features may not work:</p>
            <ul style="margin-top: 5px; margin-bottom: 0;">
                <li><strong>Authentication popups may be blocked</strong> - Use manual token input option if needed</li>
                <li><strong>Clipboard API is blocked</strong> - You'll need to manually copy the redirect URI</li>
                <li><strong>Best solution:</strong> Download this HTML file and run it locally for full functionality</li>
            </ul>
            <p style="margin-top: 10px;">
                <strong>To download:</strong> Right-click on this page → "Save As" → Save as HTML file → Open locally
            </p>
        </div>

        <div class="alert alert-info">
            <strong>Note:</strong> This tool requires Microsoft Graph API permissions:
            <ul style="margin-top: 5px; margin-bottom: 0;">
                <li>DeviceManagementConfiguration.ReadWrite.All - To create configuration policies</li>
                <li>Organization.Read.All - To read organization info</li>
                <li>Group.Read.All - To validate and assign to groups</li>
            </ul>
            <small>Platform: Works on Windows, macOS, and Linux in any modern browser</small>
        </div>

        <!-- Current Redirect URI Alert -->
        <div class="alert alert-danger" id="redirectUriAlert">
            <strong>Important - Dynamic Redirect URI Detected!</strong>
            <div class="redirect-uri-box">
                <h4>Your current redirect URI is:</h4>
                <div class="redirect-uri-display" id="currentRedirectUri"></div>
                <button class="copy-btn" onclick="window.copyRedirectUri(event)">Copy to Clipboard</button>
                <p style="margin-top: 10px;">
                    <strong>You must add this exact URI to your Entra ID app registration before signing in!</strong><br>
                    This URI changes each time you load the page in an embedded environment.
                </p>
            </div>
        </div>

        <!-- How to Get Client ID Section -->
        <div class="card" style="margin-bottom: 20px;">
            <button class="collapsible" id="howToToggle">
                <span>How to Get Your Entra ID Client ID</span>
            </button>
            <div class="collapsible-content" id="howToContent">
                <div class="how-to-section">
                    <h3>Step-by-Step Guide to Register Your Application</h3>
                    
                    <div class="alert alert-warning">
                        <strong>⚠️ Dynamic Environment Warning:</strong> If you're running this in Google Colab, JSFiddle, or similar platforms, the redirect URI changes each time. You'll need to update it in Entra ID before each use.
                        <h4>Troubleshooting Upload Issues:</h4>
                    <ul>
                        <li><strong>Button not responding:</strong> Check browser console (F12) for errors</li>
                        <li><strong>403 Forbidden:</strong> Admin consent not granted - have an admin grant consent in Entra ID</li>
                        <li><strong>401 Unauthorized:</strong> Token expired - sign out and sign in again</li>
                        <li><strong>400 Bad Request:</strong> Workflow JSON format issue - check the workflow file</li>
                        <li><strong>Platform doesn't matter:</strong> Works on Windows, macOS, and Linux</li>
                    </ul>
                    
                    <h4>Testing Your Setup:</h4>
                    <p>After signing in, open the browser console (F12) and run:</p>
                    <ul>
                        <li><code>window.testGraphAPI()</code> - Test Intune API connection</li>
                        <li><code>window.debugUpload()</code> - Check current state</li>
                        <li><code>window.handleUploadClick()</code> - Manually trigger upload</li>
                    </ul>
                </div>
                    
                    <h4>Step 1: Register an Application in Entra ID</h4>
                    <ol>
                        <li>Go to the <a href="https://entra.microsoft.com" target="_blank">Microsoft Entra Portal</a></li>
                        <li>Navigate to <strong>Applications</strong> → <strong>App registrations</strong></li>
                        <li>Click <strong>New registration</strong></li>
                        <li>Configure the application:
                            <ul style="margin-top: 5px;">
                                <li><strong>Name:</strong> CIS Workflows Uploader (or any name you prefer)</li>
                                <li><strong>Supported account types:</strong> Choose based on your needs:
                                    <ul>
                                        <li>"Accounts in this organizational directory only" (single tenant)</li>
                                        <li>"Accounts in any organizational directory" (multi-tenant)</li>
                                    </ul>
                                </li>
                                <li><strong>Redirect URI:</strong>
                                    <ul>
                                        <li>Platform: <code>Single-page application (SPA)</code></li>
                                        <li>URI: <strong style="color: red;">Copy the URI shown above in the yellow box</strong></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li>Click <strong>Register</strong></li>
                    </ol>

                    <h4>Step 2: Configure API Permissions</h4>
                    <ol>
                        <li>In your app registration, go to <strong>API permissions</strong></li>
                        <li>Click <strong>Add a permission</strong></li>
                        <li>Select <strong>Microsoft Graph</strong></li>
                        <li>Choose <strong>Delegated permissions</strong></li>
                        <li>Search for and add these permissions:
                            <ul style="margin-top: 5px;">
                                <li><code>DeviceManagementConfiguration.ReadWrite.All</code> - Required for creating configuration policies</li>
                                <li><code>Organization.Read.All</code> - Required for reading organization information</li>
                                <li><code>Group.Read.All</code> - Required for group assignment validation</li>
                            </ul>
                        </li>
                        <li>Click <strong>Add permissions</strong></li>
                        <li><strong style="color: red;">Important:</strong> Click <strong>Grant admin consent for [Your Organization]</strong></li>
                        <li>Ensure all permissions show a green checkmark under "Status"</li>
                    </ol>

                    <h4>Step 3: Get Your Client ID</h4>
                    <ol>
                        <li>Go to the <strong>Overview</strong> page of your app registration</li>
                        <li>Copy the <strong>Application (client) ID</strong> (it looks like: <code>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</code>)</li>
                        <li>Paste it in the Client ID field below</li>
                    </ol>

                    <h4>Step 4: Managing Dynamic Redirect URIs</h4>
                    <ol>
                        <li>If using this tool in a dynamic environment (like Google Colab), you'll need to update the redirect URI each time</li>
                        <li>Go to <strong>Authentication</strong> in your app registration</li>
                        <li>Under <strong>Single-page application</strong>, add the new redirect URI shown above</li>
                        <li>Remove old redirect URIs that are no longer needed</li>
                        <li>Click <strong>Save</strong></li>
                    </ol>

                    <h4>Alternative: Use a Static Hosting Service</h4>
                    <p>To avoid changing the redirect URI each time, consider hosting this HTML file on:</p>
                    <ul>
                        <li>GitHub Pages (free)</li>
                        <li>Netlify (free tier available)</li>
                        <li>Microsoft Azure Static Web Apps (free tier available)</li>
                        <li>Your own web server</li>
                    </ul>
                    <p>This way, you'll have a permanent URL that doesn't change.</p>

                    <h4>Important Notes:</h4>
                    <ul>
                        <li>The redirect URI must match <strong>exactly</strong> - including protocol (http/https) and any trailing slashes</li>
                        <li>Admin consent is required for the Graph API permissions</li>
                        <li>The Client ID is safe to share - authentication still requires user credentials</li>
                        <li>For production use, always use HTTPS</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Authentication Card -->
            <div class="card">
                <h2>
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2H7V7a3 3 0 016 0v2a1 1 0 11-2 0V7a1 1 0 10-2 0v2h2v5a1 1 0 11-2 0v-3a1 1 0 10-2 0v3a3 3 0 106 0v-5h2V7a5 5 0 00-5-5z"/>
                    </svg>
                    Authentication
                </h2>
                <div class="auth-section">
                    <div class="form-group">
                        <label for="clientId">Entra ID Client ID:</label>
                        <input type="text" id="clientId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" 
                               pattern="[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}"
                               title="Enter a valid GUID format">
                        <small style="display: block; margin-top: 5px; color: #666;">Enter your Entra ID application Client ID</small>
                    </div>
                    <div id="authStatus" class="auth-status disconnected">
                        Not connected to Microsoft Graph
                    </div>
                    <button id="loginBtn" class="btn btn-primary" disabled>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                        </svg>
                        Sign in with Microsoft
                    </button>
                    <div id="userInfo" style="display: none;">
                        <strong>Signed in as:</strong> <span id="userEmail"></span>
                    </div>
                </div>
            </div>

            <!-- Workflow Selection Card -->
            <div class="card">
                <h2>
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2H6a2 2 0 00-2 2v6a2 2 0 002 2h2a1 1 0 100-2H6V7h11a1 1 0 110 2h-1v4a2 2 0 01-2 2h-2a1 1 0 100 2h2a2 2 0 002-2V7a2 2 0 00-2-2H6a2 2 0 00-2 2v6z"/>
                    </svg>
                    Select Workflows
                </h2>
                
                <div class="form-group">
                    <div class="file-input-wrapper">
                        <button class="btn btn-secondary">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                            </svg>
                            Load Workflows from JSON Files
                        </button>
                        <input type="file" id="workflowFiles" multiple accept=".json">
                    </div>
                    <small style="display: block; margin-top: 5px; color: #666;">Select multiple JSON workflow files</small>
                </div>

                <div id="workflowListContainer" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label><strong>Available Workflows:</strong></label>
                        <div>
                            <button id="selectAllBtn" class="btn btn-secondary" style="padding: 5px 10px; font-size: 14px;">Select All</button>
                            <button id="deselectAllBtn" class="btn btn-secondary" style="padding: 5px 10px; font-size: 14px;">Deselect All</button>
                        </div>
                    </div>
                    <div id="workflowList" class="workflow-list"></div>
                    <p style="margin-top: 10px; color: #666;">
                        <span id="selectedCount">0</span> workflow(s) selected
                    </p>
                </div>
            </div>
        </div>

        <!-- Upload Options Card -->
        <div class="card" id="uploadOptionsCard" style="display: none;">
            <h2>
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                </svg>
                Upload Options
            </h2>
            
            <div class="upload-options">
                <div class="form-group">
                    <label>Workflow Name Prefix (optional):</label>
                    <input type="text" id="workflowPrefix" placeholder="e.g., 'CIS - '">
                </div>

                <div class="form-group">
                    <label>Assignment Target:</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="assignmentTarget" value="none" checked>
                            No Assignment
                        </label>
                        <label>
                            <input type="radio" name="assignmentTarget" value="allUsers">
                            All Users
                        </label>
                        <label>
                            <input type="radio" name="assignmentTarget" value="allDevices">
                            All Devices
                        </label>
                        <label>
                            <input type="radio" name="assignmentTarget" value="group">
                            Specific Group
                        </label>
                    </div>
                </div>

                <div class="form-group" id="groupNameContainer" style="display: none;">
                    <label>Group Name:</label>
                    <input type="text" id="groupName" placeholder="Enter security group name">
                    <button id="validateGroupBtn" class="btn btn-secondary" style="margin-top: 10px;">Validate Group</button>
                    <div id="groupValidationResult" style="margin-top: 10px;"></div>
                </div>

                <button id="uploadBtn" class="btn btn-success" disabled title="Sign in and select workflows to enable">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                    </svg>
                    Upload Selected Workflows
                </button>
                <small id="uploadBtnStatus" style="display: block; margin-top: 5px; color: #666;"></small>
            </div>

            <div class="progress-section" id="progressSection">
                <h3>Upload Progress</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                    <span id="progressPercent" style="position: absolute; left: 50%; transform: translateX(-50%); z-index: 10; color: #333; font-weight: bold;"></span>
                </div>
                <p id="progressText" style="margin-top: 10px; text-align: center;">Preparing upload...</p>
                <div id="progressDetails" style="margin-top: 15px; font-size: 14px; color: #666;"></div>
            </div>
        </div>

        <!-- Results Card -->
        <div class="card results-section" id="resultsSection">
            <h2>
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
                Upload Results
            </h2>
            <button id="downloadResultsBtn" class="btn btn-secondary" style="margin-bottom: 10px;">
                Download Results as CSV
            </button>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Workflow Name</th>
                        <th>Status</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody">
                </tbody>
            </table>
        </div>

        <div class="footer">
            <p>&copy; 2025 CIS Workflows Uploader - Mann Consulting</p>
        </div>
    </div>

    <!-- Include MSAL library for Microsoft authentication -->
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    
    <script>
        console.log('Script loading - CIS Workflows Uploader');
        
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Initializing CIS Workflows Uploader');
            
            try {
                // Detect and display current redirect URI (declare once)
                const currentUrl = window.location.href.split('#')[0].split('?')[0];
                window.currentUrl = currentUrl; // Make globally accessible
                
                const redirectUriElement = document.getElementById('currentRedirectUri');
                if (redirectUriElement) {
                    redirectUriElement.textContent = currentUrl;
                    console.log('Redirect URI set to:', currentUrl);
                } else {
                    console.error('Redirect URI element not found!');
                }

        // Check if we're in a dynamic environment
        const isDynamicEnvironment = currentUrl.includes('googleusercontent.com') || 
                                     currentUrl.includes('jsfiddle.net') || 
                                     currentUrl.includes('codepen.io') ||
                                     currentUrl.includes('stackblitz.com') ||
                                     currentUrl.includes('codesandbox.io') ||
                                     currentUrl.includes('colab') ||
                                     currentUrl.includes('localhost') ||
                                     currentUrl.includes('127.0.0.1');

        // Detect sandboxed environment (where modals are blocked)
        const isSandboxed = currentUrl.includes('googleusercontent.com') ||
                           currentUrl.includes('google.com') ||
                           currentUrl.includes('googlesites.com') ||
                           currentUrl.includes('sites.google.com') ||
                           currentUrl.includes('colab') ||
                           currentUrl.includes('jsfiddle') ||
                           currentUrl.includes('codepen') ||
                           currentUrl.includes('stackblitz') ||
                           currentUrl.includes('codesandbox') ||
                           document.querySelector('iframe') !== null; // Basic iframe detection

        // Store globally for use throughout the app
        window.isSandboxed = isSandboxed;

        console.log('Environment check:', { 
            currentUrl, 
            isDynamicEnvironment, 
            isSandboxed,
            modalsSafe: !isSandboxed 
        });

        const redirectAlert = document.getElementById('redirectUriAlert');
        if (!isDynamicEnvironment && redirectAlert) {
            // Hide the redirect URI alert if we're not in a dynamic environment
            redirectAlert.style.display = 'none';
            console.log('Hiding redirect URI alert for static environment');
        } else if (redirectAlert) {
            redirectAlert.style.display = 'block';
            console.log('Showing redirect URI alert for dynamic environment');
        }

        // Copy redirect URI function - make it globally accessible
        function copyRedirectUri(event) {
            const redirectUri = document.getElementById('currentRedirectUri').textContent;
            const btn = event ? event.target : document.querySelector('.copy-btn');
            
            console.log('Copying redirect URI:', redirectUri);
            
            // Always use fallback method in sandboxed environments
            fallbackCopyToClipboard(redirectUri, btn);
        }
        
        // Attach copy button handler
        
        // Fallback copy method for sandboxed environments
        function fallbackCopyToClipboard(text, btn) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    btn.style.background = '#28a745';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#17a2b8';
                    }, 2000);
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                alert('Copy failed. Please manually copy the redirect URI:\n\n' + text);
            }
            
            document.body.removeChild(textArea);
        }

        // Make copyRedirectUri globally accessible
        window.copyRedirectUri = copyRedirectUri;
        
        // Ensure redirect URI is displayed (backup method)
        setTimeout(() => {
            const redirectUriElement = document.getElementById('currentRedirectUri');
            if (redirectUriElement && !redirectUriElement.textContent.trim()) {
                redirectUriElement.textContent = window.currentUrl;
                console.log('Backup: Set redirect URI to:', window.currentUrl);
            }
        }, 1000);

        // MSAL configuration
        let msalInstance = null;
        let msalConfig = null;

        // Global variables
        let accessToken = null;
        let selectedWorkflows = [];
        let workflowData = {};
        let validatedGroupId = null;
        let uploadClickCount = 0;

        // DOM elements (declare once)
        const clientIdInput = document.getElementById('clientId');
        const loginBtn = document.getElementById('loginBtn');
        const authStatus = document.getElementById('authStatus');
        const userInfo = document.getElementById('userInfo');
        const userEmail = document.getElementById('userEmail');
        const workflowFiles = document.getElementById('workflowFiles');
        const workflowList = document.getElementById('workflowList');
        const selectedCount = document.getElementById('selectedCount');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultsSection = document.getElementById('resultsSection');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const workflowListContainer = document.getElementById('workflowListContainer');
        const uploadOptionsCard = document.getElementById('uploadOptionsCard');
        const groupNameContainer = document.getElementById('groupNameContainer');
        const validateGroupBtn = document.getElementById('validateGroupBtn');
        const groupValidationResult = document.getElementById('groupValidationResult');

        // Debug DOM elements
        console.log('DOM Elements Check:', {
            clientIdInput: !!clientIdInput,
            loginBtn: !!loginBtn,
            uploadBtn: !!document.getElementById('uploadBtn')
        });
        
        // Set initial button state
        updateUploadButtonState();

        // Setup Collapsible How-To Section
        const howToToggle = document.getElementById('howToToggle');
        const howToContent = document.getElementById('howToContent');

        if (howToToggle && howToContent) {
            howToToggle.addEventListener('click', () => {
                console.log('How-to toggle clicked');
                howToToggle.classList.toggle('active');
                howToContent.classList.toggle('active');
            });

            // Auto-expand how-to section if in dynamic environment
            if (isDynamicEnvironment) {
                howToToggle.classList.add('active');
                howToContent.classList.add('active');
                console.log('Auto-expanded how-to section for dynamic environment');
            }
        } else {
            console.error('How-to toggle elements not found:', { howToToggle: !!howToToggle, howToContent: !!howToContent });
        }

        // Ensure redirect URI display (avoid variable redeclaration)
        setTimeout(() => {
            const uriElement = document.getElementById('currentRedirectUri');
            if (uriElement) {
                uriElement.textContent = window.currentUrl;
                uriElement.style.display = 'block';
                console.log('✅ Redirect URI displayed:', window.currentUrl);
                
                // Make sure the parent alert is visible
                const redirectAlert = document.getElementById('redirectUriAlert');
                if (redirectAlert) {
                    redirectAlert.style.display = 'block';
                    console.log('✅ Redirect URI alert made visible');
                }
            } else {
                console.error('❌ Redirect URI element not found!');
            }
        }, 100);

        // Client ID validation
        clientIdInput.addEventListener('input', (e) => {
            const clientId = e.target.value.trim();
            const guidPattern = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;
            
            if (guidPattern.test(clientId)) {
                loginBtn.disabled = false;
                clientIdInput.style.borderColor = '#28a745';
                
                // Initialize MSAL with the provided client ID
                msalConfig = {
                    auth: {
                        clientId: clientId,
                        authority: 'https://login.microsoftonline.com/common',
                        redirectUri: window.currentUrl  // Use the global current URL as redirect URI
                    },
                    cache: {
                        cacheLocation: 'sessionStorage',
                        storeAuthStateInCookie: true  // Changed to true for better sandbox compatibility
                    }
                };
                
                try {
                    msalInstance = new msal.PublicClientApplication(msalConfig);
                    console.log('MSAL instance created successfully');
                    
                    // Check for existing session
                    checkExistingSession();
                } catch (error) {
                    console.error('Error creating MSAL instance:', error);
                    
                    if (window.isSandboxed) {
                        console.log('🚨 SANDBOX MODE: Authentication initialization error');
                        console.log('Please check your Client ID and try again');
                    } else {
                        try {
                            alert('Error initializing authentication. Please check your Client ID.');
                        } catch (alertError) {
                            console.log('Alert blocked - Authentication initialization error (check console)');
                        }
                    }
                }
            } else {
                loginBtn.disabled = true;
                clientIdInput.style.borderColor = clientId ? '#dc3545' : '#ddd';
            }
        });

        // Authentication with better error handling for sandboxed environments
        loginBtn.addEventListener('click', async () => {
            if (!msalInstance) {
                console.error('❌ No MSAL instance - please enter a valid Client ID first');
                
                if (window.isSandboxed) {
                    console.log('🚨 SANDBOX MODE: Please enter a valid Client ID first');
                } else {
                    try {
                        alert('Please enter a valid Client ID first');
                    } catch (e) {
                        console.log('Alert blocked - Enter a valid Client ID first');
                    }
                }
                return;
            }

            try {
                console.log('Attempting authentication...');
                const loginRequest = {
                    scopes: [
                        'DeviceManagementConfiguration.ReadWrite.All',
                        'Organization.Read.All',
                        'Group.Read.All'
                    ]
                };

                const loginResponse = await msalInstance.loginPopup(loginRequest);
                handleAuthentication(loginResponse);
            } catch (error) {
                console.error('Login failed:', error);
                let errorMessage = 'Authentication failed in this sandboxed environment.\n\n';
                
                if (error.message && error.message.includes('postMessage')) {
                    errorMessage += 'SOLUTION: Please download this HTML file and run it locally:\n';
                    errorMessage += '1. Right-click and "Save As" to download this page\n';
                    errorMessage += '2. Open the downloaded HTML file in your browser\n';
                    errorMessage += '3. Authentication will work properly from a local file\n\n';
                } else if (error.message && error.message.includes('AADSTS50011')) {
                    errorMessage += `Redirect URI mismatch!\n\nAdd this URI to your Entra ID app:\n${window.currentUrl}\n\n`;
                } else {
                    errorMessage += 'Error: ' + error.message + '\n\n';
                    errorMessage += 'Try downloading and running this HTML file locally for better compatibility.';
                }
                
                console.error('Authentication Error:', errorMessage);
                
                // Show error message appropriately based on environment
                if (window.isSandboxed) {
                    console.log('🚨 AUTHENTICATION FAILED (Sandbox mode - check console for details):');
                    console.log(errorMessage);
                } else {
                    try {
                        alert(errorMessage);
                    } catch (alertError) {
                        console.log('Alert blocked. Error details:', errorMessage);
                    }
                }
                
                // Offer manual token input as fallback
                let shouldUseManualToken = false;
                
                if (window.isSandboxed) {
                    console.log('🔧 SANDBOX MODE: Manual token option available');
                    console.log('💡 To use manual token authentication:');
                    console.log('   1. Get token from: https://developer.microsoft.com/graph/graph-explorer');
                    console.log('   2. Run: window.setManualToken("your-token-here")');
                    shouldUseManualToken = false; // Don't prompt in sandbox, just provide instructions
                } else {
                    try {
                        shouldUseManualToken = confirm('Would you like to manually enter an access token instead?\n\n(Advanced users only - you can get a token from https://developer.microsoft.com/en-us/graph/graph-explorer)');
                    } catch (confirmError) {
                        console.log('Manual token option available - check console for instructions');
                        console.log('To use manual token: run window.setManualToken("your-token-here")');
                        shouldUseManualToken = false;
                    }
                }
                
                // Create manual token function regardless of environment
                window.setManualToken = function(token) {
                    if (token && token.trim()) {
                        accessToken = token.trim();
                        authStatus.textContent = 'Connected with manual token';
                        authStatus.className = 'auth-status connected';
                        loginBtn.style.display = 'none';
                        userInfo.style.display = 'block';
                        userEmail.textContent = 'Manual token provided';
                        clientIdInput.disabled = true;
                        updateUploadButtonState();
                        console.log('✅ Manual token accepted');
                        return true;
                    } else {
                        console.error('❌ Invalid token provided');
                        return false;
                    }
                };
                
                if (shouldUseManualToken) {
                    let token = null;
                    try {
                        token = prompt('Enter your Graph API access token:');
                    } catch (promptError) {
                        console.log('Prompt blocked. Use window.setManualToken("your-token") instead');
                    }
                    
                    if (token && token.trim()) {
                        window.setManualToken(token.trim());
                    }
                }
            }
        });

        function handleAuthentication(response) {
            accessToken = response.accessToken;
            authStatus.textContent = 'Connected to Microsoft Graph';
            authStatus.className = 'auth-status connected';
            loginBtn.style.display = 'none';
            userInfo.style.display = 'block';
            userEmail.textContent = response.account.username;
            clientIdInput.disabled = true;
            
            // Log token details for debugging
            console.log('Authentication successful');
            console.log('Account:', response.account.username);
            console.log('Scopes granted:', response.scopes);
            console.log('Token expires:', new Date(response.expiresOn));
            
            updateUploadButtonState();
            
            // Test the connection
            testGraphConnection();
        }
        
        // Test Graph API connection
        async function testGraphConnection() {
            console.log('Testing Graph API connection...');
            try {
                const response = await fetch('https://graph.microsoft.com/v1.0/me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Graph API test successful:', data.displayName);
                } else {
                    console.error('Graph API test failed:', response.status, await response.text());
                }
            } catch (error) {
                console.error('Graph API connection error:', error);
            }
        }

        // File handling
        workflowFiles.addEventListener('change', (event) => {
            const files = event.target.files;
            if (files.length > 0) {
                loadWorkflowFiles(files);
            }
        });

        // Add click handler to the file button to trigger the hidden file input
        document.querySelector('.file-input-wrapper button').addEventListener('click', () => {
            workflowFiles.click();
        });

        async function loadWorkflowFiles(files) {
            workflowData = {};
            selectedWorkflows = [];
            console.log('Loading workflow files:', files.length);

            let successCount = 0;
            let errorCount = 0;

            for (const file of files) {
                try {
                    const content = await readFileAsText(file);
                    const jsonData = JSON.parse(content);
                    
                    // Validate the workflow has required fields
                    if (!jsonData.name && !jsonData.displayName) {
                        console.error(`File ${file.name} missing name/displayName field`);
                        errorCount++;
                        continue;
                    }
                    
                    const workflowName = jsonData.name || jsonData.displayName || file.name.replace('.json', '');
                    workflowData[workflowName] = jsonData;
                    successCount++;
                    console.log('Loaded workflow:', workflowName);
                } catch (error) {
                    console.error(`Error loading ${file.name}:`, error);
                    errorCount++;
                    console.log(`❌ Failed to load ${file.name}: ${error.message}`);
                    
                    if (window.isSandboxed) {
                        console.log(`🚨 SANDBOX MODE: File loading error - ${file.name}`);
                        console.log('Make sure it\'s a valid JSON file');
                    } else {
                        try {
                            alert(`Error loading ${file.name}: ${error.message}\n\nMake sure it's a valid JSON file.`);
                        } catch (alertError) {
                            console.log('Alert blocked - File loading error logged to console');
                        }
                    }
                }
            }

            console.log(`Loaded ${successCount} workflows successfully, ${errorCount} failed`);
            
            if (successCount > 0) {
                displayWorkflows();
                workflowListContainer.style.display = 'block';
                uploadOptionsCard.style.display = 'block';
            } else {
                console.log('❌ No valid workflow files were loaded');
                
                if (window.isSandboxed) {
                    console.log('🚨 SANDBOX MODE: No valid workflow files loaded');
                    console.log('Please check your JSON files and try again');
                } else {
                    try {
                        alert('No valid workflow files were loaded. Please check your JSON files.');
                    } catch (alertError) {
                        console.log('Alert blocked - No valid workflow files loaded (check console)');
                    }
                }
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // Helper function to create safe IDs
        function sanitizeId(str) {
            return str.replace(/[^a-zA-Z0-9-_]/g, '-');
        }

        function displayWorkflows() {
            workflowList.innerHTML = '';
            const workflowNames = Object.keys(workflowData).sort();

            workflowNames.forEach(name => {
                const safeId = sanitizeId(name);
                const item = document.createElement('div');
                item.className = 'workflow-item';
                item.innerHTML = `
                    <input type="checkbox" id="workflow-${safeId}" value="${name}">
                    <label for="workflow-${safeId}" style="cursor: pointer; flex: 1;">${name}</label>
                `;

                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedWorkflows.push(name);
                        item.classList.add('selected');
                    } else {
                        selectedWorkflows = selectedWorkflows.filter(w => w !== name);
                        item.classList.remove('selected');
                    }
                    updateSelectedCount();
                    updateUploadButtonState();
                });

                item.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });

                workflowList.appendChild(item);
            });
            
            // Update button state after displaying workflows
            updateUploadButtonState();
        }

        // Select/Deselect all functionality
        document.getElementById('selectAllBtn').addEventListener('click', () => {
            const checkboxes = workflowList.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (!cb.checked) {
                    cb.checked = true;
                    cb.dispatchEvent(new Event('change'));
                }
            });
        });

        document.getElementById('deselectAllBtn').addEventListener('click', () => {
            const checkboxes = workflowList.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    cb.checked = false;
                    cb.dispatchEvent(new Event('change'));
                }
            });
        });

        function updateSelectedCount() {
            selectedCount.textContent = selectedWorkflows.length;
            console.log('Selected workflows:', selectedWorkflows);
        }

        function updateUploadButtonState() {
            const btn = document.getElementById('uploadBtn');
            const statusText = document.getElementById('uploadBtnStatus');
            const shouldBeEnabled = accessToken && selectedWorkflows.length > 0;
            
            if (btn) {
                btn.disabled = !shouldBeEnabled;
                
                // Update status text
                if (!accessToken) {
                    statusText.textContent = 'Please sign in first';
                    statusText.style.color = '#dc3545';
                } else if (selectedWorkflows.length === 0) {
                    statusText.textContent = 'Please select workflows to upload';
                    statusText.style.color = '#856404';
                } else {
                    statusText.textContent = `Ready to upload ${selectedWorkflows.length} workflow(s)`;
                    statusText.style.color = '#28a745';
                }
                
                console.log('Upload button state updated:', {
                    accessToken: !!accessToken,
                    selectedWorkflows: selectedWorkflows.length,
                    buttonEnabled: shouldBeEnabled,
                    actualDisabledState: btn.disabled
                });
            } else {
                console.error('Upload button not found when trying to update state!');
            }
        }

        // Assignment target handling
        document.querySelectorAll('input[name="assignmentTarget"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                groupNameContainer.style.display = e.target.value === 'group' ? 'block' : 'none';
                validatedGroupId = null;
                groupValidationResult.innerHTML = '';
            });
        });

        // Group validation
        validateGroupBtn.addEventListener('click', async () => {
            const groupName = document.getElementById('groupName').value.trim();
            if (!groupName) {
                groupValidationResult.innerHTML = '<span style="color: red;">Please enter a group name</span>';
                return;
            }

            try {
                groupValidationResult.innerHTML = '<span style="color: blue;">Validating group...</span>';
                
                const response = await fetch('https://graph.microsoft.com/v1.0/groups', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();
                const group = data.value.find(g => g.displayName === groupName && g.securityEnabled);

                if (group) {
                    validatedGroupId = group.id;
                    groupValidationResult.innerHTML = `<span style="color: green;">✓ Found security group: ${group.displayName}</span>`;
                } else {
                    validatedGroupId = null;
                    groupValidationResult.innerHTML = '<span style="color: red;">✗ Group not found or is not a security group</span>';
                }
            } catch (error) {
                console.error('Group validation error:', error);
                groupValidationResult.innerHTML = '<span style="color: red;">✗ Error validating group</span>';
            }
        });

        // Helper function to reset upload button
        function resetUploadButton() {
            const btn = document.getElementById('uploadBtn');
            if (btn) {
                btn.innerHTML = `
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                    </svg>
                    Upload Selected Workflows
                `;
                btn.style.background = '#28a745';
            }
        }

        // Upload functionality - simplified and robust for sandboxed environments
        function setupUploadButton() {
            const uploadBtn = document.getElementById('uploadBtn');
            if (!uploadBtn) {
                console.error('Upload button not found!');
                return;
            }
            
            console.log('Setting up upload button...');
            
            // Remove any existing handlers and inline attributes
            uploadBtn.removeAttribute('onclick');
            const newBtn = uploadBtn.cloneNode(true);
            uploadBtn.parentNode.replaceChild(newBtn, uploadBtn);
            
            // Add comprehensive click handling
            newBtn.addEventListener('click', function(e) {
                console.log('=== UPLOAD BUTTON CLICKED ===');
                e.preventDefault();
                e.stopPropagation();
                handleUploadButtonClick();
            }, { capture: true });
            
            // Also add mousedown for immediate feedback
            newBtn.addEventListener('mousedown', function(e) {
                console.log('Upload button mousedown detected');
                const originalBg = this.style.background;
                this.style.background = '#17a2b8';
                setTimeout(() => {
                    this.style.background = originalBg;
                }, 150);
            });
            
            console.log('Upload button setup complete');
            return newBtn;
        }
        
        async function handleUploadButtonClick() {
            uploadClickCount++;
            console.log(`=== UPLOAD BUTTON CLICKED (click #${uploadClickCount}) ===`);
            
            const btn = document.getElementById('uploadBtn');
            if (!btn) {
                console.error('Upload button not found');
                alert('Error: Upload button not found. Please refresh the page.');
                return;
            }
            
            console.log('Current state check:', {
                accessToken: !!accessToken,
                selectedWorkflows: selectedWorkflows.length,
                buttonDisabled: btn.disabled,
                clickCount: uploadClickCount
            });
            
            // Add immediate visual feedback
            const originalBg = btn.style.background;
            btn.style.background = '#17a2b8';
            setTimeout(() => {
                btn.style.background = originalBg;
            }, 100);
            
            try {
                // Visual feedback
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<span style="display: inline-block; margin-right: 10px;">Processing...</span>';
                btn.style.background = '#ffc107';
                btn.disabled = true;
                
                console.log('Starting validation checks...');
                
                // Validation
                const assignmentTarget = document.querySelector('input[name="assignmentTarget"]:checked')?.value || 'none';
                console.log('Assignment target:', assignmentTarget);
                
                if (!accessToken) {
                    console.log('❌ No access token - user needs to sign in');
                    console.log('SOLUTION: Sign in with Microsoft or use window.setManualToken("your-token")');
                    
                    if (window.isSandboxed) {
                        console.log('🚨 SANDBOX MODE: Please sign in or use manual token');
                        console.log('💡 For manual token: window.setManualToken("your-token")');
                    } else {
                        try {
                            alert('Please sign in with Microsoft first, or use the manual token option if authentication popup is blocked.');
                        } catch (e) {
                            console.log('Alert blocked - check console message above');
                        }
                    }
                    btn.innerHTML = originalContent;
                    btn.style.background = '#28a745';
                    updateUploadButtonState();
                    return;
                }
                
                if (selectedWorkflows.length === 0) {
                    console.log('❌ No workflows selected');
                    
                    if (window.isSandboxed) {
                        console.log('🚨 SANDBOX MODE: Please select at least one workflow to upload');
                    } else {
                        try {
                            alert('Please select at least one workflow to upload');
                        } catch (e) {
                            console.log('Alert blocked - Please select at least one workflow to upload');
                        }
                    }
                    btn.innerHTML = originalContent;
                    btn.style.background = '#28a745';
                    updateUploadButtonState();
                    return;
                }
                
                if (assignmentTarget === 'group' && !validatedGroupId) {
                    console.log('❌ Group target selected but not validated');
                    
                    if (window.isSandboxed) {
                        console.log('🚨 SANDBOX MODE: Please validate the group name first');
                    } else {
                        try {
                            alert('Please validate the group name first');
                        } catch (e) {
                            console.log('Alert blocked - Please validate the group name first');
                        }
                    }
                    btn.innerHTML = originalContent;
                    btn.style.background = '#28a745';
                    updateUploadButtonState();
                    return;
                }
                
                const confirmMessage = `Upload ${selectedWorkflows.length} workflow(s) to Intune?`;
                console.log('Confirmation required:', confirmMessage);
                
                let shouldProceed = true;
                
                if (window.isSandboxed) {
                    // In sandboxed environments, skip confirmation and proceed automatically
                    console.log('🚀 SANDBOXED ENVIRONMENT: Skipping confirmation dialog');
                    console.log('📋 Would have asked:', confirmMessage);
                    console.log('✅ Proceeding automatically with upload...');
                    shouldProceed = true;
                } else {
                    // In normal environments, show confirmation dialog
                    try {
                        shouldProceed = confirm(confirmMessage);
                        console.log('User confirmation result:', shouldProceed);
                    } catch (e) {
                        console.log('Confirm dialog failed - proceeding automatically');
                        console.log('Would have asked:', confirmMessage);
                        shouldProceed = true;
                    }
                }
                
                if (!shouldProceed) {
                    console.log('Upload cancelled by user');
                    btn.innerHTML = originalContent;
                    btn.style.background = '#28a745';
                    updateUploadButtonState();
                    return;
                }
                
                console.log('All validations passed - starting upload process...');
                await uploadWorkflows();
                
                console.log('Upload process completed');
                btn.innerHTML = originalContent;
                btn.style.background = '#28a745';
                updateUploadButtonState();
                
            } catch (error) {
                console.error('Error in upload process:', error);
                console.log('❌ Upload failed:', error.message);
                
                if (window.isSandboxed) {
                    console.log('🚨 SANDBOX MODE: Upload failed - check console for details');
                    console.log('Error details:', error.message);
                } else {
                    try {
                        alert('Upload failed: ' + error.message);
                    } catch (e) {
                        console.log('Alert blocked - Upload failed (see console for details)');
                    }
                }
                btn.innerHTML = originalContent;
                btn.style.background = '#28a745';
                updateUploadButtonState();
            }
        }
        
        // Make it globally accessible for debugging
        window.handleUploadButtonClick = handleUploadButtonClick;

        // Make upload function globally available as a backup
        window.uploadWorkflows = uploadWorkflows;
        window.handleUploadClick = async function() {
            console.log('Upload triggered via global function');
            await handleUploadButtonClick();
        };

        // Initial upload button setup
        const initialUploadBtn = setupUploadButton();
        if (initialUploadBtn) {
            console.log('Upload button setup completed');
        } else {
            console.error('Upload button setup failed!');
        }
        
        // Setup copy button functionality
        const copyBtnElement = document.querySelector('.copy-btn');
        if (copyBtnElement) {
            copyBtnElement.addEventListener('click', function(e) {
                e.preventDefault();
                copyRedirectUri(e);
            });
            console.log('Copy button handler attached');
        } else {
            console.error('Copy button not found');
        }

        async function uploadWorkflows() {
            console.log('=== uploadWorkflows function started ===');
            
            const progressSection = document.getElementById('progressSection');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');
            const progressDetails = document.getElementById('progressDetails');
            const resultsTableBody = document.getElementById('resultsTableBody');
            
            try {
                // Show progress section
                progressSection.style.display = 'block';
                progressFill.style.width = '0%';
                progressPercent.textContent = '0%';
                progressText.textContent = 'Starting upload...';
                progressDetails.innerHTML = '';
                
                const results = [];
                const prefix = document.getElementById('workflowPrefix').value || '';
                const assignmentTarget = document.querySelector('input[name="assignmentTarget"]:checked')?.value || 'none';
                
                console.log('Upload configuration:', {
                    prefix: prefix,
                    assignmentTarget: assignmentTarget,
                    workflowCount: selectedWorkflows.length,
                    token: accessToken ? accessToken.substring(0, 20) + '...' : 'none'
                });

                // Process each workflow
                for (let i = 0; i < selectedWorkflows.length; i++) {
                    const workflowName = selectedWorkflows[i];
                    const progress = Math.round(((i + 1) / selectedWorkflows.length) * 100);
                    
                    // Update progress bar
                    progressFill.style.width = `${progress}%`;
                    progressPercent.textContent = `${progress}%`;
                    progressText.textContent = `Uploading ${i + 1} of ${selectedWorkflows.length}: ${workflowName}`;
                    progressDetails.innerHTML = `<strong>Current:</strong> ${workflowName}<br><strong>Status:</strong> Uploading to Intune...`;
                    
                    console.log(`Processing workflow ${i + 1}/${selectedWorkflows.length}: ${workflowName}`);

                    try {
                        const workflowJson = { ...workflowData[workflowName] };
                        
                        // Clean up the workflow object
                        delete workflowJson.id;
                        delete workflowJson.createdDateTime;
                        delete workflowJson.lastModifiedDateTime;
                        delete workflowJson.version;
                        delete workflowJson.supportsScopeTags;
                        delete workflowJson.roleScopeTagIds;
                        
                        // Apply prefix if specified
                        if (prefix) {
                            workflowJson.name = `${prefix}${workflowJson.name}`;
                            workflowJson.displayName = `${prefix}${workflowJson.displayName || workflowJson.name}`;
                        }
                        
                        // Ensure required fields
                        workflowJson['@odata.type'] = '#microsoft.graph.deviceManagementConfigurationPolicy';
                        workflowJson.platforms = workflowJson.platforms || 'windows10';
                        workflowJson.technologies = workflowJson.technologies || 'mdm';

                        console.log(`Uploading to Graph API: ${workflowJson.name}`);
                        
                        // Upload to Intune
                        const createResponse = await fetch('https://graph.microsoft.com/beta/deviceManagement/configurationPolicies', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(workflowJson)
                        });

                        const responseText = await createResponse.text();
                        console.log(`Response status: ${createResponse.status}`);
                        
                        if (!createResponse.ok) {
                            let errorMessage = `HTTP ${createResponse.status}`;
                            try {
                                const errorJson = JSON.parse(responseText);
                                errorMessage = errorJson.error?.message || errorJson.message || responseText;
                                console.error('API Error:', errorJson);
                                
                                // Check for specific error codes
                                if (errorJson.error?.code === 'Unauthorized' || createResponse.status === 401) {
                                    errorMessage = 'Unauthorized - Token may have expired. Please sign in again.';
                                } else if (errorJson.error?.code === 'Forbidden' || createResponse.status === 403) {
                                    errorMessage = 'Forbidden - Missing required permissions. Ensure admin consent is granted.';
                                }
                            } catch {
                                errorMessage = responseText || `HTTP ${createResponse.status}`;
                            }
                            throw new Error(errorMessage);
                        }

                        const createdPolicy = JSON.parse(responseText);
                        console.log(`Successfully created policy with ID: ${createdPolicy.id}`);

                        // Handle assignments if needed
                        if (assignmentTarget !== 'none' && createdPolicy.id) {
                            try {
                                progressDetails.innerHTML += '<br><strong>Status:</strong> Assigning policy...';
                                await assignPolicy(createdPolicy.id, assignmentTarget);
                                console.log(`Policy assigned to ${assignmentTarget}`);
                            } catch (assignError) {
                                console.error('Assignment error:', assignError);
                                // Don't fail the whole upload if assignment fails
                            }
                        }

                        results.push({
                            name: workflowJson.name,
                            status: 'Success',
                            details: 'Uploaded successfully' + (assignmentTarget !== 'none' ? ' and assigned' : '')
                        });

                    } catch (error) {
                        console.error(`Error uploading ${workflowName}:`, error);
                        results.push({
                            name: prefix ? `${prefix}${workflowName}` : workflowName,
                            status: 'Error',
                            details: error.message || 'Unknown error'
                        });
                    }
                    
                    // Small delay to avoid rate limiting
                    if (i < selectedWorkflows.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }

                // Show results
                displayResults(results);
                
                // Update progress bar to show completion
                progressFill.style.width = '100%';
                progressPercent.textContent = '100%';
                
                // Show summary
                const successCount = results.filter(r => r.status === 'Success').length;
                const errorCount = results.filter(r => r.status === 'Error').length;
                
                if (successCount > 0 && errorCount === 0) {
                    progressText.textContent = `✅ All ${successCount} workflow(s) uploaded successfully!`;
                    progressFill.style.background = 'linear-gradient(90deg, #28a745 0%, #20c997 100%)';
                    progressDetails.innerHTML = `<strong style="color: #28a745;">Upload completed successfully!</strong>`;
                } else if (successCount > 0 && errorCount > 0) {
                    progressText.textContent = `⚠️ ${successCount} succeeded, ${errorCount} failed`;
                    progressFill.style.background = 'linear-gradient(90deg, #ffc107 0%, #fd7e14 100%)';
                    progressDetails.innerHTML = `<strong style="color: #856404;">Partial success - check results below</strong>`;
                } else {
                    progressText.textContent = `❌ All uploads failed`;
                    progressFill.style.background = 'linear-gradient(90deg, #dc3545 0%, #c82333 100%)';
                    progressDetails.innerHTML = `<strong style="color: #dc3545;">Upload failed - check error details below</strong>`;
                }
                
                // Hide progress section after delay
                setTimeout(() => {
                    progressSection.style.display = 'none';
                    progressFill.style.width = '0%';
                    progressPercent.textContent = '';
                }, 5000);
                
                console.log('Upload process completed');
                console.log('Results:', results);
                
            } catch (error) {
                console.error('Critical error in uploadWorkflows:', error);
                progressText.textContent = `❌ Upload failed: ${error.message}`;
                progressFill.style.background = 'linear-gradient(90deg, #dc3545 0%, #c82333 100%)';
                progressDetails.innerHTML = `<strong style="color: #dc3545;">Error:</strong> ${error.message}`;
                
                setTimeout(() => {
                    progressSection.style.display = 'none';
                }, 5000);
            }
        }

        async function assignPolicy(policyId, target) {
            try {
                const assignments = [];

                if (target === 'allUsers') {
                    assignments.push({
                        target: {
                            '@odata.type': '#microsoft.graph.allLicensedUsersAssignmentTarget'
                        }
                    });
                } else if (target === 'allDevices') {
                    assignments.push({
                        target: {
                            '@odata.type': '#microsoft.graph.allDevicesAssignmentTarget'
                        }
                    });
                } else if (target === 'group' && validatedGroupId) {
                    assignments.push({
                        target: {
                            '@odata.type': '#microsoft.graph.groupAssignmentTarget',
                            deviceAndAppManagementAssignmentFilterId: null,
                            deviceAndAppManagementAssignmentFilterType: 'none',
                            groupId: validatedGroupId
                        }
                    });
                }

                const assignmentBody = { assignments };

                const response = await fetch(`https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/${policyId}/assign`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(assignmentBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Assignment failed: ${response.status} - ${errorText}`);
                }
                
                console.log(`Policy ${policyId} assigned to ${target}`);
            } catch (error) {
                console.error('Error in assignPolicy:', error);
                throw error;
            }
        }

        function displayResults(results) {
            resultsSection.style.display = 'block';
            resultsTableBody.innerHTML = '';

            results.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.name}</td>
                    <td class="status-${result.status.toLowerCase()}">${result.status}</td>
                    <td>${result.details}</td>
                `;
                resultsTableBody.appendChild(row);
            });

            // Store results for CSV download
            window.uploadResults = results;
        }

        // Download results as CSV
        document.getElementById('downloadResultsBtn').addEventListener('click', () => {
            if (!window.uploadResults) return;

            const csv = [
                ['Workflow Name', 'Status', 'Details'],
                ...window.uploadResults.map(r => [r.name, r.status, r.details])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `UploadResults-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // Check for existing session on page load
        async function checkExistingSession() {
            if (!msalInstance) return;
            
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                try {
                    const response = await msalInstance.acquireTokenSilent({
                        scopes: [
                            'User.Read',
                            'DeviceManagementConfiguration.ReadWrite.All',
                            'Organization.Read.All',
                            'Group.Read.All'
                        ],
                        account: accounts[0]
                    });
                    handleAuthentication(response);
                } catch (error) {
                    console.log('Silent token acquisition failed:', error);
                }
            }
        }

        // Safe localStorage access
        function safeLocalStorage() {
            try {
                // Test if localStorage is accessible
                const test = '__localStorage_test__';
                window.localStorage.setItem(test, test);
                window.localStorage.removeItem(test);
                return true;
            } catch (e) {
                console.log('localStorage not available in this environment');
                return false;
            }
        }

        // Load Client ID from localStorage if available
        if (safeLocalStorage()) {
            const savedClientId = localStorage.getItem('cisUploaderClientId');
            if (savedClientId) {
                clientIdInput.value = savedClientId;
                clientIdInput.dispatchEvent(new Event('input'));
            }
        }

        // Save Client ID to localStorage when it changes (if available)
        clientIdInput.addEventListener('change', () => {
            const clientId = clientIdInput.value.trim();
            if (clientId && safeLocalStorage()) {
                try {
                    localStorage.setItem('cisUploaderClientId', clientId);
                } catch (e) {
                    console.log('Could not save Client ID to localStorage');
                }
            }
        });

        // Initialization logging
        console.log('CIS Workflows Uploader initialized');
        
        // Ensure redirect URI is displayed
        console.log('Current redirect URI:', window.currentUrl);
        
        const uploadBtnTest = document.getElementById('uploadBtn');
        console.log('Upload button found:', !!uploadBtnTest);
        console.log('Environment: Sandboxed =', !safeLocalStorage());
        console.log('All DOM elements loaded successfully');
        
        // Add warning if common issues detected
        if (!uploadBtnTest) {
            console.error('ERROR: Upload button not found! Check HTML structure.');
        } else {
            // Test that we can interact with the button
            console.log('Upload button test:', {
                id: uploadBtnTest.id,
                disabled: uploadBtnTest.disabled,
                innerHTML: uploadBtnTest.innerHTML.substring(0, 50) + '...'
            });
        }
        
        if (!safeLocalStorage()) {
            console.warn('Running in sandboxed environment - localStorage disabled. Client ID will not be saved between sessions.');
        }
        
        // Test upload button is clickable
        setTimeout(() => {
            const testBtn = document.getElementById('uploadBtn');
            if (testBtn) {
                console.log('Upload button final check:', {
                    found: true,
                    disabled: testBtn.disabled,
                    hasOnclick: !!testBtn.onclick,
                    eventListeners: testBtn._events
                });
                
                // Add a direct test handler
                testBtn.addEventListener('click', function() {
                    console.log('Test handler: Upload button was clicked!');
                    // Flash button blue briefly
                    const origBg = this.style.background;
                    this.style.background = '#0066cc';
                    setTimeout(() => {
                        this.style.background = origBg;
                    }, 200);
                }, { once: true });
            }
        }, 1000);
        
        // Debug helper - expose for testing
        window.debugUpload = function() {
            console.log('=== Upload Debug Info ===');
            console.log('Access Token:', !!accessToken);
            console.log('Selected Workflows:', selectedWorkflows);
            console.log('Upload Button:', {
                found: !!document.getElementById('uploadBtn'),
                disabled: document.getElementById('uploadBtn')?.disabled,
                onclick: !!document.getElementById('uploadBtn')?.onclick
            });
            console.log('To test upload manually, run: window.handleUploadClick()');
            
            // Test button click
            const btn = document.getElementById('uploadBtn');
            if (btn) {
                console.log('Button test - attempting click...');
                btn.click();
            }
        };
        
        // Force enable upload for testing
        window.forceEnableUpload = function() {
            const btn = document.getElementById('uploadBtn');
            if (btn) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
                console.log('Upload button force enabled');
                
                // Add test workflows if none selected
                if (selectedWorkflows.length === 0 && Object.keys(workflowData).length > 0) {
                    selectedWorkflows = Object.keys(workflowData).slice(0, 1);
                    console.log('Added test workflow:', selectedWorkflows);
                }
                
                // Add test token if none exists
                if (!accessToken) {
                    accessToken = 'test-token-for-debugging';
                    console.log('Added test token for debugging');
                }
                
                updateUploadButtonState();
            }
        };
        
        // Test Graph API function
        window.testGraphAPI = async function() {
            if (!accessToken) {
                console.log('No access token available');
                return;
            }
            
            console.log('Testing Graph API connection...');
            try {
                const response = await fetch('https://graph.microsoft.com/v1.0/me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Graph API test successful:', data.displayName);
                } else {
                    console.error('Graph API test failed:', response.status, await response.text());
                }
            } catch (error) {
                console.error('Graph API connection error:', error);
            }
        };
        
        // Show current redirect URI function
        window.showRedirectUri = function() {
            console.log('Current Redirect URI:', window.currentUrl);
            
            const uriElement = document.getElementById('currentRedirectUri');
            if (uriElement) {
                uriElement.textContent = window.currentUrl;
                uriElement.style.display = 'block';
                console.log('✅ Redirect URI element updated');
                
                // Make sure the parent alert is visible
                const redirectAlert = document.getElementById('redirectUriAlert');
                if (redirectAlert) {
                    redirectAlert.style.display = 'block';
                    console.log('✅ Redirect URI alert made visible');
                }
            } else {
                console.error('❌ Redirect URI element not found!');
            }
            
            if (window.isSandboxed) {
                console.log('🔧 SANDBOX MODE: Redirect URI updated in yellow box above');
                console.log('📋 Copy this URI to your Entra ID app registration:', window.currentUrl);
            } else {
                try {
                    alert('Current Redirect URI:\n\n' + window.currentUrl + '\n\nThis has been updated in the redirect URI box and logged to console.');
                } catch (alertError) {
                    console.log('✅ Current Redirect URI updated in the yellow box above');
                    console.log('ℹ️  Copy this URI to your Entra ID app registration');
                }
            }
            return window.currentUrl;
        };
        
        // Force display redirect URI immediately
        if (window.showRedirectUri) {
            window.showRedirectUri();
        }
        
        // Direct upload test function
        window.testUpload = async function() {
            console.log('Test upload initiated');
            
            if (!accessToken) {
                console.log('No access token - using test token');
                accessToken = 'test-token';
            }
            
            if (selectedWorkflows.length === 0) {
                console.log('No workflows selected - using test data');
                if (Object.keys(workflowData).length > 0) {
                    selectedWorkflows = Object.keys(workflowData).slice(0, 1);
                } else {
                    console.log('No workflow data available');
                    return;
                }
            }
            
            console.log('Starting test upload...');
            await uploadWorkflows();
        };
        
        console.log('Debug helpers available:');
        console.log('🔧 SANDBOXED ENVIRONMENT HELPERS:');
        console.log('- window.fixDisplay() - Fix all display issues');
        console.log('- window.setManualToken("token") - Set access token manually');
        console.log('- window.forceUpload() - Upload without confirmations');
        console.log('- window.debugUploadSandbox() - Comprehensive sandbox debug');
        console.log('');
        console.log('📋 STANDARD HELPERS:');
        console.log('- window.showRedirectUri() - Display current redirect URI');
        console.log('- window.debugUpload() - Check upload state and test button');
        console.log('- window.forceEnableUpload() - Force enable button for testing');
        console.log('- window.handleUploadClick() - Manually trigger upload');
        console.log('- window.testUpload() - Direct upload test with test data');
        console.log('- window.testGraphAPI() - Test API connection');
        
        // Fix display function
        window.fixDisplay = function() {
            console.log('🔧 Fixing display issues...');
            
            // Fix redirect URI
            const uriElement = document.getElementById('currentRedirectUri');
            if (uriElement) {
                uriElement.textContent = window.currentUrl;
                uriElement.style.display = 'block';
                console.log('✅ Fixed redirect URI display:', window.currentUrl);
            }
            
            // Fix redirect URI alert visibility
            const redirectAlert = document.getElementById('redirectUriAlert');
            if (redirectAlert) {
                redirectAlert.style.display = 'block';
                console.log('✅ Made redirect URI alert visible');
            }
            
            // Fix how-to section
            const howToToggle = document.getElementById('howToToggle');
            const howToContent = document.getElementById('howToContent');
            if (howToToggle && howToContent) {
                // Remove existing listeners and add new ones
                howToToggle.replaceWith(howToToggle.cloneNode(true));
                const newToggle = document.getElementById('howToToggle');
                
                newToggle.addEventListener('click', () => {
                    console.log('How-to toggle clicked (fixed)');
                    newToggle.classList.toggle('active');
                    howToContent.classList.toggle('active');
                });
                console.log('✅ Fixed how-to section functionality');
            }
            
            console.log('🎉 All display issues fixed!');
        };
        
        // Manual token setting function (for sandboxed environments)
        window.setManualToken = function(token) {
            if (!token || !token.trim()) {
                console.error('❌ Please provide a valid access token');
                console.log('Usage: window.setManualToken("your-access-token-here")');
                console.log('Get a token from: https://developer.microsoft.com/en-us/graph/graph-explorer');
                return false;
            }
            
            accessToken = token.trim();
            authStatus.textContent = 'Connected with manual token';
            authStatus.className = 'auth-status connected';
            loginBtn.style.display = 'none';
            userInfo.style.display = 'block';
            userEmail.textContent = 'Manual token provided';
            clientIdInput.disabled = true;
            updateUploadButtonState();
            console.log('✅ Manual token accepted and applied');
            console.log('ℹ️  You can now upload workflows');
            return true;
        };
        
        // Enhanced debug upload for sandboxed environment
        window.debugUploadSandbox = function() {
            console.log('=== Sandbox Upload Debug Info ===');
            console.log('Access Token:', !!accessToken);
            console.log('Selected Workflows:', selectedWorkflows.length);
            console.log('Workflow Data Available:', Object.keys(workflowData).length);
            
            const btn = document.getElementById('uploadBtn');
            console.log('Upload Button:', {
                found: !!btn,
                disabled: btn?.disabled,
                text: btn?.textContent?.substring(0, 30) + '...'
            });
            
            console.log('Environment Restrictions:');
            console.log('- Clipboard API: BLOCKED');
            console.log('- Modal dialogs: BLOCKED');
            console.log('- Authentication popups: BLOCKED');
            
            console.log('Available workarounds:');
            console.log('- window.setManualToken("token") - Set access token manually');
            console.log('- window.forceUpload() - Skip confirmations and upload');
            console.log('- window.fixDisplay() - Fix display issues');
            
            return {
                hasToken: !!accessToken,
                workflowsSelected: selectedWorkflows.length,
                workflowsAvailable: Object.keys(workflowData).length,
                buttonWorking: !!btn && !btn.disabled
            };
        };
        
        // Force upload without confirmations (for sandboxed environments)
        window.forceUpload = async function() {
            console.log('🚀 Force upload initiated (bypassing sandbox restrictions)');
            
            if (!accessToken) {
                console.error('❌ No access token. Use window.setManualToken("your-token") first');
                return false;
            }
            
            if (selectedWorkflows.length === 0) {
                console.error('❌ No workflows selected. Load workflow files first.');
                return false;
            }
            
            console.log(`📋 Uploading ${selectedWorkflows.length} workflows without confirmation...`);
            
            try {
                await uploadWorkflows();
                console.log('✅ Force upload completed');
                return true;
            } catch (error) {
                console.error('❌ Force upload failed:', error);
                return false;
            }
        };
        
        // Final verification check with delay
        setTimeout(() => {
            const finalUriElement = document.getElementById('currentRedirectUri');
            
            if (finalUriElement) {
                if (!finalUriElement.textContent.trim()) {
                    finalUriElement.textContent = window.currentUrl;
                    console.log('🔧 Fixed empty redirect URI display');
                }
                console.log('✅ Final redirect URI verified:', finalUriElement.textContent);
            } else {
                console.error('❌ Redirect URI element still not found!');
            }
            
            // Final how-to section check
            const howToToggle = document.getElementById('howToToggle');
            const howToContent = document.getElementById('howToContent');
            if (howToToggle && howToContent) {
                console.log('✅ How-to section elements found');
            } else {
                console.error('❌ How-to section elements missing');
            }
        }, 3000);
        
        console.log('All initialization complete');
        console.log('='.repeat(60));
        console.log('🚀 CIS Workflows Uploader v2025 Ready!');
        console.log('Platform: Works on Windows, macOS, and Linux');
        console.log('');
        
        if (window.isSandboxed) {
            console.log('🔒 SANDBOXED ENVIRONMENT DETECTED!');
            console.log('✅ Automatically adapted for sandbox restrictions');
            console.log('✅ Upload confirmations: DISABLED (auto-proceed)');
            console.log('✅ Error messages: Console-only mode');
            console.log('✅ All functionality: Available with sandbox workarounds');
        } else {
            console.log('🌐 NORMAL ENVIRONMENT DETECTED');
            console.log('✅ All features available including modal dialogs');
        }
        
        console.log('');
        console.log('🛠️  QUICK START:');
        console.log('1. window.fixDisplay() - Fix any display issues');
        console.log('2. Enter Client ID or get token from Graph Explorer');
        console.log('3. window.setManualToken("your-token") - For sandbox auth');
        console.log('4. Load workflow JSON files using the file button');
        console.log('5. Click "Upload Selected Workflows" - no confirmation needed!');
        console.log('');
        console.log('🔍 TROUBLESHOOTING:');
        console.log('- No redirect URI: window.showRedirectUri()');
        console.log('- Display issues: window.fixDisplay()');
        console.log('- Upload debug: window.debugUploadSandbox()');
        console.log('- Set manual token: window.setManualToken("token")');
        console.log('- Force upload: window.forceUpload()');
        
        if (!window.isSandboxed) {
            console.log('');
            console.log('💡 For sandboxed environments (Google Sites, Colab):');
            console.log('   Download this HTML file and run it locally for best experience');
        }
        
        console.log('='.repeat(60));
        
        // Auto-run display fixes and show current status
        setTimeout(() => {
            if (window.fixDisplay) {
                window.fixDisplay();
            }
            
            console.log('');
            console.log('🔧 Auto-fixes applied. Current status:');
            console.log(`📍 Environment: ${window.isSandboxed ? 'SANDBOXED' : 'NORMAL'}`);
            console.log(`🔗 Redirect URI: ${window.currentUrl}`);
            
            if (window.debugUploadSandbox) {
                const status = window.debugUploadSandbox();
                if (window.isSandboxed) {
                    console.log('');
                    console.log('🎯 SANDBOX MODE: Upload button will work without confirmations!');
                    console.log('📋 Just click "Upload Selected Workflows" when ready');
                } else {
                    console.log('✅ Ready to use! All features available.');
                }
            }
        }, 1000);
        
            } catch (error) {
                console.error('Critical error during initialization:', error);
                alert('Error initializing the application. Please check the browser console for details.');
            }
        
        }); // End of DOMContentLoaded
    </script>
</body>
</html>