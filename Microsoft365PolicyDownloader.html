<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microsoft 365 Policy Downloader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .header {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .header-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .header-title h1 {
            font-size: 1.875rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            color: #4b5563;
        }

        .icon {
            width: 1.5rem;
            height: 1.5rem;
            display: inline-block;
            vertical-align: middle;
        }

        .status-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-dot.connected {
            background: #28a745;
        }

        .nav-tabs {
            display: flex;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
            position: relative;
        }

        .nav-tab:hover {
            background-color: #f3f4f6;
        }

        .nav-tab.active {
            color: #2563eb;
            background-color: #eff6ff;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #2563eb;
        }

        .tab-content {
            display: none;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auth-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-status {
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .auth-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .auth-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: #2a5298;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3c72;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn svg {
            pointer-events: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn.loading {
            color: transparent;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .collapsible {
            cursor: pointer;
            padding: 10px;
            background: #2a5298;
            color: white;
            border: none;
            border-radius: 5px;
            width: 100%;
            text-align: left;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible:hover {
            background: #1e3c72;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.active {
            max-height: 3000px;
            transition: max-height 0.5s ease-in;
        }

        .collapsible::after {
            content: '\25BC';
            font-size: 12px;
            transition: transform 0.3s;
        }

        .collapsible.active::after {
            transform: rotate(180deg);
        }

        .policy-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .policy-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .policy-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .policy-card.selected {
            background: #eff6ff;
            border-color: #2563eb;
        }

        .policy-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .policy-header input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .policy-name {
            font-weight: 600;
            color: #1f2937;
            flex: 1;
        }

        .policy-type {
            background: #e0e7ff;
            color: #3730a3;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .policy-details {
            font-size: 0.875rem;
            color: #6b7280;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-left: 30px;
        }

        .policy-meta {
            display: flex;
            gap: 20px;
            margin-top: 8px;
            font-size: 13px;
            color: #6b7280;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-controls input[type="text"] {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-text {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            color: #333;
            z-index: 1;
        }

        .policy-count {
            background: #e0e7ff;
            color: #3730a3;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 8px;
        }

        .service-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 4px;
        }

        .service-intune { background: #e3f2fd; color: #1565c0; }
        .service-exchange { background: #e8f5e9; color: #2e7d32; }
        .service-sharepoint { background: #fff3e0; color: #ef6c00; }
        .service-teams { background: #f3e5f5; color: #6a1b9a; }
        .service-aad { background: #fce4ec; color: #c2185b; }
        .service-compliance { background: #e0f2f1; color: #00695c; }

        .export-options {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 10px;
            color: #4b5563;
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem 0.5rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .filter-controls {
                flex-direction: column;
            }
            
            .filter-controls input[type="text"] {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Accessibility improvements */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles */
        *:focus-visible {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }

        .redirect-uri-box {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .redirect-uri-box h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .redirect-uri-display {
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.9em;
        }

        .copy-btn {
            padding: 5px 15px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .copy-btn:hover {
            background: #138496;
        }

        .how-to-section {
            background: #f0f8ff;
            border: 2px solid #2a5298;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .how-to-section h3 {
            color: #2a5298;
            margin-bottom: 15px;
        }

        .how-to-section h4 {
            color: #1e3c72;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .how-to-section ol {
            margin-left: 20px;
        }

        .how-to-section li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .how-to-section code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="connectionStatus">Disconnected</span>
            </div>
            <div class="header-title">
                <h1>
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Microsoft 365 Policy Downloader
                </h1>
            </div>
            <p>Export and backup policies from all Microsoft 365 admin portals with assignment details</p>
        </div>

        <div class="nav-tabs" role="tablist">
            <button class="nav-tab active" role="tab" aria-selected="true" onclick="switchTab('overview')">Overview</button>
            <button class="nav-tab" role="tab" aria-selected="false" onclick="switchTab('intune')">Intune</button>
            <button class="nav-tab" role="tab" aria-selected="false" onclick="switchTab('exchange')">Exchange</button>
            <button class="nav-tab" role="tab" aria-selected="false" onclick="switchTab('sharepoint')">SharePoint</button>
            <button class="nav-tab" role="tab" aria-selected="false" onclick="switchTab('teams')">Teams</button>
            <button class="nav-tab" role="tab" aria-selected="false" onclick="switchTab('aad')">Azure AD</button>
            <button class="nav-tab" role="tab" aria-selected="false" onclick="switchTab('compliance')">Compliance</button>
            <button class="nav-tab" role="tab" aria-selected="false" onclick="switchTab('export')">Export</button>
        </div>

        <!-- Dynamic Redirect URI Alert -->
        <div class="alert alert-danger" id="redirectUriAlert" style="margin: 0 0 20px 0;">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
            <div>
                <strong>Important - Dynamic Redirect URI Detected!</strong>
                <div class="redirect-uri-box">
                    <h4>Your current redirect URI is:</h4>
                    <div class="redirect-uri-display" id="currentRedirectUri">Loading...</div>
                    <script>
                        // Immediately populate redirect URI
                        (function() {
                            const url = window.location.href.split('#')[0].split('?')[0];
                            const el = document.getElementById('currentRedirectUri');
                            if (el) el.textContent = url;
                        })();
                    </script>
                    <button class="copy-btn" onclick="window.copyRedirectUri ? window.copyRedirectUri() : alert('Function not loaded yet, please try again')">Copy to Clipboard</button>
                    <p style="margin-top: 10px;">
                        <strong>You must add this exact URI to your Entra ID app registration before signing in!</strong><br>
                        This URI changes each time you load the page in an embedded environment.
                    </p>
                </div>
            </div>
        </div>

        <!-- How to Get Client ID Section -->
        <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 0; margin-bottom: 20px;">
            <button class="collapsible" id="howToToggle" aria-expanded="false" aria-controls="howToContent">
                <span>How to Get Your Entra ID Client ID</span>
            </button>
            <div class="collapsible-content" id="howToContent">
                <div class="how-to-section">
                    <h3>Step-by-Step Guide to Register Your Application</h3>
                    
                    <div class="alert alert-warning">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                        </svg>
                        <strong>Dynamic Environment Warning:</strong> If you're running this in Google Colab, JSFiddle, or similar platforms, the redirect URI changes each time. You'll need to update it in Entra ID before each use.
                    </div>
                    
                    <h4>Step 1: Register an Application in Entra ID</h4>
                    <ol>
                        <li>Go to the <a href="https://entra.microsoft.com" target="_blank">Microsoft Entra Portal</a></li>
                        <li>Navigate to <strong>Applications</strong> ‚Üí <strong>App registrations</strong></li>
                        <li>Click <strong>New registration</strong></li>
                        <li>Configure the application:
                            <ul style="margin-top: 5px;">
                                <li><strong>Name:</strong> M365 Policy Downloader (or any name you prefer)</li>
                                <li><strong>Supported account types:</strong> Choose based on your needs:
                                    <ul>
                                        <li>"Accounts in this organizational directory only" (single tenant)</li>
                                        <li>"Accounts in any organizational directory" (multi-tenant)</li>
                                    </ul>
                                </li>
                                <li><strong>Redirect URI:</strong>
                                    <ul>
                                        <li>Platform: <code>Single-page application (SPA)</code></li>
                                        <li>URI: <strong style="color: red;">Copy the URI shown above in the yellow box</strong></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li>Click <strong>Register</strong></li>
                    </ol>

                    <h4>Step 2: Configure API Permissions</h4>
                    <ol>
                        <li>In your app registration, go to <strong>API permissions</strong></li>
                        <li>Click <strong>Add a permission</strong></li>
                        <li>Select <strong>Microsoft Graph</strong></li>
                        <li>Choose <strong>Delegated permissions</strong></li>
                        <li>Search for and add these permissions:
                            <ul style="margin-top: 5px;">
                                <li><code>DeviceManagementConfiguration.Read.All</code> - Read Intune policies</li>
                                <li><code>Policy.Read.All</code> - Read Azure AD and conditional access policies</li>
                                <li><code>Directory.Read.All</code> - Read directory data</li>
                                <li><code>Group.Read.All</code> - Read group information for assignments</li>
                                <li><code>Sites.Read.All</code> - Read SharePoint settings</li>
                                <li><code>User.Read</code> - Sign in and read user profile</li>
                            </ul>
                        </li>
                        <li>Click <strong>Add permissions</strong></li>
                        <li><strong style="color: red;">Important:</strong> Click <strong>Grant admin consent for [Your Organization]</strong></li>
                        <li>Ensure all permissions show a green checkmark under "Status"</li>
                    </ol>

                    <h4>Step 3: Get Your Client ID</h4>
                    <ol>
                        <li>Go to the <strong>Overview</strong> page of your app registration</li>
                        <li>Copy the <strong>Application (client) ID</strong> (it looks like: <code>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</code>)</li>
                        <li>Paste it in the Client ID field below</li>
                    </ol>

                    <h4>Troubleshooting Common Issues:</h4>
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 15px; margin: 15px 0;">
                        <ul style="margin-left: 20px;">
                            <li><strong>Button not responding:</strong> Check browser console (F12) for errors</li>
                            <li><strong>403 Forbidden:</strong> Admin consent not granted - have an admin grant consent in Entra ID</li>
                            <li><strong>401 Unauthorized:</strong> Token expired - sign out and sign in again</li>
                            <li><strong>AADSTS50011:</strong> Redirect URI mismatch - ensure the URI matches exactly</li>
                            <li><strong>Platform doesn't matter:</strong> Works on Windows, macOS, and Linux</li>
                        </ul>
                    </div>

                    <h4>Alternative: Use a Static Hosting Service</h4>
                    <p>To avoid changing the redirect URI each time, consider hosting this HTML file on:</p>
                    <ul style="margin-left: 20px;">
                        <li>GitHub Pages (free)</li>
                        <li>Netlify (free tier available)</li>
                        <li>Microsoft Azure Static Web Apps (free tier available)</li>
                        <li>Your own web server</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Overview Tab -->
        <div class="tab-content active" id="overviewTab" role="tabpanel">
            <div class="alert alert-warning" id="sandboxWarning" style="display: none;">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                </svg>
                <div>
                    <strong>‚ö†Ô∏è Sandboxed Environment Detected!</strong>
                    <p>You're running this in a restricted environment. Some features may not work:</p>
                    <ul style="margin-top: 5px;">
                        <li><strong>Authentication popups may be blocked</strong> - Use manual token input option if needed</li>
                        <li><strong>Clipboard API is blocked</strong> - You'll need to manually copy the redirect URI</li>
                        <li><strong>Best solution:</strong> Download this HTML file and run it locally for full functionality</li>
                    </ul>
                    <p style="margin-top: 10px;">
                        <strong>To download:</strong> Right-click on this page ‚Üí "Save As" ‚Üí Save as HTML file ‚Üí Open locally
                    </p>
                </div>
            </div>
            
            <div class="auth-section">
                <h3>Authentication</h3>
                <div class="form-group">
                    <label for="clientId">Entra ID Client ID:</label>
                    <input type="text" id="clientId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" 
                           pattern="[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}">
                    <small style="display: block; margin-top: 5px; color: #666;">Enter your Entra ID application Client ID</small>
                </div>
                <div id="authStatus" class="auth-status disconnected" role="status">
                    <span>Not connected to Microsoft Graph</span>
                </div>
                <button id="loginBtn" class="btn btn-primary" disabled aria-label="Sign in with Microsoft">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    Sign in with Microsoft
                </button>
                <button id="signOutBtn" class="btn btn-danger" style="display: none;">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                        <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                    </svg>
                    Sign Out
                </button>
                <button id="fetchAllBtn" class="btn btn-success" disabled>
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3 3a.5.5 0 0 0 .708-.708L8.5 11.707V5.5a.5.5 0 0 0-1 0v6.207l-1.646-1.646a.5.5 0 0 0-.708.708z"/>
                    </svg>
                    Fetch All Policies
                </button>
                <div id="userInfo" style="display: none;">
                    <strong>Signed in as:</strong> <span id="userEmail"></span>
                </div>
            </div>

            <div class="alert alert-info">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                </svg>
                <div>
                    <strong>Note:</strong> This tool requires Microsoft Graph API permissions:
                    <ul style="margin-top: 5px; margin-left: 20px;">
                        <li>DeviceManagementConfiguration.Read.All - To read Intune configuration policies</li>
                        <li>Policy.Read.All - To read Azure AD and conditional access policies</li>
                        <li>Directory.Read.All - To read directory information</li>
                        <li>Group.Read.All - To read group names for policy assignments</li>
                        <li>Sites.Read.All - To read SharePoint policies</li>
                        <li>User.Read - To sign in and read user profile</li>
                    </ul>
                    <small>Platform: Works on Windows, macOS, and Linux in any modern browser</small>
                </div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalPolicies">0</div>
                    <div class="stat-label">Total Policies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="selectedPolicies">0</div>
                    <div class="stat-label">Selected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="servicesQueried">0</div>
                    <div class="stat-label">Services Queried</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="lastFetch">Never</div>
                    <div class="stat-label">Last Fetch</div>
                </div>
            </div>

            <div id="overviewProgress" style="display: none;">
                <h3>Fetching Policies...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="overviewProgressFill"></div>
                    <div class="progress-text" id="overviewProgressText">0%</div>
                </div>
                <p id="currentService" style="text-align: center; color: #666;">Initializing...</p>
            </div>
            
            <div id="fetchSummary" style="display: none;">
                <!-- Fetch summary will be inserted here -->
            </div>
        </div>

        <!-- Intune Tab -->
        <div class="tab-content" id="intuneTab" role="tabpanel">
            <h3>Intune Policies <span class="policy-count" id="intuneCount">0</span></h3>
            
            <div class="filter-controls">
                <input type="text" id="intuneSearch" placeholder="Search Intune policies...">
                <button class="btn btn-secondary" onclick="selectAllIntune()">Select All</button>
                <button class="btn btn-secondary" onclick="deselectAllIntune()">Deselect All</button>
                <button class="btn btn-primary" onclick="refreshIntune()">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                    </svg>
                    Refresh
                </button>
            </div>

            <div id="intunePolicies" class="policy-grid">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3>No Policies Loaded</h3>
                    <p>Sign in and click "Fetch All Policies" to load Intune policies</p>
                </div>
            </div>
        </div>

        <!-- Exchange Tab -->
        <div class="tab-content" id="exchangeTab" role="tabpanel">
            <h3>Exchange Policies <span class="policy-count" id="exchangeCount">0</span></h3>
            
            <div class="filter-controls">
                <input type="text" id="exchangeSearch" placeholder="Search Exchange policies...">
                <button class="btn btn-secondary" onclick="selectAllExchange()">Select All</button>
                <button class="btn btn-secondary" onclick="deselectAllExchange()">Deselect All</button>
                <button class="btn btn-primary" onclick="refreshExchange()">Refresh</button>
            </div>

            <div id="exchangePolicies" class="policy-grid">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3>No Policies Loaded</h3>
                    <p>Sign in and click "Fetch All Policies" to load Exchange policies</p>
                </div>
            </div>
        </div>

        <!-- SharePoint Tab -->
        <div class="tab-content" id="sharepointTab" role="tabpanel">
            <h3>SharePoint Policies <span class="policy-count" id="sharepointCount">0</span></h3>
            
            <div class="filter-controls">
                <input type="text" id="sharepointSearch" placeholder="Search SharePoint policies...">
                <button class="btn btn-secondary" onclick="selectAllSharePoint()">Select All</button>
                <button class="btn btn-secondary" onclick="deselectAllSharePoint()">Deselect All</button>
                <button class="btn btn-primary" onclick="refreshSharePoint()">Refresh</button>
            </div>

            <div id="sharepointPolicies" class="policy-grid">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3>No Policies Loaded</h3>
                    <p>Sign in and click "Fetch All Policies" to load SharePoint policies</p>
                </div>
            </div>
        </div>

        <!-- Teams Tab -->
        <div class="tab-content" id="teamsTab" role="tabpanel">
            <h3>Teams Policies <span class="policy-count" id="teamsCount">0</span></h3>
            
            <div class="filter-controls">
                <input type="text" id="teamsSearch" placeholder="Search Teams policies...">
                <button class="btn btn-secondary" onclick="selectAllTeams()">Select All</button>
                <button class="btn btn-secondary" onclick="deselectAllTeams()">Deselect All</button>
                <button class="btn btn-primary" onclick="refreshTeams()">Refresh</button>
            </div>

            <div id="teamsPolicies" class="policy-grid">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3>No Policies Loaded</h3>
                    <p>Sign in and click "Fetch All Policies" to load Teams policies</p>
                </div>
            </div>
        </div>

        <!-- Azure AD Tab -->
        <div class="tab-content" id="aadTab" role="tabpanel">
            <h3>Azure AD Policies <span class="policy-count" id="aadCount">0</span></h3>
            
            <div class="filter-controls">
                <input type="text" id="aadSearch" placeholder="Search Azure AD policies...">
                <button class="btn btn-secondary" onclick="selectAllAAD()">Select All</button>
                <button class="btn btn-secondary" onclick="deselectAllAAD()">Deselect All</button>
                <button class="btn btn-primary" onclick="refreshAAD()">Refresh</button>
            </div>

            <div id="aadPolicies" class="policy-grid">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3>No Policies Loaded</h3>
                    <p>Sign in and click "Fetch All Policies" to load Azure AD policies</p>
                </div>
            </div>
        </div>

        <!-- Compliance Tab -->
        <div class="tab-content" id="complianceTab" role="tabpanel">
            <h3>Compliance Policies <span class="policy-count" id="complianceCount">0</span></h3>
            
            <div class="filter-controls">
                <input type="text" id="complianceSearch" placeholder="Search Compliance policies...">
                <button class="btn btn-secondary" onclick="selectAllCompliance()">Select All</button>
                <button class="btn btn-secondary" onclick="deselectAllCompliance()">Deselect All</button>
                <button class="btn btn-primary" onclick="refreshCompliance()">Refresh</button>
            </div>

            <div id="compliancePolicies" class="policy-grid">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3>No Policies Loaded</h3>
                    <p>Sign in and click "Fetch All Policies" to load Compliance policies</p>
                </div>
            </div>
        </div>

        <!-- Export Tab -->
        <div class="tab-content" id="exportTab" role="tabpanel">
            <h3>Export Options</h3>
            
            <div class="export-options">
                <h4>Export Format</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="radio" name="exportFormat" id="formatCSV" value="csv" checked>
                        <label for="formatCSV">CSV (Summary)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="radio" name="exportFormat" id="formatJSON" value="json">
                        <label for="formatJSON">JSON (Full Details)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="radio" name="exportFormat" id="formatBoth" value="both">
                        <label for="formatBoth">Both CSV & JSON</label>
                    </div>
                </div>

                <h4 style="margin-top: 20px;">Include in Export</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeMetadata" checked>
                        <label for="includeMetadata">Policy Metadata</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeSettings" checked>
                        <label for="includeSettings">Policy Settings</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeAssignments" checked>
                        <label for="includeAssignments">Assignments</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeTimestamps" checked>
                        <label for="includeTimestamps">Created/Modified Dates</label>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="exportSelected()" id="exportBtn">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3 3a.5.5 0 0 0 .708-.708L8.5 11.707V5.5a.5.5 0 0 0-1 0v6.207l-1.646-1.646a.5.5 0 0 0-.708.708z"/>
                        </svg>
                        Export Selected Policies
                    </button>
                    <button class="btn btn-primary" onclick="exportAll()">
                        Export All Policies
                    </button>
                    <button class="btn btn-secondary" onclick="downloadIndividual()">
                        Download Individual Policy JSONs
                    </button>
                </div>

                <div id="exportProgress" style="display: none; margin-top: 20px;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="exportProgressFill"></div>
                        <div class="progress-text" id="exportProgressText">0%</div>
                    </div>
                    <p id="exportStatus" style="text-align: center; color: #666;">Preparing export...</p>
                </div>
            </div>

            <div class="alert alert-warning" style="margin-top: 20px;">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                </svg>
                <div>
                    <strong>Export Notes:</strong>
                    <ul style="margin-top: 5px; margin-left: 20px;">
                        <li>CSV format includes policy summaries and key settings</li>
                        <li>JSON format includes complete policy configurations</li>
                        <li>Individual downloads create separate JSON files for each policy</li>
                        <li>Large exports may take several minutes to complete</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Include MSAL library -->
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    
    <script>
// Secure Password Protection with SHA-256 Hashing
(function() {
    // Check if user has already authenticated in this session
    const isAuthenticated = sessionStorage.getItem('intunePolicyManagerAuth');
    
    if (!isAuthenticated) {
        authenticateUser();
    }
})();

async function authenticateUser() {
    const PASSWORD_HASH = '9e5c3ce7906db8e6f333df0e10deed2263b0a8738a9abe3f3612b8f52846689e';
    
    const maxAttempts = 3;
    let attempts = 0;
    let authorized = false;
    
    while (attempts < maxAttempts && !authorized) {
        const password = prompt(
            `üîí Intune Policy Manager - Secure Access\n\n` +
            `Enter password (${maxAttempts - attempts} attempt${attempts === 2 ? '' : 's'} remaining):`
        );
        
        // User clicked cancel
        if (password === null) {
            showAccessDenied('Authentication cancelled');
            throw new Error('Access cancelled by user');
        }
        
        // Hash the entered password and compare
        const enteredHash = await hashPassword(password);
        
        if (enteredHash === PASSWORD_HASH) {
            authorized = true;
            sessionStorage.setItem('intunePolicyManagerAuth', 'true');
            
            // Add session timeout (2 hours)
            sessionStorage.setItem('authExpiry', Date.now() + (2 * 60 * 60 * 1000));
        } else {
            attempts++;
            if (attempts < maxAttempts) {
                alert(`‚ùå Incorrect password.\n\n${maxAttempts - attempts} attempt${attempts === 2 ? '' : 's'} remaining.`);
            }
        }
    }
    
    if (!authorized) {
        showAccessDenied('Maximum password attempts exceeded');
        throw new Error('Unauthorized - Maximum attempts exceeded');
    }
}

// SHA-256 hashing function
async function hashPassword(password) {
    const msgUint8 = new TextEncoder().encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex;
}

function showAccessDenied(message) {
    document.body.innerHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Access Denied</title>
        </head>
        <body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
            <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);">
                <div style="text-align: center; background: white; padding: 60px 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 450px; margin: 20px;">
                    <h1 style="color: #1a1a1a; margin-bottom: 25px; font-size: 36px; font-weight: 700; font-style: italic;">No HAM for you...</h1>
                    
                    <div style="margin: 30px 0;">
                        <img src="https://luiserodz.github.io/theHAM/Ham.jpg" 
                             alt="No Ham for You" 
                             style="max-width: 300px; width: 100%; height: auto; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);">
                    </div>
                    
                    <p style="color: #666; margin-bottom: 10px; font-size: 18px; line-height: 1.5;">${message}</p>
                    
                    <div style="margin-top: 35px; padding-top: 25px; border-top: 1px solid #eee;">
                        <p style="color: #999; font-size: 15px;">Please contact your system administrator for access credentials.</p>
                        <p style="color: #bbb; font-size: 13px; margin-top: 15px;">Intune Policy Manager</p>
                    </div>
                </div>
            </div>
        </body>
        </html>
    `;
}

// Check session expiry on each load
(function checkSessionExpiry() {
    const authExpiry = sessionStorage.getItem('authExpiry');
    if (authExpiry && Date.now() > parseInt(authExpiry)) {
        sessionStorage.removeItem('intunePolicyManagerAuth');
        sessionStorage.removeItem('authExpiry');
        location.reload();
    }
})();

// Auto-logout on inactivity (30 minutes)
let inactivityTimer;
const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutes

function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
        sessionStorage.removeItem('intunePolicyManagerAuth');
        sessionStorage.removeItem('authExpiry');
        alert('‚è±Ô∏è Session expired due to inactivity.\n\nPlease refresh the page to log in again.');
        location.reload();
    }, INACTIVITY_TIMEOUT);
}

// Start inactivity timer if authenticated
if (sessionStorage.getItem('intunePolicyManagerAuth')) {
    document.addEventListener('click', resetInactivityTimer);
    document.addEventListener('keypress', resetInactivityTimer);
    document.addEventListener('scroll', resetInactivityTimer);
    document.addEventListener('mousemove', resetInactivityTimer);
    resetInactivityTimer();
}
        console.log('M365 Policy Downloader initializing...');
        
        // Immediately set redirect URI on page load
        window.currentUrl = window.location.href.split('#')[0].split('?')[0];
        
        // Try to set redirect URI immediately if DOM is ready
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            const el = document.getElementById('currentRedirectUri');
            if (el) el.textContent = window.currentUrl;
        }
        
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Initializing M365 Policy Downloader');
            
            // Detect and display current redirect URI
            const currentUrl = window.currentUrl;
            
            const redirectUriElement = document.getElementById('currentRedirectUri');
            if (redirectUriElement) {
                redirectUriElement.textContent = currentUrl;
                console.log('Redirect URI set to:', currentUrl);
            } else {
                console.error('Redirect URI element not found!');
            }

            // Force display redirect URI (backup method)
            setTimeout(() => {
                const uriEl = document.getElementById('currentRedirectUri');
                if (uriEl) {
                    uriEl.textContent = window.currentUrl;
                }
            }, 500);

            // Check if we're in a dynamic environment
            const isDynamicEnvironment = currentUrl.includes('googleusercontent.com') || 
                                         currentUrl.includes('jsfiddle.net') || 
                                         currentUrl.includes('codepen.io') ||
                                         currentUrl.includes('stackblitz.com') ||
                                         currentUrl.includes('codesandbox.io') ||
                                         currentUrl.includes('colab') ||
                                         currentUrl.includes('localhost') ||
                                         currentUrl.includes('127.0.0.1') ||
                                         currentUrl.includes('file://');

            // Detect sandboxed environment (where modals are blocked)
            const isSandboxed = currentUrl.includes('googleusercontent.com') ||
                               currentUrl.includes('google.com') ||
                               currentUrl.includes('googlesites.com') ||
                               currentUrl.includes('sites.google.com') ||
                               currentUrl.includes('colab') ||
                               currentUrl.includes('jsfiddle') ||
                               currentUrl.includes('codepen') ||
                               currentUrl.includes('stackblitz') ||
                               currentUrl.includes('codesandbox') ||
                               document.querySelector('iframe') !== null; // Basic iframe detection

            window.isSandboxed = isSandboxed;

            // Force display the redirect URI alert initially
            const redirectAlert = document.getElementById('redirectUriAlert');
            if (redirectAlert) {
                redirectAlert.style.display = 'block';
            }

            // Only hide redirect URI alert if we're very sure it's not needed
            // (i.e., it's a production domain or local file that's not from file://)
            const isDefinitelyStatic = (
                currentUrl.includes('.com') || 
                currentUrl.includes('.org') || 
                currentUrl.includes('.net')
            ) && !isDynamicEnvironment;
            
            if (isDefinitelyStatic) {
                setTimeout(() => {
                    if (redirectAlert) {
                        redirectAlert.style.display = 'none';
                    }
                }, 2000);
            }

            // Show sandboxed warning if in sandboxed environment
            if (isSandboxed) {
                const sandboxWarning = document.getElementById('sandboxWarning');
                if (sandboxWarning) {
                    sandboxWarning.style.display = 'block';
                }
            }

            // Always ensure redirect URI is displayed
            setTimeout(() => {
                if (redirectUriElement && !redirectUriElement.textContent.trim()) {
                    redirectUriElement.textContent = currentUrl;
                }
            }, 100);

            // Setup collapsible how-to section
            const howToToggle = document.getElementById('howToToggle');
            const howToContent = document.getElementById('howToContent');

            if (howToToggle && howToContent) {
                howToToggle.addEventListener('click', () => {
                    howToToggle.classList.toggle('active');
                    howToContent.style.display = howToContent.style.display === 'block' ? 'none' : 'block';
                });

                // Auto-expand for dynamic environments
                if (isDynamicEnvironment) {
                    howToToggle.classList.add('active');
                    howToContent.style.display = 'block';
                }
            }

        // Global variables
        let msalInstance = null;
        let accessToken = null;
        let allPolicies = {
            intune: [],
            exchange: [],
            sharepoint: [],
            teams: [],
            aad: [],
            compliance: []
        };
        let selectedPolicies = new Set();

        // Copy redirect URI function
        window.copyRedirectUri = function() {
            const redirectUri = document.getElementById('currentRedirectUri').textContent;
            const btn = event.target;
            
            if (!window.isSandboxed && navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(redirectUri).then(() => {
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    btn.style.background = '#28a745';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                }).catch(() => {
                    fallbackCopyToClipboard(redirectUri, btn);
                });
            } else {
                fallbackCopyToClipboard(redirectUri, btn);
            }
        };

        // Fallback copy method for sandboxed environments
        function fallbackCopyToClipboard(text, btn) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    btn.style.background = '#28a745';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                alert('Copy failed. Please manually copy the redirect URI:\n\n' + text);
            }
            
            document.body.removeChild(textArea);
        }

        // Tab switching
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        };

        // Initialize MSAL
        document.getElementById('clientId').addEventListener('input', (e) => {
            const clientId = e.target.value.trim();
            const guidPattern = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;
            
            if (guidPattern.test(clientId)) {
                document.getElementById('loginBtn').disabled = false;
                
                const msalConfig = {
                    auth: {
                        clientId: clientId,
                        authority: 'https://login.microsoftonline.com/common',
                        redirectUri: window.currentUrl
                    },
                    cache: {
                        cacheLocation: 'sessionStorage',
                        storeAuthStateInCookie: true
                    }
                };
                
                try {
                    msalInstance = new msal.PublicClientApplication(msalConfig);
                    console.log('MSAL instance created successfully');
                    
                    // Check for existing session
                    checkExistingSession();
                } catch (error) {
                    console.error('Error creating MSAL instance:', error);
                    if (!window.isSandboxed) {
                        alert('Error initializing authentication. Please check your Client ID.');
                    }
                }
            } else {
                document.getElementById('loginBtn').disabled = true;
            }
        });

        // Authentication
        document.getElementById('loginBtn').addEventListener('click', async () => {
            if (!msalInstance) {
                alert('Please enter a valid Client ID first');
                return;
            }

            try {
                const loginRequest = {
                    scopes: [
                        'DeviceManagementConfiguration.Read.All',
                        'Policy.Read.All',
                        'Directory.Read.All',
                        'Group.Read.All',
                        'Sites.Read.All',
                        'User.Read'
                    ]
                };

                const loginResponse = await msalInstance.loginPopup(loginRequest);
                handleAuthentication(loginResponse);
            } catch (error) {
                console.error('Login failed:', error);
                let errorMessage = 'Authentication failed.\n\n';
                
                if (error.message && error.message.includes('AADSTS50011')) {
                    errorMessage += `Redirect URI mismatch!\n\nAdd this URI to your Entra ID app:\n${window.currentUrl}\n\n`;
                } else {
                    errorMessage += 'Error: ' + error.message + '\n\n';
                }
                
                if (window.isSandboxed) {
                    errorMessage += 'Try downloading and running this HTML file locally for better compatibility.';
                }
                
                alert(errorMessage);
            }
        });

        // Sign out functionality
        document.getElementById('signOutBtn').addEventListener('click', async () => {
            if (!msalInstance) return;
            
            try {
                // Clear all policies and selections
                allPolicies = {
                    intune: [],
                    exchange: [],
                    sharepoint: [],
                    teams: [],
                    aad: [],
                    compliance: []
                };
                selectedPolicies.clear();
                
                // Reset all policy displays
                ['intune', 'exchange', 'sharepoint', 'teams', 'aad', 'compliance'].forEach(service => {
                    const container = document.getElementById(`${service}Policies`);
                    if (container) {
                        container.innerHTML = `<div class="alert alert-info">Sign in and click "Fetch All Policies" to load ${service.charAt(0).toUpperCase() + service.slice(1)} policies</div>`;
                    }
                    const count = document.getElementById(`${service}Count`);
                    if (count) {
                        count.textContent = '0';
                    }
                });
                
                // Reset stats
                updateStats();
                
                // Hide fetch summary
                const fetchSummary = document.getElementById('fetchSummary');
                if (fetchSummary) {
                    fetchSummary.style.display = 'none';
                }
                
                // Clear MSAL cache and sign out
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    await msalInstance.logoutPopup({
                        account: accounts[0]
                    });
                }
                
                // Reset UI
                accessToken = null;
                document.getElementById('authStatus').textContent = 'Not connected';
                document.getElementById('authStatus').className = 'status-indicator status-disconnected';
                document.getElementById('loginBtn').style.display = 'inline-flex';
                document.getElementById('signOutBtn').style.display = 'none';
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('userEmail').textContent = '';
                document.getElementById('fetchAllBtn').disabled = true;
                document.getElementById('clientId').disabled = false;
                
                console.log('Signed out successfully');
            } catch (error) {
                console.error('Sign out error:', error);
                // Even if sign out fails, reset the UI
                accessToken = null;
                document.getElementById('authStatus').textContent = 'Not connected';
                document.getElementById('authStatus').className = 'status-indicator status-disconnected';
                document.getElementById('loginBtn').style.display = 'inline-flex';
                document.getElementById('signOutBtn').style.display = 'none';
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('fetchAllBtn').disabled = true;
                document.getElementById('clientId').disabled = false;
            }
        });

        function handleAuthentication(response) {
            accessToken = response.accessToken;
            document.getElementById('authStatus').textContent = 'Connected';
            document.getElementById('authStatus').className = 'status-indicator status-connected';
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('signOutBtn').style.display = 'inline-flex';
            document.getElementById('userInfo').style.display = 'inline';
            document.getElementById('userEmail').textContent = response.account.username;
            document.getElementById('fetchAllBtn').disabled = false;
            document.getElementById('clientId').disabled = true;
            
            console.log('Authentication successful');
            console.log('Account:', response.account.username);
            console.log('Scopes granted:', response.scopes);
        }

        // Check for existing session
        async function checkExistingSession() {
            if (!msalInstance) return;
            
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                try {
                    const response = await msalInstance.acquireTokenSilent({
                        scopes: [
                            'DeviceManagementConfiguration.Read.All',
                            'Policy.Read.All',
                            'Directory.Read.All',
                            'Group.Read.All',
                            'Sites.Read.All',
                            'User.Read'
                        ],
                        account: accounts[0]
                    });
                    handleAuthentication(response);
                } catch (error) {
                    console.log('Silent token acquisition failed:', error);
                }
            }
        }

        // Fetch all policies
        document.getElementById('fetchAllBtn').addEventListener('click', async () => {
            const progress = document.getElementById('overviewProgress');
            const summaryDiv = document.getElementById('fetchSummary');
            
            // Hide previous summary and show progress
            summaryDiv.style.display = 'none';
            progress.style.display = 'block';
            
            const services = [
                { name: 'Intune', fn: fetchIntunePolicies },
                { name: 'Exchange', fn: fetchExchangePolicies },
                { name: 'SharePoint', fn: fetchSharePointPolicies },
                { name: 'Teams', fn: fetchTeamsPolicies },
                { name: 'Azure AD', fn: fetchAADPolicies },
                { name: 'Compliance', fn: fetchCompliancePolicies }
            ];

            let completed = 0;
            for (const service of services) {
                document.getElementById('currentService').textContent = `Fetching ${service.name} policies...`;
                
                try {
                    await service.fn();
                } catch (error) {
                    console.error(`Error fetching ${service.name} policies:`, error);
                }
                
                completed++;
                const progress = Math.round((completed / services.length) * 100);
                document.getElementById('overviewProgressFill').style.width = progress + '%';
                document.getElementById('overviewProgressText').textContent = progress + '%';
            }

            updateStats();
            document.getElementById('currentService').textContent = 'All policies fetched successfully!';
            
            // Show a summary of what was fetched
            const totalPolicies = Object.values(allPolicies).reduce((sum, policies) => sum + policies.length, 0);
            const summaryHtml = `
                <div class="alert alert-info">
                    <strong>‚úÖ Fetch Complete!</strong> Found <strong>${totalPolicies}</strong> total policies:
                    <ul style="margin-top: 10px;">
                        <li><strong>Intune:</strong> ${allPolicies.intune.length} policies with assignments</li>
                        <li><strong>Azure AD:</strong> ${allPolicies.aad.length} policies (Conditional Access, Auth Methods, etc.)</li>
                        <li><strong>SharePoint:</strong> ${allPolicies.sharepoint.length} tenant-level settings</li>
                        <li><strong>Exchange:</strong> ${allPolicies.exchange.length} policies ${allPolicies.exchange.length < 2 ? '(limited via Graph API)' : ''}</li>
                        <li><strong>Teams:</strong> ${allPolicies.teams.length} policies ${allPolicies.teams.length < 2 ? '(limited via Graph API)' : ''}</li>
                        <li><strong>Compliance:</strong> ${allPolicies.compliance.length} policies</li>
                    </ul>
                    <p style="margin-top: 10px;">
                        <strong>Note:</strong> For complete policy export, Exchange and Teams require their respective PowerShell modules.
                    </p>
                    <p style="margin-top: 10px;">
                        üí° <strong>Tip:</strong> Switch to each tab to view and select specific policies, or use the Export tab to download all/selected policies.
                    </p>
                </div>
            `;
            
            summaryDiv.innerHTML = summaryHtml;
            summaryDiv.style.display = 'block';
            
            setTimeout(() => {
                progress.style.display = 'none';
            }, 3000);
        });

        // Intune policies
        async function fetchIntunePolicies() {
            try {
                const endpoints = [
                    { path: '/deviceManagement/configurationPolicies', assignmentPath: '/assignments' },
                    { path: '/deviceManagement/deviceConfigurations', assignmentPath: '/assignments' },
                    { path: '/deviceManagement/groupPolicyConfigurations', assignmentPath: '/assignments' },
                    { path: '/deviceManagement/intents', assignmentPath: '/assignments' },
                    { path: '/deviceManagement/compliancePolicies', assignmentPath: '/assignments' }
                ];

                allPolicies.intune = [];
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(`https://graph.microsoft.com/beta${endpoint.path}`, {
                            headers: { 'Authorization': `Bearer ${accessToken}` }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const policies = data.value || [];
                            
                            console.log(`Fetched ${policies.length} policies from ${endpoint.path}`);
                            
                            for (const policy of policies) {
                                // Fetch assignments for each policy
                                let assignments = [];
                                try {
                                    const assignmentResponse = await fetch(`https://graph.microsoft.com/beta${endpoint.path}/${policy.id}${endpoint.assignmentPath}`, {
                                        headers: { 'Authorization': `Bearer ${accessToken}` }
                                    });
                                    
                                    if (assignmentResponse.ok) {
                                        const assignmentData = await assignmentResponse.json();
                                        assignments = assignmentData.value || [];
                                        console.log(`Found ${assignments.length} assignments for policy: ${policy.name || policy.displayName}`);
                                    }
                                } catch (assignError) {
                                    console.error(`Error fetching assignments for ${policy.id}:`, assignError);
                                }
                                
                                // Process assignments
                                const assignmentSummary = await processAssignments(assignments);
                                
                                allPolicies.intune.push({
                                    id: policy.id,
                                    name: policy.name || policy.displayName,
                                    type: endpoint.path.split('/').pop(),
                                    description: policy.description || '',
                                    created: policy.createdDateTime,
                                    modified: policy.lastModifiedDateTime,
                                    platform: policy.platforms,
                                    service: 'intune',
                                    assignments: assignmentSummary,
                                    raw: policy,
                                    rawAssignments: assignments
                                });
                            }
                        }
                    } catch (error) {
                        console.error(`Error fetching ${endpoint.path}:`, error);
                    }
                }

                displayIntunePolicies();
            } catch (error) {
                console.error('Error fetching Intune policies:', error);
            }
        }
        
        // Process assignments and get group names
        async function processAssignments(assignments) {
            const summary = {
                allUsers: false,
                allDevices: false,
                groups: [],
                exclusions: []
            };
            
            for (const assignment of assignments) {
                const target = assignment.target;
                
                if (target['@odata.type'] === '#microsoft.graph.allLicensedUsersAssignmentTarget') {
                    summary.allUsers = true;
                } else if (target['@odata.type'] === '#microsoft.graph.allDevicesAssignmentTarget') {
                    summary.allDevices = true;
                } else if (target['@odata.type'] === '#microsoft.graph.groupAssignmentTarget') {
                    try {
                        // Fetch group name
                        const groupResponse = await fetch(`https://graph.microsoft.com/v1.0/groups/${target.groupId}`, {
                            headers: { 'Authorization': `Bearer ${accessToken}` }
                        });
                        
                        if (groupResponse.ok) {
                            const group = await groupResponse.json();
                            summary.groups.push({
                                id: target.groupId,
                                name: group.displayName,
                                type: 'Include'
                            });
                        } else {
                            summary.groups.push({
                                id: target.groupId,
                                name: 'Unknown Group',
                                type: 'Include'
                            });
                        }
                    } catch (error) {
                        summary.groups.push({
                            id: target.groupId,
                            name: 'Unknown Group',
                            type: 'Include'
                        });
                    }
                } else if (target['@odata.type'] === '#microsoft.graph.exclusionGroupAssignmentTarget') {
                    try {
                        const groupResponse = await fetch(`https://graph.microsoft.com/v1.0/groups/${target.groupId}`, {
                            headers: { 'Authorization': `Bearer ${accessToken}` }
                        });
                        
                        if (groupResponse.ok) {
                            const group = await groupResponse.json();
                            summary.exclusions.push({
                                id: target.groupId,
                                name: group.displayName
                            });
                        }
                    } catch (error) {
                        summary.exclusions.push({
                            id: target.groupId,
                            name: 'Unknown Group'
                        });
                    }
                }
            }
            
            return summary;
        }

        function displayIntunePolicies() {
            const container = document.getElementById('intunePolicies');
            container.innerHTML = '';
            
            document.getElementById('intuneCount').textContent = allPolicies.intune.length;
            
            allPolicies.intune.forEach(policy => {
                const card = createPolicyCard(policy);
                container.appendChild(card);
            });
        }

        // Exchange policies - try to get what's available through Graph
        async function fetchExchangePolicies() {
            try {
                allPolicies.exchange = [];
                
                // Try to fetch mail flow rules (transport rules)
                try {
                    const transportRulesResponse = await fetch('https://graph.microsoft.com/beta/transportRules', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (transportRulesResponse.ok) {
                        const data = await transportRulesResponse.json();
                        const rules = data.value || [];
                        
                        rules.forEach(rule => {
                            allPolicies.exchange.push({
                                id: rule.id,
                                name: rule.displayName,
                                type: 'MailFlowRule',
                                description: rule.comments || 'Mail flow rule',
                                enabled: rule.state === 'Enabled',
                                priority: rule.priority,
                                service: 'exchange',
                                raw: rule
                            });
                        });
                    }
                } catch (error) {
                    console.error('Error fetching mail flow rules:', error);
                }
                
                // Try to fetch retention policies
                try {
                    const retentionResponse = await fetch('https://graph.microsoft.com/beta/security/retentionEvents', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (retentionResponse.ok) {
                        const data = await retentionResponse.json();
                        const policies = data.value || [];
                        
                        policies.forEach(policy => {
                            allPolicies.exchange.push({
                                id: policy.id,
                                name: policy.displayName || 'Retention Policy',
                                type: 'RetentionPolicy',
                                description: policy.description || 'Retention policy',
                                service: 'exchange',
                                raw: policy
                            });
                        });
                    }
                } catch (error) {
                    console.error('Error fetching retention policies:', error);
                }
                
                // Try to fetch organization configuration
                try {
                    const orgConfigResponse = await fetch('https://graph.microsoft.com/v1.0/organization', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (orgConfigResponse.ok) {
                        const data = await orgConfigResponse.json();
                        const org = data.value?.[0];
                        
                        if (org) {
                            allPolicies.exchange.push({
                                id: 'org-config',
                                name: 'Organization Configuration',
                                type: 'OrganizationConfig',
                                description: 'Organization-wide Exchange settings',
                                service: 'exchange',
                                raw: org
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error fetching org config:', error);
                }
                
                // Add a note about PowerShell if we couldn't get much
                if (allPolicies.exchange.length === 0) {
                    allPolicies.exchange.push({
                        id: 'ex-note-1',
                        name: 'Limited Exchange Access',
                        type: 'Note',
                        description: 'Most Exchange policies require Exchange Online PowerShell',
                        service: 'exchange',
                        note: 'To access all Exchange policies, use Exchange Online PowerShell with Get-* cmdlets like Get-MalwareFilterPolicy, Get-HostedContentFilterPolicy, Get-TransportRule, etc.'
                    });
                }
                
                displayExchangePolicies();
            } catch (error) {
                console.error('Error fetching Exchange policies:', error);
                displayExchangePolicies();
            }
        }

        function displayExchangePolicies() {
            const container = document.getElementById('exchangePolicies');
            container.innerHTML = '';
            
            if (allPolicies.exchange.length === 0 || (allPolicies.exchange.length === 1 && allPolicies.exchange[0].type === 'Note')) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Limited Exchange Access via Graph API</strong><br>
                        Most Exchange policies require Exchange Online PowerShell for complete access.<br><br>
                        <strong>To export Exchange policies:</strong>
                        <ol style="margin-top: 10px; margin-left: 20px;">
                            <li>Connect to Exchange Online PowerShell</li>
                            <li>Run commands like:
                                <ul>
                                    <li><code>Get-MalwareFilterPolicy</code></li>
                                    <li><code>Get-HostedContentFilterPolicy</code></li>
                                    <li><code>Get-TransportRule</code></li>
                                    <li><code>Get-RetentionPolicy</code></li>
                                    <li><code>Get-DlpCompliancePolicy</code></li>
                                </ul>
                            </li>
                        </ol>
                        <a href="https://docs.microsoft.com/en-us/powershell/exchange/connect-to-exchange-online-powershell" target="_blank">Exchange Online PowerShell Documentation</a>
                    </div>
                `;
            }
            
            document.getElementById('exchangeCount').textContent = allPolicies.exchange.length;
            
            allPolicies.exchange.forEach(policy => {
                const card = createPolicyCard(policy);
                container.appendChild(card);
            });
        }

        // SharePoint policies
        async function fetchSharePointPolicies() {
            try {
                allPolicies.sharepoint = [];
                
                // Fetch tenant settings
                try {
                    const response = await fetch('https://graph.microsoft.com/v1.0/admin/sharepoint/settings', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (response.ok) {
                        const settings = await response.json();
                        allPolicies.sharepoint.push({
                            id: 'sp-tenant-settings',
                            name: 'SharePoint Tenant Settings',
                            type: 'TenantSettings',
                            description: 'Organization-wide SharePoint settings',
                            service: 'sharepoint',
                            raw: settings
                        });
                    }
                } catch (error) {
                    console.error('Error fetching SharePoint settings:', error);
                }
                
                // Try to fetch sharing settings
                try {
                    const sharingResponse = await fetch('https://graph.microsoft.com/beta/admin/sharepoint/settings', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (sharingResponse.ok) {
                        const settings = await sharingResponse.json();
                        if (settings.sharingCapability) {
                            allPolicies.sharepoint.push({
                                id: 'sp-sharing-settings',
                                name: 'SharePoint Sharing Settings',
                                type: 'SharingSettings',
                                description: `Sharing capability: ${settings.sharingCapability}`,
                                service: 'sharepoint',
                                raw: settings
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error fetching sharing settings:', error);
                }
                
                // Try to fetch some sites to show site-level policies
                try {
                    const sitesResponse = await fetch('https://graph.microsoft.com/v1.0/sites?$top=5', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (sitesResponse.ok) {
                        const data = await sitesResponse.json();
                        const sites = data.value || [];
                        
                        // Just add a summary policy to indicate sites exist
                        if (sites.length > 0) {
                            allPolicies.sharepoint.push({
                                id: 'sp-sites-summary',
                                name: 'SharePoint Sites Summary',
                                type: 'SitesSummary',
                                description: `${sites.length}+ sites found. Use SharePoint PowerShell for detailed site policies`,
                                service: 'sharepoint',
                                note: 'Individual site policies require SharePoint PowerShell',
                                raw: { sitesFound: sites.length }
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error fetching sites:', error);
                }
                
                displaySharePointPolicies();
            } catch (error) {
                console.error('Error fetching SharePoint policies:', error);
                displaySharePointPolicies();
            }
        }

        function displaySharePointPolicies() {
            const container = document.getElementById('sharepointPolicies');
            container.innerHTML = '';
            
            document.getElementById('sharepointCount').textContent = allPolicies.sharepoint.length;
            
            if (allPolicies.sharepoint.length > 0) {
                // Add note about additional policies
                const noteDiv = document.createElement('div');
                noteDiv.className = 'alert alert-info';
                noteDiv.innerHTML = `
                    <strong>Note:</strong> Additional SharePoint policies available through SharePoint PowerShell:
                    <ul style="margin-top: 5px; margin-left: 20px;">
                        <li><code>Get-SPOSite</code> - Site policies and configurations</li>
                        <li><code>Get-SPOTenant</code> - Tenant-wide settings</li>
                        <li><code>Get-SPOSiteDesign</code> - Site designs</li>
                        <li><code>Get-SPOHubSite</code> - Hub site configurations</li>
                        <li><code>Get-SPOSharingSettings</code> - Sharing policies</li>
                    </ul>
                `;
                container.appendChild(noteDiv);
            }
            
            allPolicies.sharepoint.forEach(policy => {
                const card = createPolicyCard(policy);
                container.appendChild(card);
            });
        }

        // Teams policies - get what's available through Graph
        async function fetchTeamsPolicies() {
            try {
                allPolicies.teams = [];
                
                // Try to fetch Teams app setup policies
                try {
                    const teamsAppsResponse = await fetch('https://graph.microsoft.com/beta/teamwork/teamsAppSettings', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (teamsAppsResponse.ok) {
                        const settings = await teamsAppsResponse.json();
                        allPolicies.teams.push({
                            id: 'teams-app-settings',
                            name: 'Teams App Settings',
                            type: 'AppSettings',
                            description: 'Organization-wide Teams app settings',
                            service: 'teams',
                            raw: settings
                        });
                    }
                } catch (error) {
                    console.error('Error fetching Teams app settings:', error);
                }
                
                // Try to fetch Teams meeting settings
                try {
                    const meetingSettingsResponse = await fetch('https://graph.microsoft.com/beta/teamwork/workforceIntegrations', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (meetingSettingsResponse.ok) {
                        const data = await meetingSettingsResponse.json();
                        const integrations = data.value || [];
                        
                        integrations.forEach(integration => {
                            allPolicies.teams.push({
                                id: integration.id,
                                name: integration.displayName || 'Workforce Integration',
                                type: 'WorkforceIntegration',
                                description: 'Teams workforce integration',
                                service: 'teams',
                                raw: integration
                            });
                        });
                    }
                } catch (error) {
                    console.error('Error fetching workforce integrations:', error);
                }
                
                // Try to fetch Teams templates
                try {
                    const templatesResponse = await fetch('https://graph.microsoft.com/beta/teamsTemplates', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (templatesResponse.ok) {
                        const data = await templatesResponse.json();
                        const templates = data.value || [];
                        
                        // Only include custom templates (not built-in)
                        const customTemplates = templates.filter(t => !t.id.startsWith('com.microsoft.'));
                        
                        customTemplates.forEach(template => {
                            allPolicies.teams.push({
                                id: template.id,
                                name: template.displayName,
                                type: 'TeamTemplate',
                                description: template.shortDescription || 'Custom team template',
                                service: 'teams',
                                raw: template
                            });
                        });
                    }
                } catch (error) {
                    console.error('Error fetching Teams templates:', error);
                }
                
                // Add a note about PowerShell
                if (allPolicies.teams.length === 0) {
                    allPolicies.teams.push({
                        id: 'teams-note-1',
                        name: 'Limited Teams Access',
                        type: 'Note',
                        description: 'Most Teams policies require Teams PowerShell',
                        service: 'teams',
                        note: 'To access all Teams policies, use Teams PowerShell with Get-Cs* cmdlets like Get-CsTeamsMessagingPolicy, Get-CsTeamsMeetingPolicy, Get-CsTeamsCallingPolicy, etc.'
                    });
                }
                
                displayTeamsPolicies();
            } catch (error) {
                console.error('Error fetching Teams policies:', error);
                displayTeamsPolicies();
            }
        }

        function displayTeamsPolicies() {
            const container = document.getElementById('teamsPolicies');
            container.innerHTML = '';
            
            if (allPolicies.teams.length === 0 || (allPolicies.teams.length === 1 && allPolicies.teams[0].type === 'Note')) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Limited Teams Access via Graph API</strong><br>
                        Most Teams policies require Teams PowerShell for complete access.<br><br>
                        <strong>To export Teams policies:</strong>
                        <ol style="margin-top: 10px; margin-left: 20px;">
                            <li>Connect to Teams PowerShell</li>
                            <li>Run commands like:
                                <ul>
                                    <li><code>Get-CsTeamsMessagingPolicy</code></li>
                                    <li><code>Get-CsTeamsMeetingPolicy</code></li>
                                    <li><code>Get-CsTeamsCallingPolicy</code></li>
                                    <li><code>Get-CsTeamsChannelsPolicy</code></li>
                                    <li><code>Get-CsTeamsAppPermissionPolicy</code></li>
                                </ul>
                            </li>
                        </ol>
                        <a href="https://docs.microsoft.com/en-us/microsoftteams/teams-powershell-overview" target="_blank">Teams PowerShell Documentation</a>
                    </div>
                `;
            }
            
            document.getElementById('teamsCount').textContent = allPolicies.teams.length;
            
            allPolicies.teams.forEach(policy => {
                const card = createPolicyCard(policy);
                container.appendChild(card);
            });
        }

        // Azure AD policies
        async function fetchAADPolicies() {
            try {
                allPolicies.aad = [];
                
                // Conditional Access policies
                try {
                    const caResponse = await fetch('https://graph.microsoft.com/v1.0/identity/conditionalAccess/policies', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (caResponse.ok) {
                        const data = await caResponse.json();
                        const policies = data.value || [];
                        
                        policies.forEach(policy => {
                            allPolicies.aad.push({
                                id: policy.id,
                                name: policy.displayName,
                                type: 'ConditionalAccess',
                                description: `State: ${policy.state || 'Unknown'}`,
                                created: policy.createdDateTime,
                                modified: policy.modifiedDateTime,
                                service: 'aad',
                                raw: policy
                            });
                        });
                    }
                } catch (error) {
                    console.error('Error fetching CA policies:', error);
                }
                
                // Authentication methods policy
                try {
                    const authResponse = await fetch('https://graph.microsoft.com/beta/policies/authenticationMethodsPolicy', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (authResponse.ok) {
                        const policy = await authResponse.json();
                        allPolicies.aad.push({
                            id: policy.id,
                            name: 'Authentication Methods Policy',
                            type: 'AuthenticationMethods',
                            description: 'Organization authentication methods configuration',
                            service: 'aad',
                            raw: policy
                        });
                    }
                } catch (error) {
                    console.error('Error fetching auth methods policy:', error);
                }
                
                // Authorization policy
                try {
                    const authzResponse = await fetch('https://graph.microsoft.com/beta/policies/authorizationPolicy', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (authzResponse.ok) {
                        const policy = await authzResponse.json();
                        allPolicies.aad.push({
                            id: policy.id,
                            name: 'Authorization Policy',
                            type: 'Authorization',
                            description: 'Default authorization settings',
                            service: 'aad',
                            raw: policy
                        });
                    }
                } catch (error) {
                    console.error('Error fetching authorization policy:', error);
                }
                
                // Token lifetime policies
                try {
                    const tokenResponse = await fetch('https://graph.microsoft.com/v1.0/policies/tokenLifetimePolicies', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (tokenResponse.ok) {
                        const data = await tokenResponse.json();
                        const policies = data.value || [];
                        
                        policies.forEach(policy => {
                            allPolicies.aad.push({
                                id: policy.id,
                                name: policy.displayName,
                                type: 'TokenLifetime',
                                description: 'Token lifetime configuration',
                                service: 'aad',
                                raw: policy
                            });
                        });
                    }
                } catch (error) {
                    console.error('Error fetching token lifetime policies:', error);
                }
                
                // Identity security defaults
                try {
                    const defaultsResponse = await fetch('https://graph.microsoft.com/beta/policies/identitySecurityDefaultsEnforcementPolicy', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (defaultsResponse.ok) {
                        const policy = await defaultsResponse.json();
                        allPolicies.aad.push({
                            id: policy.id,
                            name: 'Security Defaults',
                            type: 'SecurityDefaults',
                            description: policy.isEnabled ? 'Enabled' : 'Disabled',
                            service: 'aad',
                            raw: policy
                        });
                    }
                } catch (error) {
                    console.error('Error fetching security defaults:', error);
                }
                
                displayAADPolicies();
            } catch (error) {
                console.error('Error fetching Azure AD policies:', error);
            }
        }

        function displayAADPolicies() {
            const container = document.getElementById('aadPolicies');
            container.innerHTML = '';
            
            document.getElementById('aadCount').textContent = allPolicies.aad.length;
            
            allPolicies.aad.forEach(policy => {
                const card = createPolicyCard(policy);
                container.appendChild(card);
            });
        }

        // Compliance policies
        async function fetchCompliancePolicies() {
            try {
                allPolicies.compliance = [];
                
                // Device compliance policies from Intune
                try {
                    const complianceResponse = await fetch('https://graph.microsoft.com/beta/deviceManagement/deviceCompliancePolicies', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (complianceResponse.ok) {
                        const data = await complianceResponse.json();
                        const policies = data.value || [];
                        
                        for (const policy of policies) {
                            // Fetch assignments
                            let assignments = [];
                            try {
                                const assignmentResponse = await fetch(`https://graph.microsoft.com/beta/deviceManagement/deviceCompliancePolicies/${policy.id}/assignments`, {
                                    headers: { 'Authorization': `Bearer ${accessToken}` }
                                });
                                
                                if (assignmentResponse.ok) {
                                    const assignmentData = await assignmentResponse.json();
                                    assignments = assignmentData.value || [];
                                }
                            } catch (assignError) {
                                console.error(`Error fetching compliance policy assignments:`, assignError);
                            }
                            
                            const assignmentSummary = await processAssignments(assignments);
                            
                            allPolicies.compliance.push({
                                id: policy.id,
                                name: policy.displayName,
                                type: 'DeviceCompliance',
                                description: policy.description || 'Device compliance policy',
                                created: policy.createdDateTime,
                                modified: policy.lastModifiedDateTime,
                                service: 'compliance',
                                assignments: assignmentSummary,
                                raw: policy,
                                rawAssignments: assignments
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error fetching device compliance policies:', error);
                }
                
                // Data Loss Prevention policies
                try {
                    const dlpResponse = await fetch('https://graph.microsoft.com/beta/informationProtection/dataLossPreventionPolicies', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (dlpResponse.ok) {
                        const data = await dlpResponse.json();
                        const policies = data.value || [];
                        
                        policies.forEach(policy => {
                            allPolicies.compliance.push({
                                id: policy.id,
                                name: policy.name,
                                type: 'DataLossPrevention',
                                description: 'DLP policy',
                                service: 'compliance',
                                raw: policy
                            });
                        });
                    }
                } catch (error) {
                    console.error('Error fetching DLP policies:', error);
                }
                
                // Retention labels
                try {
                    const labelsResponse = await fetch('https://graph.microsoft.com/beta/security/labels/retentionLabels', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (labelsResponse.ok) {
                        const data = await labelsResponse.json();
                        const labels = data.value || [];
                        
                        labels.forEach(label => {
                            allPolicies.compliance.push({
                                id: label.id,
                                name: label.displayName,
                                type: 'RetentionLabel',
                                description: label.descriptionForUsers || 'Retention label',
                                service: 'compliance',
                                raw: label
                            });
                        });
                    }
                } catch (error) {
                    console.error('Error fetching retention labels:', error);
                }
                
                displayCompliancePolicies();
            } catch (error) {
                console.error('Error fetching Compliance policies:', error);
            }
        }

        function displayCompliancePolicies() {
            const container = document.getElementById('compliancePolicies');
            container.innerHTML = '';
            
            document.getElementById('complianceCount').textContent = allPolicies.compliance.length;
            
            if (allPolicies.compliance.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <strong>No compliance policies found via Graph API</strong><br>
                        This could mean:
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            <li>No compliance policies are configured</li>
                            <li>Additional permissions may be required</li>
                            <li>Some policies require Security & Compliance PowerShell</li>
                        </ul>
                        <br>
                        <strong>For complete compliance policy export, use:</strong>
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            <li>Security & Compliance PowerShell for DLP, retention policies, etc.</li>
                            <li>Intune portal for device compliance policies</li>
                        </ul>
                    </div>
                `;
            } else {
                // Add a note about additional policies
                if (allPolicies.compliance.length > 0 && allPolicies.compliance.length < 5) {
                    const noteDiv = document.createElement('div');
                    noteDiv.className = 'alert alert-info';
                    noteDiv.innerHTML = `
                        <strong>Note:</strong> Additional compliance policies may be available through Security & Compliance PowerShell, including:
                        <ul style="margin-top: 5px; margin-left: 20px;">
                            <li>Advanced DLP policies</li>
                            <li>Retention policies</li>
                            <li>eDiscovery policies</li>
                            <li>Alert policies</li>
                        </ul>
                    `;
                    container.appendChild(noteDiv);
                }
                
                allPolicies.compliance.forEach(policy => {
                    const card = createPolicyCard(policy);
                    container.appendChild(card);
                });
            }
        }

        // Create policy card
        function createPolicyCard(policy) {
            const card = document.createElement('div');
            card.className = 'policy-card';
            card.dataset.policyId = `${policy.service}-${policy.id}`;
            
            const isSelected = selectedPolicies.has(card.dataset.policyId);
            if (isSelected) card.classList.add('selected');
            
            // Build assignment display
            let assignmentHtml = '';
            if (policy.assignments) {
                const assignments = [];
                if (policy.assignments.allUsers) assignments.push('<span style="color: #0056b3;">All Users</span>');
                if (policy.assignments.allDevices) assignments.push('<span style="color: #0056b3;">All Devices</span>');
                if (policy.assignments.groups && policy.assignments.groups.length > 0) {
                    policy.assignments.groups.forEach(group => {
                        assignments.push(`<span style="color: #28a745;">${group.name}</span>`);
                    });
                }
                if (policy.assignments.exclusions && policy.assignments.exclusions.length > 0) {
                    policy.assignments.exclusions.forEach(group => {
                        assignments.push(`<span style="color: #dc3545;">Exclude: ${group.name}</span>`);
                    });
                }
                
                if (assignments.length > 0) {
                    assignmentHtml = `<div style="margin-top: 8px; font-size: 13px;">
                        <strong>Assigned to:</strong> ${assignments.join(', ')}
                    </div>`;
                }
            }
            
            card.innerHTML = `
                <div class="policy-header">
                    <input type="checkbox" id="check-${policy.service}-${policy.id}" ${isSelected ? 'checked' : ''}>
                    <span class="policy-name">${policy.name || 'Unnamed Policy'}</span>
                    ${policy.enabled !== undefined ? `<span style="font-size: 12px; color: ${policy.enabled ? '#28a745' : '#dc3545'};">${policy.enabled ? '‚óè Enabled' : '‚óè Disabled'}</span>` : ''}
                    <span class="service-badge service-${policy.service}">${policy.service.toUpperCase()}</span>
                    <span class="policy-type">${policy.type}</span>
                </div>
                ${policy.description ? `<div class="policy-details">${policy.description}</div>` : ''}
                ${assignmentHtml}
                <div class="policy-meta">
                    ${policy.created ? `<span>Created: ${new Date(policy.created).toLocaleDateString()}</span>` : ''}
                    ${policy.modified ? `<span>Modified: ${new Date(policy.modified).toLocaleDateString()}</span>` : ''}
                </div>
                ${policy.note ? `<div class="alert alert-info" style="margin-top: 10px; padding: 8px; font-size: 12px;">${policy.note}</div>` : ''}
            `;
            
            const checkbox = card.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', (e) => {
                const policyId = card.dataset.policyId;
                if (e.target.checked) {
                    selectedPolicies.add(policyId);
                    card.classList.add('selected');
                } else {
                    selectedPolicies.delete(policyId);
                    card.classList.remove('selected');
                }
                updateStats();
            });
            
            return card;
        }

        // Search functionality
        ['intune', 'exchange', 'sharepoint', 'teams', 'aad', 'compliance'].forEach(service => {
            document.getElementById(`${service}Search`).addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const cards = document.querySelectorAll(`#${service}Policies .policy-card`);
                
                cards.forEach(card => {
                    const name = card.querySelector('.policy-name').textContent.toLowerCase();
                    const type = card.querySelector('.policy-type').textContent.toLowerCase();
                    const visible = name.includes(searchTerm) || type.includes(searchTerm);
                    card.style.display = visible ? '' : 'none';
                });
            });
        });

        // Select/Deselect all functions
        window.selectAllIntune = function() { selectAllService('intune'); };
        window.deselectAllIntune = function() { deselectAllService('intune'); };
        window.selectAllExchange = function() { selectAllService('exchange'); };
        window.deselectAllExchange = function() { deselectAllService('exchange'); };
        window.selectAllSharePoint = function() { selectAllService('sharepoint'); };
        window.deselectAllSharePoint = function() { deselectAllService('sharepoint'); };
        window.selectAllTeams = function() { selectAllService('teams'); };
        window.deselectAllTeams = function() { deselectAllService('teams'); };
        window.selectAllAAD = function() { selectAllService('aad'); };
        window.deselectAllAAD = function() { deselectAllService('aad'); };
        window.selectAllCompliance = function() { selectAllService('compliance'); };
        window.deselectAllCompliance = function() { deselectAllService('compliance'); };

        function selectAllService(service) {
            allPolicies[service].forEach(policy => {
                const policyId = `${service}-${policy.id}`;
                selectedPolicies.add(policyId);
                const checkbox = document.getElementById(`check-${policyId}`);
                if (checkbox) {
                    checkbox.checked = true;
                    checkbox.closest('.policy-card').classList.add('selected');
                }
            });
            updateStats();
        }

        function deselectAllService(service) {
            allPolicies[service].forEach(policy => {
                const policyId = `${service}-${policy.id}`;
                selectedPolicies.delete(policyId);
                const checkbox = document.getElementById(`check-${policyId}`);
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.closest('.policy-card').classList.remove('selected');
                }
            });
            updateStats();
        }

        // Refresh functions
        window.refreshIntune = async function() { await fetchIntunePolicies(); };
        window.refreshExchange = async function() { await fetchExchangePolicies(); };
        window.refreshSharePoint = async function() { await fetchSharePointPolicies(); };
        window.refreshTeams = async function() { await fetchTeamsPolicies(); };
        window.refreshAAD = async function() { await fetchAADPolicies(); };
        window.refreshCompliance = async function() { await fetchCompliancePolicies(); };

        // Update statistics
        function updateStats() {
            const total = Object.values(allPolicies).reduce((sum, policies) => sum + policies.length, 0);
            document.getElementById('totalPolicies').textContent = total;
            document.getElementById('selectedPolicies').textContent = selectedPolicies.size;
            
            const servicesWithPolicies = Object.entries(allPolicies).filter(([_, policies]) => policies.length > 0).length;
            document.getElementById('servicesQueried').textContent = servicesWithPolicies;
            
            if (total > 0) {
                document.getElementById('lastFetch').textContent = new Date().toLocaleTimeString();
            }
        }

        // Export functions
        window.exportSelected = async function() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            const policies = getSelectedPolicies();
            
            if (policies.length === 0) {
                alert('Please select at least one policy to export');
                return;
            }
            
            showExportProgress();
            
            if (format === 'csv' || format === 'both') {
                exportToCSV(policies, 'selected');
            }
            
            if (format === 'json' || format === 'both') {
                exportToJSON(policies, 'selected');
            }
            
            hideExportProgress();
        };

        window.exportAll = async function() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            const policies = getAllPolicies();
            
            if (policies.length === 0) {
                alert('No policies to export. Please fetch policies first.');
                return;
            }
            
            showExportProgress();
            
            if (format === 'csv' || format === 'both') {
                exportToCSV(policies, 'all');
            }
            
            if (format === 'json' || format === 'both') {
                exportToJSON(policies, 'all');
            }
            
            hideExportProgress();
        };

        function getSelectedPolicies() {
            const policies = [];
            selectedPolicies.forEach(policyId => {
                const [service, ...idParts] = policyId.split('-');
                const id = idParts.join('-');
                const policy = allPolicies[service]?.find(p => p.id === id);
                if (policy) policies.push(policy);
            });
            return policies;
        }

        function getAllPolicies() {
            return Object.values(allPolicies).flat();
        }

        function exportToCSV(policies, prefix) {
            const includeSettings = document.getElementById('includeSettings').checked;
            const includeTimestamps = document.getElementById('includeTimestamps').checked;
            const includeAssignments = document.getElementById('includeAssignments').checked;
            
            const headers = ['Service', 'Name', 'Type', 'Description'];
            if (includeAssignments) {
                headers.push('Assignments', 'Groups', 'Exclusions');
            }
            if (includeTimestamps) {
                headers.push('Created', 'Modified');
            }
            
            const rows = [headers];
            
            policies.forEach(policy => {
                const row = [
                    policy.service.toUpperCase(),
                    policy.name || 'Unnamed',
                    policy.type,
                    policy.description || ''
                ];
                
                if (includeAssignments) {
                    if (policy.assignments) {
                        const assignmentTypes = [];
                        if (policy.assignments.allUsers) assignmentTypes.push('All Users');
                        if (policy.assignments.allDevices) assignmentTypes.push('All Devices');
                        
                        const groupNames = policy.assignments.groups?.map(g => g.name).join('; ') || '';
                        const exclusionNames = policy.assignments.exclusions?.map(g => g.name).join('; ') || '';
                        
                        row.push(assignmentTypes.join(', ') || 'None');
                        row.push(groupNames);
                        row.push(exclusionNames);
                    } else {
                        row.push('', '', '');
                    }
                }
                
                if (includeTimestamps) {
                    row.push(
                        policy.created ? new Date(policy.created).toISOString() : '',
                        policy.modified ? new Date(policy.modified).toISOString() : ''
                    );
                }
                
                rows.push(row);
            });
            
            const csv = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
            downloadFile(csv, `M365_Policies_${prefix}_${getTimestamp()}.csv`, 'text/csv');
        }

        function exportToJSON(policies, prefix) {
            const includeMetadata = document.getElementById('includeMetadata').checked;
            const includeSettings = document.getElementById('includeSettings').checked;
            const includeAssignments = document.getElementById('includeAssignments').checked;
            
            const exportData = {
                exportDate: new Date().toISOString(),
                totalPolicies: policies.length,
                policies: policies.map(policy => {
                    const exportPolicy = {
                        service: policy.service,
                        name: policy.name,
                        type: policy.type,
                        id: policy.id
                    };
                    
                    if (includeMetadata) {
                        exportPolicy.description = policy.description;
                        exportPolicy.created = policy.created;
                        exportPolicy.modified = policy.modified;
                        if (policy.platform) exportPolicy.platform = policy.platform;
                    }
                    
                    if (includeAssignments && policy.assignments) {
                        exportPolicy.assignments = policy.assignments;
                        if (policy.rawAssignments) {
                            exportPolicy.rawAssignments = policy.rawAssignments;
                        }
                    }
                    
                    if (includeSettings && policy.raw) {
                        exportPolicy.configuration = policy.raw;
                    }
                    
                    return exportPolicy;
                })
            };
            
            const json = JSON.stringify(exportData, null, 2);
            downloadFile(json, `M365_Policies_${prefix}_${getTimestamp()}.json`, 'application/json');
        }

        window.downloadIndividual = async function() {
            const policies = getSelectedPolicies();
            
            if (policies.length === 0) {
                alert('Please select at least one policy to download individually');
                return;
            }
            
            showExportProgress();
            
            for (let i = 0; i < policies.length; i++) {
                const policy = policies[i];
                const json = JSON.stringify(policy.raw || policy, null, 2);
                const filename = `${policy.service}_${policy.type}_${policy.name.replace(/[^a-z0-9]/gi, '_')}.json`;
                downloadFile(json, filename, 'application/json');
                
                // Update progress
                const progress = Math.round(((i + 1) / policies.length) * 100);
                document.getElementById('exportProgressFill').style.width = progress + '%';
                document.getElementById('exportProgressText').textContent = progress + '%';
                
                // Small delay between downloads
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            hideExportProgress();
        };

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function getTimestamp() {
            return new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        }

        function showExportProgress() {
            document.getElementById('exportProgress').style.display = 'block';
            document.getElementById('exportProgressFill').style.width = '0%';
            document.getElementById('exportProgressText').textContent = '0%';
            document.getElementById('exportStatus').textContent = 'Preparing export...';
        }

        function hideExportProgress() {
            setTimeout(() => {
                document.getElementById('exportProgress').style.display = 'none';
            }, 2000);
            document.getElementById('exportStatus').textContent = 'Export completed!';
            document.getElementById('exportProgressFill').style.width = '100%';
            document.getElementById('exportProgressText').textContent = '100%';
        }

        // Save Client ID to localStorage if available
        const clientIdInput = document.getElementById('clientId');
        
        // Load saved Client ID
        try {
            const savedClientId = localStorage.getItem('m365PolicyDownloaderClientId');
            if (savedClientId) {
                clientIdInput.value = savedClientId;
                clientIdInput.dispatchEvent(new Event('input'));
            }
        } catch (e) {
            console.log('localStorage not available');
        }

        // Save Client ID when changed
        clientIdInput.addEventListener('change', () => {
            const clientId = clientIdInput.value.trim();
            if (clientId) {
                try {
                    localStorage.setItem('m365PolicyDownloaderClientId', clientId);
                } catch (e) {
                    console.log('Could not save Client ID to localStorage');
                }
            }
        });

        // Initialize stats
        updateStats();

        // Debug function to manually show redirect URI
        window.showRedirectUri = function() {
            const el = document.getElementById('currentRedirectUri');
            const alert = document.getElementById('redirectUriAlert');
            if (el) {
                el.textContent = window.currentUrl;
                console.log('Redirect URI manually set to:', window.currentUrl);
            }
            if (alert) {
                alert.style.display = 'block';
                console.log('Redirect URI alert made visible');
            }
        };

        console.log('M365 Policy Downloader initialized successfully');
        console.log('Current redirect URI:', window.currentUrl);
        console.log('Redirect URI Alert visible:', document.getElementById('redirectUriAlert')?.style.display);
        console.log('Environment: Sandboxed =', window.isSandboxed);
        console.log('To manually show redirect URI, run: window.showRedirectUri()');
        
        }); // End of DOMContentLoaded
        
        // Fallback for redirect URI display
        window.addEventListener('load', function() {
            const uriEl = document.getElementById('currentRedirectUri');
            if (uriEl && (!uriEl.textContent || uriEl.textContent === 'Loading...')) {
                uriEl.textContent = window.currentUrl;
                console.log('Redirect URI set via window.load:', window.currentUrl);
            }
        });
    </script>
</body>
</html>
