<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microsoft 365 Policy Downloader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .header {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .header-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .header-title h1 {
            font-size: 1.875rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            color: #4b5563;
        }

        .icon {
            width: 1.5rem;
            height: 1.5rem;
            display: inline-block;
            vertical-align: middle;
        }

        .status-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-dot.connected {
            background: #28a745;
        }

        .nav-tabs {
            display: flex;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
            position: relative;
        }

        .nav-tab:hover {
            background-color: #f3f4f6;
        }

        .nav-tab.active {
            color: #2563eb;
            background-color: #eff6ff;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #2563eb;
        }

        .tab-content {
            display: none;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auth-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-status {
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .auth-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .auth-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: #2a5298;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3c72;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn svg {
            pointer-events: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn.loading {
            color: transparent;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .collapsible {
            cursor: pointer;
            padding: 10px;
            background: #2a5298;
            color: white;
            border: none;
            border-radius: 5px;
            width: 100%;
            text-align: left;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible:hover {
            background: #1e3c72;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: white;
            border-radius: 0 0 5px 5px;
        }

        .collapsible-content.active {
            max-height: 3000px;
            transition: max-height 0.5s ease-in;
        }

        .collapsible::after {
            content: '\25BC';
            font-size: 12px;
            transition: transform 0.3s;
        }

        .collapsible.active::after {
            transform: rotate(180deg);
        }

        .policy-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .policy-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .policy-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .policy-card.selected {
            background: #eff6ff;
            border-color: #2563eb;
        }

        .policy-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .policy-header input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .policy-name {
            font-weight: 600;
            color: #1f2937;
            flex: 1;
        }

        .policy-type {
            background: #e0e7ff;
            color: #3730a3;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .policy-details {
            font-size: 0.875rem;
            color: #6b7280;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-left: 30px;
        }

        .policy-meta {
            display: flex;
            gap: 20px;
            margin-top: 8px;
            font-size: 13px;
            color: #6b7280;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-controls input[type="text"] {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-text {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            color: #333;
            z-index: 1;
        }

        .policy-count {
            background: #e0e7ff;
            color: #3730a3;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 8px;
        }

        .service-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 4px;
        }

        .service-intune { background: #e3f2fd; color: #1565c0; }
        .service-exchange { background: #e8f5e9; color: #2e7d32; }
        .service-sharepoint { background: #fff3e0; color: #ef6c00; }
        .service-teams { background: #f3e5f5; color: #6a1b9a; }
        .service-aad { background: #fce4ec; color: #c2185b; }
        .service-compliance { background: #e0f2f1; color: #00695c; }

        .export-options {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 10px;
            color: #4b5563;
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem 0.5rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .filter-controls {
                flex-direction: column;
            }
            
            .filter-controls input[type="text"] {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Accessibility improvements */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles */
        *:focus-visible {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }

        .redirect-uri-box {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .redirect-uri-box h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .redirect-uri-display {
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.9em;
        }

        .copy-btn {
            padding: 5px 15px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .copy-btn:hover {
            background: #138496;
        }

        .how-to-section {
            background: #f0f8ff;
            border: 2px solid #2a5298;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .how-to-section h3 {
            color: #2a5298;
            margin-bottom: 15px;
        }

        .how-to-section h4 {
            color: #1e3c72;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .how-to-section ol {
            margin-left: 20px;
        }

        .how-to-section li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .how-to-section code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="connectionStatus">Disconnected</span>
            </div>
            <div class="header-title">
                <h1>
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Microsoft 365 Policy Downloader
                </h1>
            </div>
            <p>Export and backup policies from all Microsoft 365 admin portals with assignment details</p>
        </div>

        <div class="nav-tabs" role="tablist">
            <button class="nav-tab active" role="tab" aria-selected="true" onclick="switchTab('overview', this)">Overview</button>
            <button class="nav-tab" role="tab" aria-selected="false" onclick="switchTab('intune', this)">Intune</button>
            <button class="nav-tab" role="tab" aria-selected="false" onclick="switchTab('exchange', this)">Exchange</button>
            <button class="nav-tab" role="tab" aria-selected="false" onclick="switchTab('sharepoint', this)">SharePoint</button>
            <button class="nav-tab" role="tab" aria-selected="false" onclick="switchTab('teams', this)">Teams</button>
            <button class="nav-tab" role="tab" aria-selected="false" onclick="switchTab('aad', this)">Azure AD</button>
            <button class="nav-tab" role="tab" aria-selected="false" onclick="switchTab('compliance', this)">Compliance</button>
            <button class="nav-tab" role="tab" aria-selected="false" onclick="switchTab('export', this)">Export</button>
        </div>

        <!-- Dynamic Redirect URI Alert -->
        <div class="alert alert-danger" id="redirectUriAlert" style="margin: 0 0 20px 0; display: none;">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
            <div>
                <strong>Important - Dynamic Redirect URI Detected!</strong>
                <div class="redirect-uri-box">
                    <h4>Your current redirect URI is:</h4>
                    <div class="redirect-uri-display" id="currentRedirectUri">Loading...</div>
                    <button class="copy-btn" onclick="copyRedirectUri(this)">Copy to Clipboard</button>
                    <p style="margin-top: 10px;">
                        <strong>You must add this exact URI to your Entra ID app registration before signing in!</strong><br>
                        This URI changes each time you load the page in an embedded environment.
                    </p>
                </div>
            </div>
        </div>

        <!-- How to Get Client ID Section -->
        <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 0; margin-bottom: 20px;">
            <button class="collapsible" id="howToToggle">
                <span>How to Get Your Entra ID Client ID</span>
            </button>
            <div class="collapsible-content" id="howToContent">
                <div class="how-to-section">
                    <h3>Step-by-Step Guide to Register Your Application</h3>
                    
                    <div class="alert alert-warning">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                        </svg>
                        <strong>Dynamic Environment Warning:</strong> If you're running this in Google Colab, JSFiddle, or similar platforms, the redirect URI changes each time. You'll need to update it in Entra ID before each use.
                    </div>
                    
                    <h4>Step 1: Register an Application in Entra ID</h4>
                    <ol>
                        <li>Go to the <a href="https://entra.microsoft.com" target="_blank">Microsoft Entra Portal</a></li>
                        <li>Navigate to <strong>Applications</strong> → <strong>App registrations</strong></li>
                        <li>Click <strong>New registration</strong></li>
                        <li>Configure the application:
                            <ul style="margin-top: 5px;">
                                <li><strong>Name:</strong> M365 Policy Downloader (or any name you prefer)</li>
                                <li><strong>Supported account types:</strong> Choose based on your needs:
                                    <ul>
                                        <li>"Accounts in this organizational directory only" (single tenant)</li>
                                        <li>"Accounts in any organizational directory" (multi-tenant)</li>
                                    </ul>
                                </li>
                                <li><strong>Redirect URI:</strong>
                                    <ul>
                                        <li>Platform: <code>Single-page application (SPA)</code></li>
                                        <li>URI: <strong style="color: red;">Copy the URI shown above in the yellow box</strong></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li>Click <strong>Register</strong></li>
                    </ol>

                    <h4>Step 2: Configure API Permissions</h4>
                    <ol>
                        <li>In your app registration, go to <strong>API permissions</strong></li>
                        <li>Click <strong>Add a permission</strong></li>
                        <li>Select <strong>Microsoft Graph</strong></li>
                        <li>Choose <strong>Delegated permissions</strong></li>
                        <li>Search for and add these permissions:
                            <ul style="margin-top: 5px;">
                                <li><code>DeviceManagementConfiguration.Read.All</code> - Read Intune policies</li>
                                <li><code>Policy.Read.All</code> - Read Azure AD and conditional access policies</li>
                                <li><code>Directory.Read.All</code> - Read directory data</li>
                                <li><code>Group.Read.All</code> - Read group information for assignments</li>
                                <li><code>Sites.Read.All</code> - Read SharePoint settings</li>
                                <li><code>User.Read</code> - Sign in and read user profile</li>
                            </ul>
                        </li>
                        <li>Click <strong>Add permissions</strong></li>
                        <li><strong style="color: red;">Important:</strong> Click <strong>Grant admin consent for [Your Organization]</strong></li>
                        <li>Ensure all permissions show a green checkmark under "Status"</li>
                    </ol>

                    <h4>Step 3: Get Your Client ID</h4>
                    <ol>
                        <li>Go to the <strong>Overview</strong> page of your app registration</li>
                        <li>Copy the <strong>Application (client) ID</strong> (it looks like: <code>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</code>)</li>
                        <li>Paste it in the Client ID field below</li>
                    </ol>

                    <h4>Troubleshooting Common Issues:</h4>
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 15px; margin: 15px 0;">
                        <ul style="margin-left: 20px;">
                            <li><strong>Button not responding:</strong> Check browser console (F12) for errors</li>
                            <li><strong>403 Forbidden:</strong> Admin consent not granted - have an admin grant consent in Entra ID</li>
                            <li><strong>401 Unauthorized:</strong> Token expired - sign out and sign in again</li>
                            <li><strong>AADSTS50011:</strong> Redirect URI mismatch - ensure the URI matches exactly</li>
                            <li><strong>Platform doesn't matter:</strong> Works on Windows, macOS, and Linux</li>
                        </ul>
                    </div>

                    <h4>Alternative: Use a Static Hosting Service</h4>
                    <p>To avoid changing the redirect URI each time, consider hosting this HTML file on:</p>
                    <ul style="margin-left: 20px;">
                        <li>GitHub Pages (free)</li>
                        <li>Netlify (free tier available)</li>
                        <li>Microsoft Azure Static Web Apps (free tier available)</li>
                        <li>Your own web server</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Overview Tab -->
        <div class="tab-content active" id="overviewTab" role="tabpanel">
            <div class="alert alert-warning" id="sandboxWarning" style="display: none;">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                </svg>
                <div>
                    <strong>⚠️ Sandboxed Environment Detected!</strong>
                    <p>You're running this in a restricted environment. Some features may not work:</p>
                    <ul style="margin-top: 5px;">
                        <li><strong>Authentication popups may be blocked</strong> - Use manual token input option if needed</li>
                        <li><strong>Clipboard API is blocked</strong> - You'll need to manually copy the redirect URI</li>
                        <li><strong>Best solution:</strong> Download this HTML file and run it locally for full functionality</li>
                    </ul>
                    <p style="margin-top: 10px;">
                        <strong>To download:</strong> Right-click on this page → "Save As" → Save as HTML file → Open locally
                    </p>
                </div>
            </div>
            
            <div class="auth-section">
                <h3>Authentication</h3>
                <div class="form-group">
                    <label for="clientId">Entra ID Client ID:</label>
                    <input type="text" id="clientId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" 
                           pattern="[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}">
                    <small style="display: block; margin-top: 5px; color: #666;">Enter your Entra ID application Client ID</small>
                </div>
                <div id="authStatus" class="auth-status disconnected" role="status">
                    <span>Not connected to Microsoft Graph</span>
                </div>
                <button id="loginBtn" class="btn btn-primary" disabled aria-label="Sign in with Microsoft">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    Sign in with Microsoft
                </button>
                <button id="signOutBtn" class="btn btn-danger" style="display: none;">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                        <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                    </svg>
                    Sign Out
                </button>
                <button id="fetchAllBtn" class="btn btn-success" disabled>
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3 3a.5.5 0 0 0 .708-.708L8.5 11.707V5.5a.5.5 0 0 0-1 0v6.207l-1.646-1.646a.5.5 0 0 0-.708.708z"/>
                    </svg>
                    Fetch All Policies
                </button>
                <div id="userInfo" style="display: none;">
                    <strong>Signed in as:</strong> <span id="userEmail"></span>
                </div>
            </div>

            <div class="alert alert-info">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                </svg>
                <div>
                    <strong>Note:</strong> This tool requires Microsoft Graph API permissions:
                    <ul style="margin-top: 5px; margin-left: 20px;">
                        <li>DeviceManagementConfiguration.Read.All - To read Intune configuration policies</li>
                        <li>Policy.Read.All - To read Azure AD and conditional access policies</li>
                        <li>Directory.Read.All - To read directory information</li>
                        <li>Group.Read.All - To read group names for policy assignments</li>
                        <li>Sites.Read.All - To read SharePoint policies</li>
                        <li>User.Read - To sign in and read user profile</li>
                    </ul>
                    <small>Platform: Works on Windows, macOS, and Linux in any modern browser</small>
                </div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalPolicies">0</div>
                    <div class="stat-label">Total Policies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="selectedPolicies">0</div>
                    <div class="stat-label">Selected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="servicesQueried">0</div>
                    <div class="stat-label">Services Queried</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="lastFetch">Never</div>
                    <div class="stat-label">Last Fetch</div>
                </div>
            </div>

            <div id="overviewProgress" style="display: none;">
                <h3>Fetching Policies...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="overviewProgressFill"></div>
                    <div class="progress-text" id="overviewProgressText">0%</div>
                </div>
                <p id="currentService" style="text-align: center; color: #666;">Initializing...</p>
            </div>
            
            <div id="fetchSummary" style="display: none;">
                <!-- Fetch summary will be inserted here -->
            </div>
        </div>

        <!-- Intune Tab -->
        <div class="tab-content" id="intuneTab" role="tabpanel">
            <h3>Intune Policies <span class="policy-count" id="intuneCount">0</span></h3>
            
            <div class="filter-controls">
                <input type="text" id="intuneSearch" placeholder="Search Intune policies...">
                <button class="btn btn-secondary" onclick="selectAllIntune()">Select All</button>
                <button class="btn btn-secondary" onclick="deselectAllIntune()">Deselect All</button>
                <button class="btn btn-primary" onclick="refreshIntune()">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                    </svg>
                    Refresh
                </button>
            </div>

            <div id="intunePolicies" class="policy-grid">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3>No Policies Loaded</h3>
                    <p>Sign in and click "Fetch All Policies" to load Intune policies</p>
                </div>
            </div>
        </div>

        <!-- Exchange Tab -->
        <div class="tab-content" id="exchangeTab" role="tabpanel">
            <h3>Exchange Policies <span class="policy-count" id="exchangeCount">0</span></h3>
            
            <div class="filter-controls">
                <input type="text" id="exchangeSearch" placeholder="Search Exchange policies...">
                <button class="btn btn-secondary" onclick="selectAllExchange()">Select All</button>
                <button class="btn btn-secondary" onclick="deselectAllExchange()">Deselect All</button>
                <button class="btn btn-primary" onclick="refreshExchange()">Refresh</button>
            </div>

            <div id="exchangePolicies" class="policy-grid">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3>No Policies Loaded</h3>
                    <p>Sign in and click "Fetch All Policies" to load Exchange policies</p>
                </div>
            </div>
        </div>

        <!-- SharePoint Tab -->
        <div class="tab-content" id="sharepointTab" role="tabpanel">
            <h3>SharePoint Policies <span class="policy-count" id="sharepointCount">0</span></h3>
            
            <div class="filter-controls">
                <input type="text" id="sharepointSearch" placeholder="Search SharePoint policies...">
                <button class="btn btn-secondary" onclick="selectAllSharePoint()">Select All</button>
                <button class="btn btn-secondary" onclick="deselectAllSharePoint()">Deselect All</button>
                <button class="btn btn-primary" onclick="refreshSharePoint()">Refresh</button>
            </div>

            <div id="sharepointPolicies" class="policy-grid">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3>No Policies Loaded</h3>
                    <p>Sign in and click "Fetch All Policies" to load SharePoint policies</p>
                </div>
            </div>
        </div>

        <!-- Teams Tab -->
        <div class="tab-content" id="teamsTab" role="tabpanel">
            <h3>Teams Policies <span class="policy-count" id="teamsCount">0</span></h3>
            
            <div class="filter-controls">
                <input type="text" id="teamsSearch" placeholder="Search Teams policies...">
                <button class="btn btn-secondary" onclick="selectAllTeams()">Select All</button>
                <button class="btn btn-secondary" onclick="deselectAllTeams()">Deselect All</button>
                <button class="btn btn-primary" onclick="refreshTeams()">Refresh</button>
            </div>

            <div id="teamsPolicies" class="policy-grid">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3>No Policies Loaded</h3>
                    <p>Sign in and click "Fetch All Policies" to load Teams policies</p>
                </div>
            </div>
        </div>

        <!-- Azure AD Tab -->
        <div class="tab-content" id="aadTab" role="tabpanel">
            <h3>Azure AD Policies <span class="policy-count" id="aadCount">0</span></h3>
            
            <div class="filter-controls">
                <input type="text" id="aadSearch" placeholder="Search Azure AD policies...">
                <button class="btn btn-secondary" onclick="selectAllAAD()">Select All</button>
                <button class="btn btn-secondary" onclick="deselectAllAAD()">Deselect All</button>
                <button class="btn btn-primary" onclick="refreshAAD()">Refresh</button>
            </div>

            <div id="aadPolicies" class="policy-grid">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3>No Policies Loaded</h3>
                    <p>Sign in and click "Fetch All Policies" to load Azure AD policies</p>
                </div>
            </div>
        </div>

        <!-- Compliance Tab -->
        <div class="tab-content" id="complianceTab" role="tabpanel">
            <h3>Compliance Policies <span class="policy-count" id="complianceCount">0</span></h3>
            
            <div class="filter-controls">
                <input type="text" id="complianceSearch" placeholder="Search Compliance policies...">
                <button class="btn btn-secondary" onclick="selectAllCompliance()">Select All</button>
                <button class="btn btn-secondary" onclick="deselectAllCompliance()">Deselect All</button>
                <button class="btn btn-primary" onclick="refreshCompliance()">Refresh</button>
            </div>

            <div id="compliancePolicies" class="policy-grid">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3>No Policies Loaded</h3>
                    <p>Sign in and click "Fetch All Policies" to load Compliance policies</p>
                </div>
            </div>
        </div>

        <!-- Export Tab -->
        <div class="tab-content" id="exportTab" role="tabpanel">
            <h3>Export Options</h3>
            
            <div class="export-options">
                <h4>Export Format</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="radio" name="exportFormat" id="formatCSV" value="csv" checked>
                        <label for="formatCSV">CSV (Summary)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="radio" name="exportFormat" id="formatJSON" value="json">
                        <label for="formatJSON">JSON (Full Details)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="radio" name="exportFormat" id="formatBoth" value="both">
                        <label for="formatBoth">Both CSV & JSON</label>
                    </div>
                </div>

                <h4 style="margin-top: 20px;">Include in Export</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeMetadata" checked>
                        <label for="includeMetadata">Policy Metadata</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeSettings" checked>
                        <label for="includeSettings">Policy Settings</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeAssignments" checked>
                        <label for="includeAssignments">Assignments</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="includeTimestamps" checked>
                        <label for="includeTimestamps">Created/Modified Dates</label>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="exportSelected()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3 3a.5.5 0 0 0 .708-.708L8.5 11.707V5.5a.5.5 0 0 0-1 0v6.207l-1.646-1.646a.5.5 0 0 0-.708.708z"/>
                        </svg>
                        Export Selected Policies
                    </button>
                    <button class="btn btn-primary" onclick="exportAll()">
                        Export All Policies
                    </button>
                    <button class="btn btn-secondary" onclick="downloadIndividual()">
                        Download Individual Policy JSONs
                    </button>
                </div>

                <div id="exportProgress" style="display: none; margin-top: 20px;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="exportProgressFill"></div>
                        <div class="progress-text" id="exportProgressText">0%</div>
                    </div>
                    <p id="exportStatus" style="text-align: center; color: #666;">Preparing export...</p>
                </div>
            </div>

            <div class="alert alert-warning" style="margin-top: 20px;">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                </svg>
                <div>
                    <strong>Export Notes:</strong>
                    <ul style="margin-top: 5px; margin-left: 20px;">
                        <li>CSV format includes policy summaries and key settings</li>
                        <li>JSON format includes complete policy configurations</li>
                        <li>Individual downloads create separate JSON files for each policy</li>
                        <li>Large exports may take several minutes to complete</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Include MSAL library -->
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    
    <script>
        // Global variables
        let msalInstance = null;
        let accessToken = null;
        let allPolicies = {
            intune: [],
            exchange: [],
            sharepoint: [],
            teams: [],
            aad: [],
            compliance: []
        };
        let selectedPolicies = new Set();
        let isSandboxed = false;

        // Set current URL immediately
        window.currentUrl = window.location.href.split('#')[0].split('?')[0];
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded - initializing M365 Policy Downloader');
            
            // Set redirect URI
            const redirectUriElement = document.getElementById('currentRedirectUri');
            if (redirectUriElement) {
                redirectUriElement.textContent = window.currentUrl;
            }
            
            // Check environment
            const isDynamicEnvironment = window.currentUrl.includes('googleusercontent.com') || 
                                       window.currentUrl.includes('jsfiddle.net') || 
                                       window.currentUrl.includes('codepen.io') ||
                                       window.currentUrl.includes('stackblitz.com') ||
                                       window.currentUrl.includes('codesandbox.io') ||
                                       window.currentUrl.includes('colab') ||
                                       window.currentUrl.includes('localhost') ||
                                       window.currentUrl.includes('127.0.0.1') ||
                                       window.currentUrl.includes('file://');
            
            isSandboxed = isDynamicEnvironment;
            
            // Show/hide alerts based on environment
            const redirectAlert = document.getElementById('redirectUriAlert');
            if (redirectAlert) {
                redirectAlert.style.display = isDynamicEnvironment ? 'block' : 'none';
            }
            
            if (isSandboxed) {
                const sandboxWarning = document.getElementById('sandboxWarning');
                if (sandboxWarning) {
                    sandboxWarning.style.display = 'block';
                }
            }

            // Setup how-to toggle
            const howToToggle = document.getElementById('howToToggle');
            const howToContent = document.getElementById('howToContent');
            
            if (howToToggle && howToContent) {
                howToToggle.addEventListener('click', function() {
                    howToToggle.classList.toggle('active');
                    howToContent.classList.toggle('active');
                });
            }
            
            // Initialize all components
            initializeAuth();
            initializeFilters();
            initializeExport();
            
            // Initial stats update
            updateStats();
        });

        // Tab switching - Fixed version
        function switchTab(tabName, buttonElement) {
            console.log('Switching to tab:', tabName);
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Mark nav tab as active
            if (buttonElement) {
                buttonElement.classList.add('active');
                buttonElement.setAttribute('aria-selected', 'true');
            }
        }

        // Copy redirect URI - Fixed version
        function copyRedirectUri(buttonElement) {
            const redirectUri = document.getElementById('currentRedirectUri').textContent;
            
            if (!isSandboxed && navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(redirectUri).then(() => {
                    const originalText = buttonElement.textContent;
                    buttonElement.textContent = 'Copied!';
                    buttonElement.style.background = '#28a745';
                    setTimeout(() => {
                        buttonElement.textContent = originalText;
                        buttonElement.style.background = '';
                    }, 2000);
                }).catch(() => {
                    fallbackCopyToClipboard(redirectUri, buttonElement);
                });
            } else {
                fallbackCopyToClipboard(redirectUri, buttonElement);
            }
        }

        function fallbackCopyToClipboard(text, buttonElement) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                if (buttonElement) {
                    const originalText = buttonElement.textContent;
                    buttonElement.textContent = 'Copied!';
                    buttonElement.style.background = '#28a745';
                    setTimeout(() => {
                        buttonElement.textContent = originalText;
                        buttonElement.style.background = '';
                    }, 2000);
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                alert('Copy failed. Please manually copy the URI: ' + text);
            }
            
            document.body.removeChild(textArea);
        }

        // Initialize authentication
        function initializeAuth() {
            const clientIdInput = document.getElementById('clientId');
            const loginBtn = document.getElementById('loginBtn');
            const signOutBtn = document.getElementById('signOutBtn');
            const fetchAllBtn = document.getElementById('fetchAllBtn');
            
            // Client ID validation
            clientIdInput.addEventListener('input', function(e) {
                const clientId = e.target.value.trim();
                const guidPattern = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;
                
                if (guidPattern.test(clientId)) {
                    loginBtn.disabled = false;
                    clientIdInput.style.borderColor = '#28a745';
                    
                    // Initialize MSAL
                    const msalConfig = {
                        auth: {
                            clientId: clientId,
                            authority: 'https://login.microsoftonline.com/common',
                            redirectUri: window.currentUrl
                        },
                        cache: {
                            cacheLocation: 'sessionStorage',
                            storeAuthStateInCookie: true
                        }
                    };
                    
                    try {
                        msalInstance = new msal.PublicClientApplication(msalConfig);
                        console.log('MSAL instance created successfully');
                    } catch (error) {
                        console.error('Error creating MSAL instance:', error);
                        alert('Error initializing authentication. Please check your Client ID.');
                    }
                } else {
                    loginBtn.disabled = true;
                    clientIdInput.style.borderColor = clientId ? '#dc3545' : '#ddd';
                }
            });
            
            // Login button handler
            loginBtn.addEventListener('click', async function() {
                if (!msalInstance) {
                    alert('Please enter a valid Client ID first');
                    return;
                }
                
                try {
                    const loginRequest = {
                        scopes: [
                            'User.Read',
                            'DeviceManagementConfiguration.Read.All',
                            'Policy.Read.All',
                            'Directory.Read.All',
                            'Group.Read.All',
                            'Sites.Read.All'
                        ]
                    };
                    
                    const loginResponse = await msalInstance.loginPopup(loginRequest);
                    handleAuthentication(loginResponse);
                } catch (error) {
                    console.error('Login failed:', error);
                    alert('Authentication failed: ' + error.message);
                }
            });
            
            // Sign out button handler
            signOutBtn.addEventListener('click', function() {
                if (msalInstance) {
                    msalInstance.logoutPopup();
                }
                accessToken = null;
                updateAuthUI(false);
            });
            
            // Fetch all button handler
            fetchAllBtn.addEventListener('click', fetchAllPolicies);
        }

        // Handle successful authentication
        function handleAuthentication(response) {
            accessToken = response.accessToken;
            updateAuthUI(true);
            
            // Update user info
            const userEmail = document.getElementById('userEmail');
            userEmail.textContent = response.account.username;
            
            console.log('Authentication successful');
        }

        // Update authentication UI
        function updateAuthUI(isAuthenticated) {
            const authStatus = document.getElementById('authStatus');
            const loginBtn = document.getElementById('loginBtn');
            const signOutBtn = document.getElementById('signOutBtn');
            const fetchAllBtn = document.getElementById('fetchAllBtn');
            const userInfo = document.getElementById('userInfo');
            const statusDot = document.getElementById('statusDot');
            const connectionStatus = document.getElementById('connectionStatus');
            
            if (isAuthenticated) {
                authStatus.className = 'auth-status connected';
                authStatus.innerHTML = '<span>Connected to Microsoft Graph</span>';
                loginBtn.style.display = 'none';
                signOutBtn.style.display = 'inline-flex';
                fetchAllBtn.disabled = false;
                userInfo.style.display = 'block';
                statusDot.classList.add('connected');
                connectionStatus.textContent = 'Connected';
            } else {
                authStatus.className = 'auth-status disconnected';
                authStatus.innerHTML = '<span>Not connected to Microsoft Graph</span>';
                loginBtn.style.display = 'inline-flex';
                signOutBtn.style.display = 'none';
                fetchAllBtn.disabled = true;
                userInfo.style.display = 'none';
                statusDot.classList.remove('connected');
                connectionStatus.textContent = 'Disconnected';
            }
        }

        // Initialize filters
        function initializeFilters() {
            // Setup search filters for each service
            const services = ['intune', 'exchange', 'sharepoint', 'teams', 'aad', 'compliance'];
            
            services.forEach(service => {
                const searchInput = document.getElementById(service + 'Search');
                if (searchInput) {
                    searchInput.addEventListener('input', function() {
                        filterPolicies(service);
                    });
                }
            });
        }

        // Filter policies based on search input
        function filterPolicies(service) {
            const searchInput = document.getElementById(service + 'Search');
            const searchTerm = searchInput.value.toLowerCase();
            const policyContainer = document.getElementById(service + 'Policies');
            const policyCards = policyContainer.querySelectorAll('.policy-card');
            
            policyCards.forEach(card => {
                const policyName = card.querySelector('.policy-name').textContent.toLowerCase();
                if (policyName.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Select all policies for a service
        window.selectAllIntune = () => selectAll('intune');
        window.deselectAllIntune = () => deselectAll('intune');
        window.selectAllExchange = () => selectAll('exchange');
        window.deselectAllExchange = () => deselectAll('exchange');
        window.selectAllSharePoint = () => selectAll('sharepoint');
        window.deselectAllSharePoint = () => deselectAll('sharepoint');
        window.selectAllTeams = () => selectAll('teams');
        window.deselectAllTeams = () => deselectAll('teams');
        window.selectAllAAD = () => selectAll('aad');
        window.deselectAllAAD = () => deselectAll('aad');
        window.selectAllCompliance = () => selectAll('compliance');
        window.deselectAllCompliance = () => deselectAll('compliance');

        function selectAll(service) {
            const policyContainer = document.getElementById(service + 'Policies');
            const checkboxes = policyContainer.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.style.display !== 'none') {
                    checkbox.checked = true;
                    const policyId = checkbox.value;
                    selectedPolicies.add(policyId);
                    checkbox.closest('.policy-card').classList.add('selected');
                }
            });
            updateStats();
        }

        function deselectAll(service) {
            const policyContainer = document.getElementById(service + 'Policies');
            const checkboxes = policyContainer.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                const policyId = checkbox.value;
                selectedPolicies.delete(policyId);
                checkbox.closest('.policy-card').classList.remove('selected');
            });
            updateStats();
        }

        // Refresh functions for each service
        window.refreshIntune = () => fetchServicePolicies('intune');
        window.refreshExchange = () => fetchServicePolicies('exchange');
        window.refreshSharePoint = () => fetchServicePolicies('sharepoint');
        window.refreshTeams = () => fetchServicePolicies('teams');
        window.refreshAAD = () => fetchServicePolicies('aad');
        window.refreshCompliance = () => fetchServicePolicies('compliance');

        // Update statistics
        function updateStats() {
            let totalCount = 0;
            Object.values(allPolicies).forEach(policies => {
                totalCount += policies.length;
            });
            
            document.getElementById('totalPolicies').textContent = totalCount;
            document.getElementById('selectedPolicies').textContent = selectedPolicies.size;
            
            // Update service counts
            Object.keys(allPolicies).forEach(service => {
                const countElement = document.getElementById(service + 'Count');
                if (countElement) {
                    countElement.textContent = allPolicies[service].length;
                }
            });
        }

        // Fetch all policies
        async function fetchAllPolicies() {
            if (!accessToken) {
                alert('Please sign in first');
                return;
            }
            
            const progressSection = document.getElementById('overviewProgress');
            const progressFill = document.getElementById('overviewProgressFill');
            const progressText = document.getElementById('overviewProgressText');
            const currentServiceElement = document.getElementById('currentService');
            
            progressSection.style.display = 'block';
            
            const services = [
                { name: 'intune', display: 'Intune' },
                { name: 'exchange', display: 'Exchange' },
                { name: 'sharepoint', display: 'SharePoint' },
                { name: 'teams', display: 'Teams' },
                { name: 'aad', display: 'Azure AD' },
                { name: 'compliance', display: 'Compliance' }
            ];
            
            let completed = 0;
            const total = services.length;
            
            for (const service of services) {
                currentServiceElement.textContent = `Fetching ${service.display} policies...`;
                
                try {
                    await fetchServicePolicies(service.name);
                } catch (error) {
                    console.error(`Error fetching ${service.display} policies:`, error);
                }
                
                completed++;
                const progress = Math.round((completed / total) * 100);
                progressFill.style.width = progress + '%';
                progressText.textContent = progress + '%';
            }
            
            // Update last fetch time
            const now = new Date();
            document.getElementById('lastFetch').textContent = now.toLocaleTimeString();
            document.getElementById('servicesQueried').textContent = total;
            
            // Hide progress
            setTimeout(() => {
                progressSection.style.display = 'none';
            }, 1000);
            
            // Show summary
            showFetchSummary();
        }

        // Fetch policies for a specific service
        async function fetchServicePolicies(service) {
            if (!accessToken) return;
            
            try {
                let policies = [];
                
                switch(service) {
                    case 'intune':
                        policies = await fetchIntunePolicies();
                        break;
                    case 'exchange':
                        policies = await fetchExchangePolicies();
                        break;
                    case 'sharepoint':
                        policies = await fetchSharePointPolicies();
                        break;
                    case 'teams':
                        policies = await fetchTeamsPolicies();
                        break;
                    case 'aad':
                        policies = await fetchAADPolicies();
                        break;
                    case 'compliance':
                        policies = await fetchCompliancePolicies();
                        break;
                }
                
                allPolicies[service] = policies;
                displayPolicies(service, policies);
                updateStats();
            } catch (error) {
                console.error(`Error fetching ${service} policies:`, error);
            }
        }

        // Fetch Intune policies
        async function fetchIntunePolicies() {
            const policies = [];
            
            try {
                // Fetch configuration policies
                const configResponse = await fetch('https://graph.microsoft.com/beta/deviceManagement/configurationPolicies', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (configResponse.ok) {
                    const configData = await configResponse.json();
                    configData.value.forEach(policy => {
                        policies.push({
                            id: `intune_config_${policy.id}`,
                            name: policy.name,
                            type: 'Configuration Policy',
                            service: 'intune',
                            created: policy.createdDateTime,
                            modified: policy.lastModifiedDateTime,
                            data: policy
                        });
                    });
                }
                
                // Fetch compliance policies
                const complianceResponse = await fetch('https://graph.microsoft.com/beta/deviceManagement/deviceCompliancePolicies', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (complianceResponse.ok) {
                    const complianceData = await complianceResponse.json();
                    complianceData.value.forEach(policy => {
                        policies.push({
                            id: `intune_compliance_${policy.id}`,
                            name: policy.displayName,
                            type: 'Compliance Policy',
                            service: 'intune',
                            created: policy.createdDateTime,
                            modified: policy.lastModifiedDateTime,
                            data: policy
                        });
                    });
                }
            } catch (error) {
                console.error('Error fetching Intune policies:', error);
            }
            
            return policies;
        }

        // Fetch Exchange policies (mock implementation)
        async function fetchExchangePolicies() {
            // Note: Exchange policies would require Exchange Online PowerShell or specific Graph endpoints
            return [];
        }

        // Fetch SharePoint policies (mock implementation)
        async function fetchSharePointPolicies() {
            // Note: SharePoint policies would require SharePoint API or specific Graph endpoints
            return [];
        }

        // Fetch Teams policies (mock implementation)
        async function fetchTeamsPolicies() {
            // Note: Teams policies would require Teams PowerShell or specific Graph endpoints
            return [];
        }

        // Fetch Azure AD policies
        async function fetchAADPolicies() {
            const policies = [];
            
            try {
                // Fetch conditional access policies
                const caResponse = await fetch('https://graph.microsoft.com/v1.0/identity/conditionalAccess/policies', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (caResponse.ok) {
                    const caData = await caResponse.json();
                    caData.value.forEach(policy => {
                        policies.push({
                            id: `aad_ca_${policy.id}`,
                            name: policy.displayName,
                            type: 'Conditional Access',
                            service: 'aad',
                            created: policy.createdDateTime,
                            modified: policy.modifiedDateTime,
                            data: policy
                        });
                    });
                }
            } catch (error) {
                console.error('Error fetching Azure AD policies:', error);
            }
            
            return policies;
        }

        // Fetch Compliance policies (mock implementation)
        async function fetchCompliancePolicies() {
            // Note: Compliance policies would require specific Graph endpoints or PowerShell
            return [];
        }

        // Display policies in the UI
        function displayPolicies(service, policies) {
            const container = document.getElementById(service + 'Policies');
            container.innerHTML = '';
            
            if (policies.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <h3>No Policies Found</h3>
                        <p>No policies were found for this service</p>
                    </div>
                `;
                return;
            }
            
            policies.forEach(policy => {
                const policyCard = document.createElement('div');
                policyCard.className = 'policy-card';
                policyCard.innerHTML = `
                    <div class="policy-header">
                        <input type="checkbox" value="${policy.id}" onchange="togglePolicySelection('${policy.id}', this)">
                        <span class="policy-name">${policy.name}</span>
                        <span class="policy-type">${policy.type}</span>
                    </div>
                    <div class="policy-meta">
                        <span>Created: ${new Date(policy.created).toLocaleDateString()}</span>
                        <span>Modified: ${new Date(policy.modified).toLocaleDateString()}</span>
                    </div>
                `;
                
                container.appendChild(policyCard);
            });
        }

        // Toggle policy selection
        window.togglePolicySelection = function(policyId, checkbox) {
            if (checkbox.checked) {
                selectedPolicies.add(policyId);
                checkbox.closest('.policy-card').classList.add('selected');
            } else {
                selectedPolicies.delete(policyId);
                checkbox.closest('.policy-card').classList.remove('selected');
            }
            updateStats();
        };

        // Show fetch summary
        function showFetchSummary() {
            const summaryDiv = document.getElementById('fetchSummary');
            let summaryHTML = '<h3>Fetch Summary</h3><div class="stats-grid">';
            
            Object.keys(allPolicies).forEach(service => {
                const count = allPolicies[service].length;
                summaryHTML += `
                    <div class="stat-card">
                        <div class="stat-number">${count}</div>
                        <div class="stat-label">${service.charAt(0).toUpperCase() + service.slice(1)} Policies</div>
                    </div>
                `;
            });
            
            summaryHTML += '</div>';
            summaryDiv.innerHTML = summaryHTML;
            summaryDiv.style.display = 'block';
        }

        // Initialize export functionality
        function initializeExport() {
            // Export functionality would be implemented here
        }

        // Export selected policies
        window.exportSelected = function() {
            if (selectedPolicies.size === 0) {
                alert('Please select at least one policy to export');
                return;
            }
            
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            exportPolicies(Array.from(selectedPolicies), format);
        };

        // Export all policies
        window.exportAll = function() {
            const allPolicyIds = [];
            Object.values(allPolicies).forEach(policies => {
                policies.forEach(policy => {
                    allPolicyIds.push(policy.id);
                });
            });
            
            if (allPolicyIds.length === 0) {
                alert('No policies to export. Please fetch policies first.');
                return;
            }
            
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            exportPolicies(allPolicyIds, format);
        };

        // Download individual policy JSONs
        window.downloadIndividual = function() {
            if (selectedPolicies.size === 0) {
                alert('Please select at least one policy to download');
                return;
            }
            
            selectedPolicies.forEach(policyId => {
                const policy = findPolicyById(policyId);
                if (policy) {
                    downloadJSON(policy.data, `${policy.service}_${policy.name.replace(/[^a-z0-9]/gi, '_')}.json`);
                }
            });
        };

        // Export policies in specified format
        function exportPolicies(policyIds, format) {
            const exportData = [];
            
            policyIds.forEach(policyId => {
                const policy = findPolicyById(policyId);
                if (policy) {
                    exportData.push(policy);
                }
            });
            
            if (format === 'csv' || format === 'both') {
                exportCSV(exportData);
            }
            
            if (format === 'json' || format === 'both') {
                exportJSON(exportData);
            }
        }

        // Find policy by ID
        function findPolicyById(policyId) {
            for (const service of Object.keys(allPolicies)) {
                const policy = allPolicies[service].find(p => p.id === policyId);
                if (policy) return policy;
            }
            return null;
        }

        // Export as CSV
        function exportCSV(policies) {
            const headers = ['Service', 'Policy Name', 'Type', 'Created', 'Modified'];
            const rows = policies.map(policy => [
                policy.service,
                policy.name,
                policy.type,
                new Date(policy.created).toLocaleDateString(),
                new Date(policy.modified).toLocaleDateString()
            ]);
            
            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            downloadFile(csv, 'policies_export.csv', 'text/csv');
        }

        // Export as JSON
        function exportJSON(policies) {
            const jsonData = JSON.stringify(policies, null, 2);
            downloadFile(jsonData, 'policies_export.json', 'application/json');
        }

        // Download JSON file
        function downloadJSON(data, filename) {
            const jsonData = JSON.stringify(data, null, 2);
            downloadFile(jsonData, filename, 'application/json');
        }

        // Download file helper
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
