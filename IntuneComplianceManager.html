<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intune Compliance Manager</title>
    <style>
        /* Your existing CSS here */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #2c5aa0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: white;
            padding: 24px 32px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-icon {
            width: 24px;
            height: 24px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .header p {
            color: #6b7280;
            margin-top: 4px;
            font-size: 16px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #dc2626;
        }

        .connection-status.connected {
            color: #16a34a;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #dc2626;
        }

        .status-dot.connected {
            background-color: #16a34a;
        }

        .main-content {
            padding: 0;
        }

        .tabs {
            display: flex;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .tab {
            padding: 16px 24px;
            background: transparent;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            position: relative;
        }

        .tab:hover {
            color: #3b82f6;
        }

        .tab.active {
            color: #3b82f6;
            background: white;
            border-bottom-color: #3b82f6;
        }

        .tab-content {
            display: none;
            padding: 32px;
        }

        .tab-content.active {
            display: block;
        }

        .collapsible-section {
            background: #e3f2fd;
            border-radius: 8px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .collapsible-header {
            padding: 16px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #bbdefb;
            transition: background 0.2s;
        }

        .collapsible-header:hover {
            background: #90caf9;
        }

        .collapsible-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1565c0;
            margin: 0;
        }

        .collapsible-arrow {
            transition: transform 0.3s;
            color: #1565c0;
        }

        .collapsible-header.expanded .collapsible-arrow {
            transform: rotate(180deg);
        }

        .collapsible-content {
            display: none;
            padding: 20px;
            background: white;
        }

        .collapsible-content.show {
            display: block;
        }

        .auth-section {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e5e7eb;
        }

        .auth-section h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1a1a1a;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group small {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: #6b7280;
        }

        .status-box {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
            text-align: center;
            font-weight: 500;
        }

        .status-box.error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .status-box.success {
            background: #dcfce7;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: #5b9bd5;
            color: white;
        }

        .btn-primary:hover {
            background: #4a8bc4;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background: #94d3a2;
            color: white;
        }

        .btn-secondary:hover {
            background: #7bc48a;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-full {
            width: 100%;
            justify-content: center;
        }

        .controls {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            border: 1px solid #e5e7eb;
        }

        .control-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .control-group input,
        .control-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th {
            background: #f9fafb;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .status-compliant {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-noncompliant {
            background: #fee2e2;
            color: #dc2626;
        }

        .status-unknown {
            background: #fef3c7;
            color: #d97706;
        }

        .status-pending {
            background: #dbeafe;
            color: #2563eb;
        }

        .chart-container {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            border: 1px solid #e5e7eb;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1a1a1a;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            display: flex;
            margin-bottom: 20px;
        }

        .progress-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .progress-segment.compliant {
            background: #16a34a;
        }

        .progress-segment.noncompliant {
            background: #dc2626;
        }

        .progress-segment.unknown {
            background: #d97706;
        }

        .progress-segment.pending {
            background: #2563eb;
        }

        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            background: #f9fafb;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .modal-body {
            padding: 24px;
            max-height: calc(85vh - 70px);
            overflow-y: auto;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .detail-grid {
            display: grid;
            gap: 16px;
        }

        .detail-item {
            display: grid;
            grid-template-columns: 160px 1fr;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            font-size: 14px;
        }

        .detail-label {
            font-weight: 600;
            color: #4b5563;
        }

        .info-notice {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            color: #92400e;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .info-notice strong {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .info-notice ul {
            margin-left: 20px;
            margin-top: 8px;
        }

        .info-notice li {
            margin-bottom: 4px;
        }

        .export-menu {
            position: relative;
            display: inline-block;
        }

        .export-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 150px;
            z-index: 100;
            margin-top: 4px;
        }

        .export-dropdown.show {
            display: block;
        }

        .export-dropdown a {
            display: block;
            padding: 10px 16px;
            color: #374151;
            text-decoration: none;
            font-size: 14px;
            transition: background 0.2s;
        }

        .export-dropdown a:hover {
            background: #f3f4f6;
        }

        .redirect-uri-box {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
        }

        .redirect-uri-display {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .copy-btn {
            padding: 6px 12px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
            transition: background 0.2s;
        }

        .copy-btn:hover {
            background: #2563eb;
        }

        .compliance-details-notice {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            color: #1e40af;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
        }

        .platform-card {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .platform-name {
            font-weight: 600;
            color: #1a1a1a;
        }

        .platform-stats {
            display: flex;
            gap: 16px;
            font-size: 14px;
        }

        .platform-stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .conflict-item {
            background: #fee2e2;
            border: 1px solid #fecaca;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .conflict-header {
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 8px;
        }

        .conflict-details {
            font-size: 14px;
            color: #7f1d1d;
            line-height: 1.6;
        }

        .policy-tag {
            display: inline-block;
            padding: 4px 8px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 6px;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-success {
            background: #16a34a;
            color: white;
        }

        .notification-error {
            background: #dc2626;
            color: white;
        }

        .notification-warning {
            background: #d97706;
            color: white;
        }

        .notification-info {
            background: #3b82f6;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 8px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .control-row {
                flex-direction: column;
            }

            .control-group {
                width: 100%;
            }

            .stats-container {
                grid-template-columns: 1fr 1fr;
            }

            .data-table {
                font-size: 13px;
            }

            .data-table th,
            .data-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="mainAppContainer" style="display: none;">
        <div class="header">
            <div class="header-content">
                <svg class="header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path>
                </svg>
                <div>
                    <h1>Intune Compliance Manager</h1>
                    <p>Monitor and manage device compliance and application deployment status</p>
                </div>
            </div>
            <div class="connection-status" id="connectionStatus">
                <span class="status-dot"></span>
                <span>Disconnected</span>
            </div>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')">Overview</button>
                <button class="tab" onclick="switchTab('compliance')">Compliance</button>
                <button class="tab" onclick="switchTab('applications')">Applications</button>
                <button class="tab" onclick="switchTab('policies')">Policies</button>
                <button class="tab" onclick="switchTab('dashboard')">Dashboard</button>
                <button class="tab" onclick="switchTab('export')">Export</button>
            </div>

            <div class="tab-content active" id="overviewTab">
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <h3>How to Get Your Entra ID Client ID</h3>
                        <span class="collapsible-arrow">▼</span>
                    </div>
                    <div class="collapsible-content">
                        <h4 style="margin-bottom: 16px; color: #1565c0;">Step 1: Register an Application in Azure AD</h4>
                        <ol style="margin-left: 20px; line-height: 1.8;">
                            <li>Go to the <a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank" style="color: #3b82f6;">Azure Portal - App Registrations</a></li>
                            <li>Click <strong>New registration</strong></li>
                            <li>Configure the application:
                                <ul style="margin-top: 8px; margin-left: 20px;">
                                    <li><strong>Name:</strong> Intune Compliance Manager</li>
                                    <li><strong>Supported account types:</strong> Accounts in this organizational directory only</li>
                                    <li><strong>Redirect URI:</strong> Single-page application (SPA)</li>
                                </ul>
                            </li>
                            <li>Add this redirect URI:
                                <div class="redirect-uri-box">
                                    <strong>Important:</strong> Copy and add this exact URI to your app registration:
                                    <div class="redirect-uri-display">
                                        <span id="redirectUri"></span>
                                        <button class="copy-btn" onclick="copyRedirectUri()">Copy</button>
                                    </div>
                                </div>
                            </li>
                            <li>Click <strong>Register</strong></li>
                        </ol>

                        <h4 style="margin: 20px 0 16px; color: #1565c0;">Step 2: Configure API Permissions</h4>
                        <ol style="margin-left: 20px; line-height: 1.8;">
                            <li>In your app registration, go to <strong>API permissions</strong></li>
                            <li>Click <strong>Add a permission</strong> → <strong>Microsoft Graph</strong> → <strong>Delegated permissions</strong></li>
                            <li>Add these permissions:
                                <ul style="margin-top: 8px; margin-left: 20px;">
                                    <li><code style="background: #f3f4f6; padding: 2px 6px; border-radius: 3px;">User.Read</code> - Sign in and read user profile</li>
                                    <li><code style="background: #f3f4f6; padding: 2px 6px; border-radius: 3px;">DeviceManagementManagedDevices.Read.All</code> - Read device compliance data</li>
                                    <li><code style="background: #f3f4f6; padding: 2px 6px; border-radius: 3px;">DeviceManagementApps.Read.All</code> - Read application data</li>
                                    <li><code style="background: #f3f4f6; padding: 2px 6px; border-radius: 3px;">DeviceManagementConfiguration.Read.All</code> - Read device configuration and compliance policies</li>
                                    <li><code style="background: #f3f4f6; padding: 2px 6px; border-radius: 3px;">DeviceManagementServiceConfig.Read.All</code> - Read Intune service configuration</li>
                                    <li><code style="background: #f3f4f6; padding: 2px 6px; border-radius: 3px;">DeviceManagementRBAC.Read.All</code> - Read role-based access control settings</li>
                                </ul>
                            </li>
                            <li>Click <strong>Grant admin consent</strong> (requires admin rights)</li>
                        </ol>

                        <h4 style="margin: 20px 0 16px; color: #1565c0;">Step 3: Get Your Application Details</h4>
                        <ol style="margin-left: 20px; line-height: 1.8;">
                            <li>Go to the <strong>Overview</strong> page of your app registration</li>
                            <li>Copy the <strong>Application (client) ID</strong></li>
                        </ol>
                    </div>
                </div>

                <div class="auth-section">
                    <h2>Authentication</h2>
                    <div class="form-group">
                        <label for="clientId">Entra ID Client ID:</label>
                        <input type="text" id="clientId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                        <small>Enter your Entra ID application Client ID</small>
                    </div>
                    <div class="status-box error" id="authStatus">
                        Not connected to Microsoft Graph
                    </div>
                    <button class="btn btn-primary btn-full" id="authBtn" onclick="handleAuth()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M7.05 0v3.56H3.56V0H7.05zm0 4.27v3.56H3.56V4.27H7.05zm4.27-4.27v3.56H7.84V0h3.48zm0 4.27v3.56H7.84V4.27h3.48zM7.05 8.53v3.56H3.56V8.53H7.05zm0 4.27V16H3.56v-3.2H7.05zm4.27-4.27v3.56H7.84V8.53h3.48zm0 4.27V16H7.84v-3.2h3.48z"/>
                        </svg>
                        Sign in with Microsoft
                    </button>
                </div>

                <div class="stats-container" id="summaryStats" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-value" id="totalDevices">-</div>
                        <div class="stat-label">Total Devices</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="compliantDevices">-</div>
                        <div class="stat-label">Compliant</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalApps">-</div>
                        <div class="stat-label">Applications</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="lastSync">-</div>
                        <div class="stat-label">Last Refresh</div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="complianceTab">
                <div class="compliance-details-notice">
                    <strong>Note:</strong> Some devices may not show specific compliance policy violations. This can occur when:
                    • The device hasn't synced recently • Compliance evaluation is in progress • Additional permissions are required
                    • The device is managed by Configuration Manager
                </div>

                <div class="controls">
                    <div class="control-row">
                        <div class="control-group">
                            <label>Search Devices</label>
                            <input type="text" id="deviceSearch" placeholder="Search by device name or user..." oninput="filterDevices()">
                        </div>
                        <div class="control-group">
                            <label>Compliance Status</label>
                            <select id="complianceFilter" onchange="filterDevices()">
                                <option value="all">All Devices</option>
                                <option value="compliant">Compliant</option>
                                <option value="noncompliant">Non-Compliant</option>
                                <option value="unknown">Unknown</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Platform</label>
                            <select id="platformFilter" onchange="filterDevices()">
                                <option value="all">All Platforms</option>
                                <option value="windows">Windows</option>
                                <option value="ios">iOS</option>
                                <option value="android">Android</option>
                                <option value="macos">macOS</option>
                            </select>
                        </div>
                    </div>
                    <div class="control-row">
                        <button class="btn btn-primary" onclick="refreshComplianceData()" id="refreshComplianceBtn" disabled>
                            Refresh Data
                        </button>
                        <div class="export-menu">
                            <button class="btn btn-secondary" onclick="toggleExportMenu('compliance')" disabled id="exportComplianceBtn">
                                Export ▼
                            </button>
                            <div class="export-dropdown" id="complianceExportMenu">
                                <a href="#" onclick="exportData('compliance', 'csv')">Export as CSV</a>
                                <a href="#" onclick="exportData('compliance', 'json')">Export as JSON</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Compliance Overview</div>
                    <div class="progress-bar" id="complianceChart">
                        <div class="progress-segment compliant" style="width: 25%">-</div>
                        <div class="progress-segment noncompliant" style="width: 25%">-</div>
                        <div class="progress-segment unknown" style="width: 25%">-</div>
                        <div class="progress-segment pending" style="width: 25%">-</div>
                    </div>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #16a34a;"></div>
                            <span>Compliant</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #dc2626;"></div>
                            <span>Non-Compliant</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #d97706;"></div>
                            <span>Unknown</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2563eb;"></div>
                            <span>Pending</span>
                        </div>
                    </div>
                </div>

                <div class="loading" id="complianceLoading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading compliance data...</p>
                </div>

                <div id="complianceTableContainer" style="display: none;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Device Name</th>
                                <th>User</th>
                                <th>Platform</th>
                                <th>Compliance Status</th>
                                <th>Last Check-in</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="complianceTableBody">
                        </tbody>
                    </table>
                </div>

                <div class="empty-state" id="complianceEmpty">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3>No compliance data available</h3>
                    <p>Sign in and click "Refresh Data" to load device compliance information</p>
                </div>
            </div>

            <div class="tab-content" id="applicationsTab">
                <div class="info-notice">
                    <strong>Note about Application Deployment Data:</strong>
                    Microsoft Graph API has limitations for application deployment statistics. The data shown here represents the applications configured in Intune.
                    <ul>
                        <li>For detailed deployment statistics, use the Intune portal directly</li>
                        <li>Use "Device Install Status" view to see actual installed applications</li>
                        <li>Some deployment data requires additional API permissions</li>
                    </ul>
                </div>

                <div class="controls">
                    <div class="control-row">
                        <div class="control-group">
                            <label>Search Applications</label>
                            <input type="text" id="appSearch" placeholder="Search by app name or publisher..." oninput="filterApplications()">
                        </div>
                        <div class="control-group">
                            <label>Application Type</label>
                            <select id="appTypeFilter" onchange="filterApplications()">
                                <option value="all">All Types</option>
                                <option value="win32">Win32</option>
                                <option value="msi">MSI</option>
                                <option value="microsoft">Microsoft Store</option>
                                <option value="android">Android</option>
                                <option value="ios">iOS</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>View Mode</label>
                            <select id="viewMode" onchange="changeViewMode()">
                                <option value="summary">Application Summary</option>
                                <option value="deviceStatus">Device Install Status</option>
                            </select>
                        </div>
                    </div>
                    <div class="control-row">
                        <button class="btn btn-primary" onclick="refreshApplicationData()" id="refreshAppsBtn" disabled>
                            Refresh Data
                        </button>
                        <button class="btn btn-secondary" onclick="fetchDeviceInstallStatus()" id="fetchDeviceStatusBtn" disabled style="display: none;">
                            Fetch Device Status
                        </button>
                        <div class="export-menu">
                            <button class="btn btn-secondary" onclick="toggleExportMenu('applications')" disabled id="exportAppsBtn">
                                Export ▼
                            </button>
                            <div class="export-dropdown" id="applicationsExportMenu">
                                <a href="#" onclick="exportData('applications', 'csv')">Export as CSV</a>
                                <a href="#" onclick="exportData('applications', 'json')">Export as JSON</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="loading" id="applicationsLoading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading application data...</p>
                </div>

                <div id="applicationsTableContainer" style="display: none;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Application Name</th>
                                <th>Publisher</th>
                                <th>Version</th>
                                <th>Type</th>
                                <th>Created</th>
                                <th>Modified</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="applicationsTableBody">
                        </tbody>
                    </table>
                </div>

                <div id="deviceStatusTableContainer" style="display: none;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Device Name</th>
                                <th>User</th>
                                <th>Application</th>
                                <th>Install State</th>
                                <th>Version</th>
                                <th>Size</th>
                            </tr>
                        </thead>
                        <tbody id="deviceStatusTableBody">
                        </tbody>
                    </table>
                </div>

                <div class="empty-state" id="applicationsEmpty">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                    </svg>
                    <h3>No application data available</h3>
                    <p>Sign in and click "Refresh Data" to load application information</p>
                </div>
            </div>

            <div class="tab-content" id="policiesTab">
                <div class="controls">
                    <div class="control-row">
                        <button class="btn btn-primary" onclick="refreshPolicyData()" id="refreshPoliciesBtn" disabled>
                            Load Configuration Policies
                        </button>
                        <button class="btn btn-secondary" onclick="loadPolicyDeviceStatus()" id="loadDeviceStatusBtn" disabled style="display: none;">
                            Load Device Status
                        </button>
                        <div class="export-menu">
                            <button class="btn btn-secondary" onclick="toggleExportMenu('policies')" disabled id="exportPoliciesBtn">
                                Export ▼
                            </button>
                            <div class="export-dropdown" id="policiesExportMenu">
                                <a href="#" onclick="exportData('policies', 'csv')">Export as CSV</a>
                                <a href="#" onclick="exportData('policies', 'json')">Export as JSON</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="loading" id="policiesLoading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading configuration policies...</p>
                </div>

                <div id="policiesTableContainer" style="display: none;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Policy Name</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Platform</th>
                                <th>Assigned Devices</th>
                                <th>Success Rate</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="policiesTableBody">
                        </tbody>
                    </table>
                </div>

                <div id="policyDeviceStatusContainer" style="display: none; margin-top: 24px;">
                    <div class="chart-container">
                        <div class="chart-title" id="policyDeviceStatusTitle">Device Status</div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Device Name</th>
                                    <th>User</th>
                                    <th>Status</th>
                                    <th>Last Reported</th>
                                    <th>Failed Settings</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="policyDeviceStatusBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="empty-state" id="policiesEmpty">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <h3>No policy data available</h3>
                    <p>Click "Load Configuration Policies" to view configuration policies</p>
                </div>
            </div>

            <div class="tab-content" id="dashboardTab">
                <div class="chart-container">
                    <div class="chart-title">Executive Compliance Dashboard</div>
                    <div class="stats-container" id="dashboardStats">
                        <div class="stat-card">
                            <div class="stat-value" id="dashComplianceRate">-</div>
                            <div class="stat-label">Overall Compliance Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="dashNonCompliant">-</div>
                            <div class="stat-label">Non-Compliant Devices</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="dashTotalPolicies">-</div>
                            <div class="stat-label">Configuration Policies</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="dashLastUpdate">-</div>
                            <div class="stat-label">Last Update</div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Compliance by Platform</div>
                    <div id="platformBreakdown" style="padding: 20px;">
                        <div class="empty-state">
                            <p>Load compliance data to view platform breakdown</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Policy Application Success Rate</div>
                    <div id="policySuccessRate" style="padding: 20px;">
                        <div class="empty-state">
                            <p>Load policy data to view success rates</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Top Failed Policies</div>
                    <div id="topFailedPolicies" style="padding: 20px;">
                        <div class="empty-state">
                            <p>Load policy data to view failed policies</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Recent Non-Compliant Devices</div>
                    <div id="nonCompliantDevicesList" style="padding: 20px;">
                        <div class="empty-state">
                            <p>Load compliance data to view non-compliant devices</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Device Sync Status (Last 7 Days)</div>
                    <div id="syncStatusBreakdown" style="padding: 20px;">
                        <div class="empty-state">
                            <p>Load compliance data to view sync status</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="exportTab">
                <div class="auth-section">
                    <h2>Export Options</h2>
                    <p style="margin-bottom: 20px; color: #6b7280;">Choose what data to export and in which format.</p>
                    
                    <div style="margin-bottom: 24px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 12px;">Select Data to Export:</label>
                        <div class="checkbox-group" style="display: flex; flex-direction: column; gap: 10px;">
                            <div class="checkbox-item">
                                <input type="checkbox" id="exportCompliance" checked>
                                <label for="exportCompliance">Device Compliance Data</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exportApplications" checked>
                                <label for="exportApplications">Application Inventory</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exportPolicies" checked>
                                <label for="exportPolicies">Configuration Policies</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exportConfigurations" checked>
                                <label for="exportConfigurations">Device Configurations</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exportDashboard">
                                <label for="exportDashboard">Dashboard Summary (PDF only)</label>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 16px;">
                        <button class="btn btn-primary btn-full" onclick="exportSelectedData('json')" id="exportJsonBtn" disabled>
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                            </svg>
                            Export Selected as JSON
                        </button>
                        
                        <button class="btn btn-secondary btn-full" onclick="exportSelectedData('csv')" id="exportCsvBtn" disabled>
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                            </svg>
                            Export Selected as CSV
                        </button>
                        
                        <button class="btn btn-primary btn-full" onclick="exportDashboardPDF()" id="exportPdfBtn" disabled style="background: #dc2626;">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                            </svg>
                            Export Dashboard as PDF
                        </button>
                    </div>
                    
                    <div class="info-notice" style="margin-top: 24px;">
                        <strong>Export Options:</strong>
                        <ul>
                            <li><strong>JSON:</strong> Complete data with all fields and metadata</li>
                            <li><strong>CSV:</strong> Tabular format for Excel/spreadsheet analysis</li>
                            <li><strong>PDF:</strong> Dashboard summary report with charts and statistics</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>

    <div id="initialLoadingScreen" style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #2c5aa0; color: white; flex-direction: column;">
        <div class="spinner"></div>
        <p style="margin-top: 20px; font-size: 18px;">Initializing application...</p>
    </div>

    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>

    <script>
        // ADD THE PASSWORD SECURITY CODE HERE - BEFORE ANYTHING ELSE
        // Secure Password Protection with SHA-256 Hashing
        const PASSWORD_HASH = '9e5c3ce7906db8e6f333df0e10deed2263b0a8738a9abe3f3612b8f52846689e';

        async function authenticateUser() {
            const maxAttempts = 3;
            let attempts = 0;
            let authorized = false;

            while (attempts < maxAttempts && !authorized) {
                const password = prompt(
                    `🔒 Intune Policy Manager - Secure Access\n\n` +
                    `Enter password (${maxAttempts - attempts} attempt${attempts === 2 ? '' : 's'} remaining):`
                );

                // User clicked cancel
                if (password === null) {
                    showAccessDenied('Authentication cancelled');
                    throw new Error('Access cancelled by user');
                }

                // Hash the entered password and compare
                const enteredHash = await hashPassword(password);

                if (enteredHash === PASSWORD_HASH) {
                    authorized = true;
                    sessionStorage.setItem('intunePolicyManagerAuth', 'true');

                    // Add session timeout (2 hours)
                    sessionStorage.setItem('authExpiry', Date.now() + (2 * 60 * 60 * 1000));
                } else {
                    attempts++;
                    if (attempts < maxAttempts) {
                        alert(`❌ Incorrect password.\n\n${maxAttempts - attempts} attempt${attempts === 2 ? '' : 's'} remaining.`);
                    }
                }
            }

            if (!authorized) {
                showAccessDenied('Maximum password attempts exceeded');
                throw new Error('Unauthorized - Maximum attempts exceeded');
            }
        }

        // SHA-256 hashing function
        async function hashPassword(password) {
            const msgUint8 = new TextEncoder().encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        function showAccessDenied(message) {
            document.body.innerHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Access Denied</title>
                </head>
                <body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);">
                        <div style="text-align: center; background: white; padding: 60px 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 450px; margin: 20px;">
                            <h1 style="color: #1a1a1a; margin-bottom: 25px; font-size: 36px; font-weight: 700; font-style: italic;">No HAM for you...</h1>
                            
                            <div style="margin: 30px 0;">
                                <img src="https://luiserodz.github.io/theHAM/Ham.jpg" 
                                    alt="No Ham for You" 
                                    style="max-width: 300px; width: 100%; height: auto; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);">
                            </div>
                            
                            <p style="color: #666; margin-bottom: 10px; font-size: 18px; line-height: 1.5;">${message}</p>
                            
                            <div style="margin-top: 35px; padding-top: 25px; border-top: 1px solid #eee;">
                                <p style="color: #999; font-size: 15px;">Please contact support for access credentials.</p>
                                <p style="color: #bbb; font-size: 13px; margin-top: 15px;">Intune Policy Manager</p>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
        }

        // --- Start of general app logic after password check ---

        // Function to show the main application and hide the loading screen
        function showMainApplication() {
            document.getElementById('initialLoadingScreen').style.display = 'none';
            document.getElementById('mainAppContainer').style.display = 'block';
        }

        // Check session expiry on each load
        function checkSessionExpiry() {
            const authExpiry = sessionStorage.getItem('authExpiry');
            if (authExpiry && Date.now() > parseInt(authExpiry)) {
                sessionStorage.removeItem('intunePolicyManagerAuth');
                sessionStorage.removeItem('authExpiry');
                // Reload to re-trigger authentication
                location.reload();
                return true; // Session expired
            }
            return false; // Session still valid or no session
        }

        // Auto-logout on inactivity (30 minutes)
        let inactivityTimer;
        const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutes

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                sessionStorage.removeItem('intunePolicyManagerAuth');
                sessionStorage.removeItem('authExpiry');
                alert('⏱️ Session expired due to inactivity.\n\nPlease refresh the page to log in again.');
                location.reload();
            }, INACTIVITY_TIMEOUT);
        }

        // Execute when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', async function() {
    // Check for authentication first
    if (!checkSessionExpiry() && sessionStorage.getItem('intunePolicyManagerAuth')) {
        // If already authenticated in this session, show the app immediately
        showMainApplication();
    } else {
        // If not authenticated, run the password prompt
        try {
            await authenticateUser();
            showMainApplication();
        } catch (error) {
            console.error("Authentication failed:", error.message);
            // showAccessDenied() handles displaying the appropriate screen
            return; // Stop further script execution if authentication failed
        }
    }

    console.log('Intune Compliance Manager initializing...');

    // Start inactivity timer if authenticated and main app is shown
    if (sessionStorage.getItem('intunePolicyManagerAuth')) {
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        document.addEventListener('scroll', resetInactivityTimer);
        document.addEventListener('mousemove', resetInactivityTimer);
        resetInactivityTimer();
    }

    const redirectUri = window.location.origin + window.location.pathname;
    document.getElementById('redirectUri').textContent = redirectUri;

    const clientIdInput = document.getElementById('clientId');
    clientIdInput.value = '';

    clientIdInput.addEventListener('input', function() {
        const clientId = this.value.trim();
        if (clientId && clientId.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)) {
            localStorage.setItem('intuneComplianceClientId', clientId);
            initializeMSAL(clientId);
        }
    });
    console.log('Intune Compliance Manager initializing...');
    // Check for existing token from previous session
    if (checkExistingToken()) {
        console.log('Found existing token, auto-loading data...');
        // Auto-load data if we have a valid token
        setTimeout(() => {
            refreshComplianceData();
            refreshPolicyData();
            refreshApplicationData();
        }, 1000);
    }

    // Also check if we have a saved client ID
    const savedClientId = localStorage.getItem('intuneComplianceClientId');
    if (savedClientId && !clientIdInput.value) {
        clientIdInput.value = savedClientId;
        initializeMSAL(savedClientId);
    }
            
    // Start inactivity timer if authenticated and main app is shown
    if (sessionStorage.getItem('intunePolicyManagerAuth')) {
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        document.addEventListener('scroll', resetInactivityTimer);
        document.addEventListener('mousemove', resetInactivityTimer);
        resetInactivityTimer();
    }

    // Don't check for saved config initially - let user enter it
    // const savedClientId = localStorage.getItem('intuneComplianceClientId');
    // if (savedClientId) {
    //     document.getElementById('clientId').value = savedClientId;
    //     initializeMSAL(savedClientId);
    // } else {
    //     // Ensure the clientId input is enabled if no saved ID
    //     document.getElementById('clientId').disabled = false;
    // }
});

// Notification system
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            // Add icon based on type
            const icons = {
                success: '✓',
                error: '✗',
                warning: '⚠',
                info: 'ℹ'
            };
            
            notification.innerHTML = `
                <span style="font-size: 20px; margin-right: 10px;">${icons[type]}</span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after duration
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, duration);
            
            // Allow click to dismiss
            notification.addEventListener('click', () => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            });
        }

// Rate limiting helper function
        async function fetchWithRateLimit(requests, limit = 5, delayMs = 1000) {
            const results = [];
            let successCount = 0;
            let failureCount = 0;
            
            for (let i = 0; i < requests.length; i += limit) {
                const batch = requests.slice(i, i + limit);
                
                // Show progress
                const progress = Math.min(i + limit, requests.length);
                showNotification(`Processing ${progress} of ${requests.length} requests...`, 'info', 2000);
                
                const batchResults = batch ? await Promise.allSettled(batch.map(req => req())) : [];
                
                // Process results
                batchResults.forEach(result => {
                    if (result.status === 'fulfilled') {
                        results.push(result.value);
                        successCount++;
                    } else {
                        results.push(null);
                        failureCount++;
                        console.error('Request failed:', result.reason);
                    }
                });
                
                // Wait between batches to avoid rate limiting
                if (i + limit < requests.length) {
                    await new Promise(resolve => setTimeout(resolve, delayMs));
                }
            }
            
            // Show completion summary
            if (failureCount > 0) {
                showNotification(`Completed with ${successCount} successes and ${failureCount} failures`, 'warning');
            }
            
            return results;
        }
        
        // Toggle collapsible section
        function toggleCollapsible(header) {
            header.classList.toggle('expanded');
            const content = header.nextElementSibling;
            content.classList.toggle('show');
        }

        // Copy redirect URI
        function copyRedirectUri() {
            const redirectUri = document.getElementById('redirectUri').textContent;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(redirectUri).then(() => {
                    showCopySuccess();
                }).catch(() => {
                    fallbackCopy(redirectUri);
                });
            } else {
                fallbackCopy(redirectUri);
            }
        }

        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                showCopySuccess();
            } catch (err) {
                alert('Please manually copy the redirect URI');
            }
            
            document.body.removeChild(textArea);
        }

        function showCopySuccess() {
            const btn = document.querySelector('.copy-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            btn.style.background = '#16a34a';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#3b82f6';
            }, 2000);
        }

        // Global token storage
        window.accessToken = null;
        let accessToken = null;

        // Global variables
        let msalInstance = null;
        let account = null;
        let complianceData = [];
        let applicationData = [];
        let policyData = [];
        let configurationProfiles = [];
        let adminTemplates = [];
        let settingsCatalog = [];
        let policyDeviceStates = {}; // Store device states for each policy
        let filteredComplianceData = [];
        let filteredApplicationData = [];
        let deviceInstallStates = [];

// Memory management
        const MAX_CACHED_POLICIES = 100;
        const MAX_DEVICE_STATES_PER_POLICY = 500;
        let dataRefreshTimestamps = {
            compliance: null,
            applications: null,
            policies: null,
            deviceStates: null
        };
        
        // Cleanup function to prevent memory leaks
        function cleanupOldData() {
            console.log('Running data cleanup...');
            
            // Clean up old policy device states
            const policyIds = Object.keys(policyDeviceStates);
            if (policyIds.length > MAX_CACHED_POLICIES) {
                // Remove oldest entries
                const sortedIds = policyIds.sort((a, b) => {
                    const timeA = dataRefreshTimestamps[a] || 0;
                    const timeB = dataRefreshTimestamps[b] || 0;
                    return timeA - timeB;
                });
                
                const idsToRemove = sortedIds.slice(0, policyIds.length - MAX_CACHED_POLICIES);
                idsToRemove.forEach(id => {
                    delete policyDeviceStates[id];
                    delete dataRefreshTimestamps[id];
                });
                
                console.log(`Removed ${idsToRemove.length} old policy device states`);
            }
            
            // Limit device states per policy
            Object.keys(policyDeviceStates).forEach(policyId => {
                if (policyDeviceStates[policyId].length > MAX_DEVICE_STATES_PER_POLICY) {
                    policyDeviceStates[policyId] = policyDeviceStates[policyId].slice(0, MAX_DEVICE_STATES_PER_POLICY);
                }
            });
            
            // Clear old device install states if too large
            if (deviceInstallStates.length > 1000) {
                deviceInstallStates = deviceInstallStates.slice(0, 1000);
                showNotification('Device install states truncated to prevent memory issues', 'info');
            }
        }
        
        // Run cleanup every 5 minutes
        setInterval(cleanupOldData, 5 * 60 * 1000);
        
        // Initialize MSAL
        function initializeMSAL(clientId) {
            const msalConfig = {
                auth: {
                    clientId: clientId,
                    authority: 'https://login.microsoftonline.com/common',
                    redirectUri: window.location.origin + window.location.pathname
                },
                cache: {
                    cacheLocation: 'localStorage',
                    storeAuthStateInCookie: false
                }
            };

            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                msalInstance.initialize().then(() => {
                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length > 0) {
                        account = accounts[0];
                        updateUI();
                    }
                });
            } catch (error) {
                console.error('MSAL initialization error:', error);
                alert('Failed to initialize authentication. Please check your configuration.');
            }
        }

        // Client ID input handling
        document.addEventListener('DOMContentLoaded', function() {
            const clientIdInput = document.getElementById('clientId');
            
            // Don't load saved Client ID - start with blank field
            clientIdInput.value = '';
            
            clientIdInput.addEventListener('input', function() {
                const clientId = this.value.trim();
                if (clientId && clientId.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)) {
                    localStorage.setItem('intuneComplianceClientId', clientId);
                    initializeMSAL(clientId);
                }
            });
        });

        // Authentication handling
        function handleAuth() {
            if (account) {
                logout();
            } else {
                const clientId = document.getElementById('clientId').value.trim();
                if (!clientId) {
                    showNotification('Please enter your Entra ID Client ID first', 'warning');
                    return;
                }
                
                if (!msalInstance) {
                    initializeMSAL(clientId);
                    setTimeout(() => login(), 500);
                } else {
                    login();
                }
            }
        }

        async function login() {
            if (!msalInstance) {
                showNotification('Please enter a valid Client ID', 'warning');
                return;
            }

            try {
                const loginRequest = {
                    scopes: ['User.Read', 'DeviceManagementManagedDevices.Read.All', 'DeviceManagementApps.Read.All', 'DeviceManagementConfiguration.Read.All']
                };
                
                const response = await msalInstance.loginPopup(loginRequest);
                handleResponse(response);
            } catch (error) {
                console.error('Login failed:', error);
                showNotification('Login failed. Please try again.', 'error');
            }
        }

        function logout() {
            // Show notification
            showNotification('Signing out and clearing all data...', 'info');
            
            // Clear the saved Client ID from localStorage
            localStorage.removeItem('intuneComplianceClientId');
            
            // Clear the Client ID input field
            const clientIdInput = document.getElementById('clientId');
            if (clientIdInput) {
                clientIdInput.value = '';
                clientIdInput.disabled = false;
                clientIdInput.style.borderColor = '#d1d5db';
            }
            
            // Clear all data arrays
            complianceData = [];
            applicationData = [];
            policyData = [];
            configurationProfiles = [];
            adminTemplates = [];
            settingsCatalog = [];
            policyDeviceStates = {};
            filteredComplianceData = [];
            filteredApplicationData = [];
            deviceInstallStates = [];
            dataRefreshTimestamps = {
                compliance: null,
                applications: null,
                policies: null,
                deviceStates: null
            };
            
            // Clear all UI elements
            document.getElementById('complianceTableBody').innerHTML = '';
            document.getElementById('applicationsTableBody').innerHTML = '';
            document.getElementById('policiesTableBody').innerHTML = '';
            document.getElementById('deviceStatusTableBody').innerHTML = '';
            document.getElementById('policyDeviceStatusBody').innerHTML = '';
            
            // Reset summary stats
            document.getElementById('totalDevices').textContent = '-';
            document.getElementById('compliantDevices').textContent = '-';
            document.getElementById('totalApps').textContent = '-';
            document.getElementById('lastSync').textContent = '-';
            
            // Hide data containers
            document.getElementById('complianceTableContainer').style.display = 'none';
            document.getElementById('applicationsTableContainer').style.display = 'none';
            document.getElementById('policiesTableContainer').style.display = 'none';
            document.getElementById('policyDeviceStatusContainer').style.display = 'none';
            
            // Show empty states
            document.getElementById('complianceEmpty').style.display = 'block';
            document.getElementById('applicationsEmpty').style.display = 'block';
            document.getElementById('policiesEmpty').style.display = 'block';
            
            // Perform the logout
            const logoutRequest = {
                account: msalInstance.getAccountByHomeId(account.homeAccountId)
            };
            
            // Clear account before logout
            account = null;
            
            msalInstance.logout(logoutRequest);
        }

            function handleResponse(response) {
        // Store account
        account = response.account;
        
        // Store token in multiple places
        window.accessToken = response.accessToken; // Store globally
        accessToken = response.accessToken; // Store in local variable
        
        // Save to sessionStorage as backup
        sessionStorage.setItem('intuneAccessToken', response.accessToken);
        sessionStorage.setItem('intuneAccount', JSON.stringify(response.account)); // ADD THIS LINE
        
        console.log('Token stored successfully:', accessToken ? 'Token present' : 'No token!');
        
        // Update UI
        updateUI();
        
        // If we have a token, start loading data automatically
        if (accessToken) {
            console.log('Auto-loading data after authentication...');
            setTimeout(() => {
                refreshComplianceData();
                refreshPolicyData();      // Correct function name
                refreshApplicationData(); // Correct function name
            }, 500);
        }
    }
            function updateUI() {
                const authBtn = document.getElementById('authBtn');
            const authStatus = document.getElementById('authStatus');
            const connectionStatus = document.getElementById('connectionStatus');
            
            if (account) {
                authBtn.innerHTML = `
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M7.05 0v3.56H3.56V0H7.05zm0 4.27v3.56H3.56V4.27H7.05zm4.27-4.27v3.56H7.84V0h3.48zm0 4.27v3.56H7.84V4.27h3.48zM7.05 8.53v3.56H3.56V8.53H7.05zm0 4.27V16H3.56v-3.2H7.05zm4.27-4.27v3.56H7.84V8.53h3.48zm0 4.27V16H7.84v-3.2h3.48z"/>
                    </svg>
                    Sign Out
                `;
                
                authStatus.className = 'status-box success';
                authStatus.textContent = `Connected as: ${account.username}`;
                
                connectionStatus.innerHTML = `
                    <span class="status-dot connected"></span>
                    <span>Connected</span>
                `;
                connectionStatus.className = 'connection-status connected';
                
                // Enable buttons
                document.getElementById('refreshComplianceBtn').disabled = false;
                document.getElementById('refreshAppsBtn').disabled = false;
                document.getElementById('exportComplianceBtn').disabled = false;
                document.getElementById('exportAppsBtn').disabled = false;
                document.getElementById('fetchDeviceStatusBtn').disabled = false;
                document.getElementById('exportJsonBtn').disabled = false;
                document.getElementById('exportCsvBtn').disabled = false;
                document.getElementById('exportPdfBtn').disabled = false;
                document.getElementById('refreshPoliciesBtn').disabled = false;
                document.getElementById('exportPoliciesBtn').disabled = false;
                document.getElementById('loadDeviceStatusBtn').disabled = false;
                
                // Show summary stats
                document.getElementById('summaryStats').style.display = 'grid';
            } else {
                authBtn.innerHTML = `
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M7.05 0v3.56H3.56V0H7.05zm0 4.27v3.56H3.56V4.27H7.05zm4.27-4.27v3.56H7.84V0h3.48zm0 4.27v3.56H7.84V4.27h3.48zM7.05 8.53v3.56H3.56V8.53H7.05zm0 4.27V16H3.56v-3.2H7.05zm4.27-4.27v3.56H7.84V8.53h3.48zm0 4.27V16H7.84v-3.2h3.48z"/>
                    </svg>
                    Sign in with Microsoft
                `;
                
                authStatus.className = 'status-box error';
                authStatus.textContent = 'Not connected to Microsoft Graph';
                
                connectionStatus.innerHTML = `
                    <span class="status-dot"></span>
                    <span>Disconnected</span>
                `;
                connectionStatus.className = 'connection-status';
                
                // Disable buttons
                document.getElementById('refreshComplianceBtn').disabled = true;
                document.getElementById('refreshAppsBtn').disabled = true;
                document.getElementById('exportComplianceBtn').disabled = true;
                document.getElementById('exportAppsBtn').disabled = true;
                document.getElementById('fetchDeviceStatusBtn').disabled = true;
                document.getElementById('exportJsonBtn').disabled = true;
                document.getElementById('exportCsvBtn').disabled = true;
                document.getElementById('exportPdfBtn').disabled = true;
                document.getElementById('refreshPoliciesBtn').disabled = true;
                document.getElementById('exportPoliciesBtn').disabled = true;
                document.getElementById('loadDeviceStatusBtn').disabled = true;
                
                // Hide summary stats
                document.getElementById('summaryStats').style.display = 'none';
            }
        }

        // Token recovery function
        function checkExistingToken() {
            if (!accessToken && sessionStorage.getItem('intuneAccessToken')) {
                accessToken = sessionStorage.getItem('intuneAccessToken');
                window.accessToken = accessToken;
                console.log('Token restored from session storage');
                
                // Check if we also have account info
                const savedAccount = sessionStorage.getItem('intuneAccount');
                if (savedAccount) {
                    try {
                        account = JSON.parse(savedAccount);
                        console.log('Account info restored');
                        updateUI();
                        return true;
                    } catch (e) {
                        console.error('Failed to parse saved account info');
                    }
                }
            }
            return false;
        }

        async function getAccessToken() {
        const request = {
            scopes: ['User.Read', 'DeviceManagementManagedDevices.Read.All', 'DeviceManagementApps.Read.All', 'DeviceManagementConfiguration.Read.All'],
            account: account
        };
    
        try {
            console.log('Attempting to acquire token silently...');
            const response = await msalInstance.acquireTokenSilent(request);
            console.log('Token acquired successfully');
            return response.accessToken;
        } catch (error) {
            console.log('Silent token acquisition failed, trying popup...', error);
            try {
                const response = await msalInstance.acquireTokenPopup(request);
                console.log('Token acquired via popup');
                return response.accessToken;
            } catch (popupError) {
                console.error('Token acquisition failed:', popupError);
                // Return null instead of throwing to prevent unhandled errors
                return null;
            }
        }
    }
                // Tab switching
                function switchTab(tabName) {
                    const tabs = document.querySelectorAll('.tab');
                    const contents = document.querySelectorAll('.tab-content');
                    
                    tabs.forEach(tab => {
                        tab.classList.remove('active');
                        if (tab.textContent.toLowerCase().includes(tabName)) {
                            tab.classList.add('active');
                        }
                    });
                    
                    contents.forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    document.getElementById(tabName + 'Tab').classList.add('active');
                    
                    // Update dashboard when switching to it
                    if (tabName === 'dashboard') {
                        updateDashboard();
                    }
                }

        // Compliance functions
        async function refreshComplianceData() {
            if (!account) {
                alert('Please sign in first');
                return;
            }

            showLoading('compliance', true);
            
            try {
                const accessToken = await getAccessToken();
                
                const devicesResponse = await fetch('https://graph.microsoft.com/v1.0/deviceManagement/managedDevices', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!devicesResponse.ok) {
                    throw new Error('Failed to fetch devices');
                }
                
                const devicesData = await devicesResponse.json();
                complianceData = devicesData.value || [];
                
                processComplianceData();
                filterDevices();
                updateSummaryStats();
                updateDashboard();
                dataRefreshTimestamps.compliance = Date.now();
                showNotification(`Successfully loaded ${complianceData.length} devices`, 'success');
                
            } catch (error) {
                console.error('Error fetching compliance data:', error);
                showNotification('Failed to fetch compliance data. Please try again.', 'error');
            } finally {
                showLoading('compliance', false);
            }
        }

        // Enhanced device compliance details fetching to include all configuration compliance
        async function fetchDeviceComplianceDetails(deviceId) {
    try {
        // Ensure we have an account
        if (!account) {
            console.error('No account available - user needs to sign in');
            return null;
        }
        
        // Get a fresh access token
        const accessToken = await getAccessToken();
        if (!accessToken) {
            console.error('Failed to acquire access token');
            showNotification('Authentication failed. Please sign in again.', 'error');
            return null;
        }
        
        console.log('Access token acquired, fetching device details for:', deviceId);
        
        const device = complianceData.find(d => d.id === deviceId);
        if (!device) {
            console.error('Device not found in local data');
            return null;
        }
                
                // Try to fetch compliance policy states
                try {
                    const policyResponse = await fetch(
                        `https://graph.microsoft.com/beta/deviceManagement/managedDevices/${deviceId}/deviceCompliancePolicyStates?$expand=settingStates`,
                        {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        }
                    );
                    
                    if (policyResponse.ok) {
                        const policyData = await policyResponse.json();
                        device.compliancePolicies = policyData.value || [];
                    }
                } catch (error) {
                    console.error('Error fetching compliance policies:', error);
                    device.compliancePolicies = [];
                }
                
                // Try to fetch configuration states
                try {
                    const configResponse = await fetch(
                        `https://graph.microsoft.com/beta/deviceManagement/managedDevices/${deviceId}/deviceConfigurationStates`,
                        {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        }
                    );
                    
                    if (configResponse.ok) {
                        const configData = await configResponse.json();
                        device.configurationStates = configData.value || [];
                    }
                } catch (error) {
                    console.error('Error fetching configuration states:', error);
                    device.configurationStates = [];
                }
                
                // Try to fetch settings catalog configuration states
                try {
                    const settingsResponse = await fetch(
                        `https://graph.microsoft.com/beta/deviceManagement/managedDevices/${deviceId}/configurationPolicyStates`,
                        {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        }
                    );
                    
                    if (settingsResponse.ok) {
                        const settingsData = await settingsResponse.json();
                        device.settingsCatalogStates = settingsData.value || [];
                    }
                } catch (error) {
                    console.error('Error fetching settings catalog states:', error);
                    device.settingsCatalogStates = [];
                }
                
                return device;
            } catch (error) {
                console.error('Error fetching device details:', error);
                return null;
            }
        }

        function processComplianceData() {
            const stats = {
                total: complianceData.length,
                compliant: complianceData.filter(d => d.complianceState === 'compliant').length,
                noncompliant: complianceData.filter(d => d.complianceState === 'noncompliant').length,
                unknown: complianceData.filter(d => d.complianceState === 'unknown').length,
                pending: complianceData.filter(d => d.complianceState === 'inGracePeriod' || d.complianceState === 'configManager').length
            };
            
            updateComplianceChart(stats);
        }

        function updateComplianceChart(stats) {
            const chart = document.getElementById('complianceChart');
            const total = stats.total || 1;
            
            const segments = [
                { class: 'compliant', value: stats.compliant },
                { class: 'noncompliant', value: stats.noncompliant },
                { class: 'unknown', value: stats.unknown },
                { class: 'pending', value: stats.pending }
            ];
            
            chart.innerHTML = segments.map(segment => {
                const percentage = (segment.value / total) * 100;
                return `<div class="progress-segment ${segment.class}" style="width: ${percentage}%">${segment.value > 0 ? segment.value : ''}</div>`;
            }).join('');
        }

        function filterDevices() {
            const searchTerm = document.getElementById('deviceSearch').value.toLowerCase();
            const statusFilter = document.getElementById('complianceFilter').value;
            const platformFilter = document.getElementById('platformFilter').value;
            
            filteredComplianceData = complianceData.filter(device => {
                const matchesSearch = !searchTerm || 
                    device.deviceName.toLowerCase().includes(searchTerm) ||
                    (device.userPrincipalName && device.userPrincipalName.toLowerCase().includes(searchTerm));
                
                const matchesStatus = statusFilter === 'all' || 
                    (statusFilter === 'pending' && (device.complianceState === 'inGracePeriod' || device.complianceState === 'configManager')) ||
                    device.complianceState === statusFilter;
                    
                const matchesPlatform = platformFilter === 'all' || 
                    device.operatingSystem.toLowerCase().includes(platformFilter); // Changed to includes for broader matching
                
                return matchesSearch && matchesStatus && matchesPlatform;
            });
            
            displayComplianceData();
        }

        function displayComplianceData() {
            const tableBody = document.getElementById('complianceTableBody');
            const tableContainer = document.getElementById('complianceTableContainer');
            const emptyState = document.getElementById('complianceEmpty');
            
            if (filteredComplianceData.length === 0 && complianceData.length === 0) {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';
            
            tableBody.innerHTML = filteredComplianceData.map(device => `
                <tr>
                    <td>${device.deviceName}</td>
                    <td>${device.userPrincipalName || 'N/A'}</td>
                    <td>${device.operatingSystem} ${device.osVersion || ''}</td>
                    <td>
                        <span class="status-badge status-${getComplianceClass(device.complianceState)}">
                            ${device.complianceState}
                        </span>
                    </td>
                    <td>${formatDate(device.lastSyncDateTime)}</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewDeviceDetails('${device.id}')">
                            View Details
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function mapSettingsCatalogState(state) {
    if (typeof state === 'string') {
        state = state.toLowerCase();
    }
    
    switch(state) {
        case 'compliant':
        case 'succeeded':
        case 'success':
        case 0:
            return 'compliant';
        case 'conflict':
        case 'failed':
        case 'error':
        case 'noncompliant':
        case 2:
            return 'noncompliant';
        case 'notapplicable':
        case 3:
            return 'unknown';
        case 'pending':
        case 'inprogress':
        case 1:
            return 'pending';
        default:
            return 'unknown';
    }
}

        // Application functions
        async function refreshApplicationData() {
            if (!account) {
                alert('Please sign in first');
                return;
            }

            showLoading('applications', true);
            
            try {
                const accessToken = await getAccessToken();
                
                const appsResponse = await fetch('https://graph.microsoft.com/v1.0/deviceAppManagement/mobileApps', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!appsResponse.ok) {
                    throw new Error('Failed to fetch applications');
                }
                
                const appsData = await appsResponse.json();
                applicationData = appsData.value || [];
                
                filterApplications();
                updateSummaryStats();
                updateDashboard();
                dataRefreshTimestamps.applications = Date.now();
                showNotification(`Successfully loaded ${applicationData.length} applications`, 'success');
                
            } catch (error) {
                console.error('Error fetching application data:', error);
                showNotification('Failed to fetch application data. Please try again.', 'error');
            } finally {
                showLoading('applications', false);
            }
        }

        async function fetchDeviceInstallStatus() {
            if (!account) {
                alert('Please sign in first');
                return;
            }

            showLoading('applications', true);
            deviceInstallStates = [];
            
            try {
                const accessToken = await getAccessToken();
                
                if (complianceData.length === 0) {
                    await refreshComplianceData();
                }
                
                // Create fetch functions for rate limiting
                const devicesToCheck = complianceData.slice(0, 20); // Increased from 10 since we have rate limiting
                
                const fetchRequests = devicesToCheck.map(device => async () => {
                    try {
                        const response = await fetch(
                            `https://graph.microsoft.com/beta/deviceManagement/managedDevices/${device.id}/detectedApps`,
                            {
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            }
                        );
                        
                        if (response.ok) {
                            const data = await response.json();
                            const apps = data.value || [];
                            
                            return apps.map(app => ({
                                deviceId: device.id,
                                deviceName: device.deviceName,
                                userPrincipalName: device.userPrincipalName,
                                appName: app.displayName,
                                version: app.version,
                                sizeInByte: app.sizeInByte,
                                deviceCount: app.deviceCount
                            }));
                        }
                        return [];
                    } catch (error) {
                        console.error(`Error fetching apps for device ${device.id}:`, error);
                        return [];
                    }
                });
                
                // Fetch with rate limiting
                showNotification('Fetching device install status...', 'info');
                const results = await fetchWithRateLimit(fetchRequests, 3, 1500); // Lower concurrency for this endpoint
                
                // Flatten results and add to deviceInstallStates
                results.forEach(deviceApps => {
                    if (deviceApps && deviceApps.length > 0) {
                        deviceInstallStates.push(...deviceApps);
                    }
                });
                
                displayDeviceInstallStatus();
                
            } catch (error) {
                console.error('Error fetching device install status:', error);
                alert('Failed to fetch device install status. Please try again.');
            } finally {
                showLoading('applications', false);
            }
        }

        function filterApplications() {
            const searchTerm = document.getElementById('appSearch').value.toLowerCase();
            const typeFilter = document.getElementById('appTypeFilter').value;
            
            filteredApplicationData = applicationData.filter(app => {
                const matchesSearch = !searchTerm || 
                    app.displayName.toLowerCase().includes(searchTerm) ||
                    (app.publisher && app.publisher.toLowerCase().includes(searchTerm));
                
                const matchesType = typeFilter === 'all' || 
                    (app['@odata.type'] && app['@odata.type'].toLowerCase().includes(typeFilter));
                
                return matchesSearch && matchesType;
            });
            
            displayApplicationData();
        }

        function displayApplicationData() {
            const tableBody = document.getElementById('applicationsTableBody');
            const tableContainer = document.getElementById('applicationsTableContainer');
            const emptyState = document.getElementById('applicationsEmpty');
            
            if (filteredApplicationData.length === 0 && applicationData.length === 0) {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';
            
            tableBody.innerHTML = filteredApplicationData.map(app => {
                return `
                    <tr>
                        <td>${app.displayName}</td>
                        <td>${app.publisher || 'N/A'}</td>
                        <td>${app.displayVersion || 'N/A'}</td>
                        <td>${getAppType(app['@odata.type'])}</td>
                        <td>${formatDate(app.createdDateTime)}</td>
                        <td>${formatDate(app.lastModifiedDateTime)}</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewAppDetails('${app.id}')">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function displayDeviceInstallStatus() {
            const tableBody = document.getElementById('deviceStatusTableBody');
            const tableContainer = document.getElementById('deviceStatusTableContainer');
            
            if (deviceInstallStates.length === 0) {
                tableContainer.style.display = 'none';
                return;
            }
            
            tableContainer.style.display = 'block';
            
            tableBody.innerHTML = deviceInstallStates.map(state => `
                <tr>
                    <td>${state.deviceName}</td>
                    <td>${state.userPrincipalName || 'N/A'}</td>
                    <td>${state.appName}</td>
                    <td><span class="status-badge status-compliant">Installed</span></td>
                    <td>${state.version || 'N/A'}</td>
                    <td>${formatBytes(state.sizeInByte)}</td>
                </tr>
            `).join('');
        }

        function changeViewMode() {
            const viewMode = document.getElementById('viewMode').value;
            const appTable = document.getElementById('applicationsTableContainer');
            const deviceTable = document.getElementById('deviceStatusTableContainer');
            const fetchBtn = document.getElementById('fetchDeviceStatusBtn');
            
            if (viewMode === 'deviceStatus') {
                appTable.style.display = 'none';
                deviceTable.style.display = 'block';
                fetchBtn.style.display = 'inline-block';
            } else {
                appTable.style.display = 'block';
                deviceTable.style.display = 'none';
                fetchBtn.style.display = 'none';
            }
        }

        // Policy functions - Enhanced to fetch all configuration types
        async function refreshPolicyData() {
    if (!account) {
        alert('Please sign in first');
        return;
    }

    showLoading('policies', true);

    try {
        const accessToken = await getAccessToken();

        // Fetch policies and EXPAND their status overviews in a single call where possible
        const endpoints = {
    compliance: 'deviceManagement/deviceCompliancePolicies',
    configurations: 'deviceManagement/deviceConfigurations',
    settingsCatalog: 'deviceManagement/configurationPolicies',
    adminTemplates: 'deviceManagement/groupPolicyConfigurations'
};

        const [complianceRes, configRes, settingsRes, adminRes] = await Promise.all([
            fetch(`https://graph.microsoft.com/beta/${endpoints.compliance}`, { headers: { 'Authorization': `Bearer ${accessToken}` } }),
            fetch(`https://graph.microsoft.com/beta/${endpoints.configurations}`, { headers: { 'Authorization': `Bearer ${accessToken}` } }),
            fetch(`https://graph.microsoft.com/beta/${endpoints.settingsCatalog}`, { headers: { 'Authorization': `Bearer ${accessToken}` } }),
            fetch(`https://graph.microsoft.com/beta/${endpoints.adminTemplates}`, { headers: { 'Authorization': `Bearer ${accessToken}` } })
        ]);

        if (complianceRes.ok) {
    const data = await complianceRes.json();
    policyData = (data.value || []).map(p => ({...p, policyType: 'Compliance Policy'}));
}
if (configRes.ok) {
    const data = await configRes.json();
    configurationProfiles = (data.value || []).map(p => ({...p, policyType: 'Device Configuration'}));
}
if (settingsRes.ok) {
    const data = await settingsRes.json();
    settingsCatalog = (data.value || []).map(p => ({...p, policyType: 'Settings Catalog'}));
}
if (adminRes.ok) {
    const data = await adminRes.json();
    adminTemplates = (data.value || []).map(p => ({...p, policyType: 'Administrative Template'}));
}

        displayPolicyData();
        updateDashboard();
        dataRefreshTimestamps.policies = Date.now();

        const totalPolicies = policyData.length + configurationProfiles.length + settingsCatalog.length + adminTemplates.length;
        showNotification(`Successfully loaded ${totalPolicies} policies`, 'success');

    } catch (error) {
        console.error('Error fetching policy data:', error);
        showNotification('Failed to fetch policy data. Please try again.', 'error');
    } finally {
        showLoading('policies', false);
    }
}
        
        /// Load device status for all policies
        async function loadPolicyDeviceStatus() {
    if (!account) {
        alert('Please sign in first');
        return;
    }

    // Filter for only the Settings Catalog policies that haven't been loaded yet
    const policiesToUpdate = settingsCatalog.filter(p => !policyDeviceStates[p.id]);

    if (policiesToUpdate.length === 0) {
        showNotification('All policy statuses are already loaded or up to date.', 'info');
        return;
    }

    const btn = document.getElementById('loadDeviceStatusBtn');
    btn.disabled = true;
    btn.textContent = 'Loading...';
    showNotification(`Fetching status for ${policiesToUpdate.length} Settings Catalog policies...`, 'info');

    try {
        // Get a fresh token
        const token = await getAccessToken();
        
        if (!token) {
            throw new Error('Failed to acquire access token');
        }
        
        // Also update our stored tokens
        accessToken = token;
        window.accessToken = token;
        sessionStorage.setItem('intuneAccessToken', token);
        
        console.log('Using refreshed token for device status calls');

        // Create an array of fetch functions to be rate-limited
const fetchRequests = policiesToUpdate.map(policy => async () => {
    try {
        // Settings Catalog policies have specific templateIds or can be identified by their settings structure
        // Check if this is a Settings Catalog policy (they typically have templateReference or specific properties)
        const isSettingsCatalog = policy.templateReference || 
                                 policy.technologies === 'mdm' || 
                                 policy.platforms === 'windows10';

        if (isSettingsCatalog) {
            // Try the device status endpoint first for Settings Catalog
            try {
                const statusResponse = await fetch(
                    `https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/${policy.id}/deviceStatuses`,
                    {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    }
                );

                if (statusResponse.ok) {
                    const statusData = await statusResponse.json();
                    const deviceStatuses = statusData.value || [];
                    
                    let compliant = 0, noncompliant = 0, pending = 0, error = 0;
                    
                    deviceStatuses.forEach(status => {
                        switch(status.state?.toLowerCase()) {
                            case 'compliant':
                            case 'succeeded':
                                compliant++;
                                break;
                            case 'noncompliant':
                            case 'error':
                            case 'conflict':
                                noncompliant++;
                                break;
                            case 'pending':
                            case 'notassigned':
                            default:
                                pending++;
                                break;
                        }
                    });

                    policyDeviceStates[policy.id] = [{
                        state: 'summary',
                        total: deviceStatuses.length || 'No devices',
                        compliant: compliant,
                        noncompliant: noncompliant,
                        pending: pending
                    }];
                    return;
                }
            } catch (err) {
                console.debug(`Device status endpoint not available for ${policy.name}, trying assignments...`);
            }

            // If device status doesn't work, check assignments at least
            try {
                const assignResponse = await fetch(
                    `https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/${policy.id}/assignments`,
                    {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    }
                );

                if (assignResponse.ok) {
                    const assignData = await assignResponse.json();
                    const hasAssignments = assignData.value && assignData.value.length > 0;
                    
                    policyDeviceStates[policy.id] = [{
                        state: 'summary',
                        total: hasAssignments ? 'Assigned' : 'Not assigned',
                        compliant: 0,
                        noncompliant: 0,
                        pending: 0,
                        note: 'Device status not available for Settings Catalog policies'
                    }];
                    return;
                }
            } catch (err) {
                console.debug(`Assignment check failed for ${policy.name}`);
            }

            // If all else fails for Settings Catalog
            policyDeviceStates[policy.id] = [{
                state: 'summary',
                total: 'Not available',
                compliant: 0,
                noncompliant: 0,
                pending: 0,
                note: 'Settings Catalog policy - status unavailable'
            }];

        } else {
            // Original code for standard device configuration policies
            const endpoint = `deviceManagement/deviceConfigurations/${policy.id}/deviceStatuses`;
            const response = await fetch(`https://graph.microsoft.com/beta/${endpoint}`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });

            if (!response.ok) {
                // Try the summary endpoint as fallback
                const summaryResponse = await fetch(
                    `https://graph.microsoft.com/beta/deviceManagement/deviceConfigurations/${policy.id}/deviceStatusOverview`,
                    {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    }
                );

                if (summaryResponse.ok) {
                    const summary = await summaryResponse.json();
                    policyDeviceStates[policy.id] = [{
                        state: 'summary',
                        total: summary.configurationVersion || 0,
                        compliant: summary.compliantDeviceCount || 0,
                        noncompliant: summary.errorDeviceCount || 0,
                        pending: summary.pendingDeviceCount || 0
                    }];
                    return;
                }

                console.error(`Failed to fetch status for policy '${policy.name}': ${response.status}`);
                policyDeviceStates[policy.id] = [{ state: 'summary', total: 'Error', compliant: 0, noncompliant: 0, pending: 0 }];
                return;
            }

            const deviceStatuses = await response.json();
            const statuses = deviceStatuses.value || [];

            // Calculate summary for regular policies
            let compliant = 0, noncompliant = 0, pending = 0;
            
            statuses.forEach(status => {
                switch(status.status) {
                    case 'compliant':
                    case 'succeeded':
                        compliant++;
                        break;
                    case 'nonCompliant':
                    case 'error':
                    case 'conflict':
                        noncompliant++;
                        break;
                    case 'pending':
                    case 'notApplicable':
                    default:
                        pending++;
                        break;
                }
            });

            policyDeviceStates[policy.id] = [{
                state: 'summary',
                total: statuses.length,
                compliant: compliant,
                noncompliant: noncompliant,
                pending: pending
            }];
        }

    } catch (error) {
        console.error(`Error processing policy ${policy.name}:`, error);
        policyDeviceStates[policy.id] = [{ state: 'summary', total: 'Error', compliant: 0, noncompliant: 0, pending: 0 }];
    }
});

        // Use the rate-limiting function to execute all requests
        await fetchWithRateLimit(fetchRequests, 3, 1500);

        // Re-render the entire policy table with the new data
        displayPolicyData();
        updateDashboard();

        showNotification('Settings Catalog status loading complete.', 'success');

    } catch (error) {
        console.error('A critical error occurred while loading device status:', error);
        showNotification('Failed to load device status. Please check the console.', 'error');
    } finally {
        if (btn) btn.disabled = false;
        btn.textContent = 'Load Device Status';
    }
}

        // Refresh the display with the new summary data
        function displayPolicyData() {
    const tableBody = document.getElementById('policiesTableBody');
    const tableContainer = document.getElementById('policiesTableContainer');
    const emptyState = document.getElementById('policiesEmpty');

    // Combine all policy types
    const allPolicies = [
        ...policyData.map(p => ({ ...p, policyType: 'Compliance Policy' })),
        ...configurationProfiles.map(p => ({ ...p, policyType: 'Device Configuration' })),
        ...settingsCatalog.map(p => ({ ...p, policyType: 'Settings Catalog' })),
        ...adminTemplates.map(p => ({ ...p, policyType: 'Administrative Template' }))
    ];

    if (allPolicies.length === 0) {
        tableContainer.style.display = 'none';
        emptyState.style.display = 'block';
        document.getElementById('exportPoliciesBtn').disabled = true;
        document.getElementById('loadDeviceStatusBtn').style.display = 'none';
        return;
    }

    tableContainer.style.display = 'block';
    emptyState.style.display = 'none';
    document.getElementById('exportPoliciesBtn').disabled = false;
    document.getElementById('loadDeviceStatusBtn').style.display = 'inline-block';

    tableBody.innerHTML = allPolicies.map(policy => {
        let successRate = 'Not loaded';
        let assignedCount = 'Not loaded';

        // Check if a summary object exists in the cache
        let summaryState = policyDeviceStates[policy.id];
        if (summaryState && summaryState.length > 0 && summaryState[0].state === 'summary') {
            const summary = summaryState[0];
            assignedCount = summary.total;
            if (summary.total > 0) {
                successRate = `${Math.round((summary.compliant / summary.total) * 100)}%`;
            } else {
                successRate = '100%'; // No devices assigned
            }
        }

        return `
            <tr>
                <td>${policy.displayName || policy.name || 'Unnamed'}</td>
                <td><span class="policy-tag">${policy.policyType}</span></td>
                <td>${policy.description || 'N/A'}</td>
                <td>${Array.isArray(policy.platforms) ? policy.platforms.join(', ') : (policy.platforms || policy.platform || 'All')}</td>
                <td>${assignedCount}</td>
                <td>${successRate}</td>
                <td>
                    <button class="btn btn-primary" onclick="viewPolicyDetails('${policy.id}', '${policy.policyType}')" title="View policy definition details. Device status is shown in the table.">
                        View Details
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}
        
        // Helper function to map Settings Catalog states to standard states
        function mapSettingsCatalogState(state) {
            // Handle both the state string and potential numeric values
            if (typeof state === 'string') {
                state = state.toLowerCase();
            }
            
            switch(state) {
                case 'compliant':
                case 'succeeded':
                case 'success':
                case 0: // Success
                    return 'compliant';
                case 'conflict':
                case 'failed':
                case 'error':
                case 'noncompliant':
                case 2: // Error
                    return 'noncompliant'; // changed from nonCompliant to noncompliant for consistency with CSS
                case 'notapplicable':
                case 'notApplicable':
                case 3: // Not applicable
                    return 'unknown'; // often treated as compliant for policy application, but "unknown" is safer for a dashboard
                case 'pending':
                case 'inprogress':
                case 1: // In progress
                    return 'pending';
                default:
                    return 'unknown';
            }
        }
        // View device status for a specific policy
        async function viewPolicyDeviceStatus(policyId, policyType, policyName) {
            const container = document.getElementById('policyDeviceStatusContainer');
            const title = document.getElementById('policyDeviceStatusTitle');
            const tbody = document.getElementById('policyDeviceStatusBody');
            
            title.textContent = `Device Status for: ${policyName}`;
            container.style.display = 'block';
            
            let deviceStates = policyDeviceStates[policyId];
            
            // If no cached data and it's a Settings Catalog policy, try to fetch it
            if ((!deviceStates || deviceStates.length === 0) && policyType === 'Settings Catalog') {
                try {
                    const accessToken = await getAccessToken();
                    
                    // Try both endpoint formats
                    let response = await fetch(
                        `https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/${policyId}/deviceStatusSummary`,
                        {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'ConsistencyLevel': 'eventual'
                            }
                        }
                    );
                    
                    if (!response.ok) {
                        console.log(`First format failed, trying with parentheses...`);
                        response = await fetch(
                            `https://graph.microsoft.com/beta/deviceManagement/configurationPolicies/${policyId}/deviceStatuses`,
                            {
                                headers: {
                                    'Authorization': `Bearer ${accessToken}`,
                                    'ConsistencyLevel': 'eventual'
                                }
                            }
                        );
                    }
                    
                    if (response.ok) {
                        const data = await response.json();
                        const deviceStatuses = data.value || [];
                        
                        deviceStates = deviceStatuses.map(status => ({
                            deviceId: status.id,
                            deviceName: status.deviceDisplayName || 'Unknown Device',
                            userPrincipalName: status.userPrincipalName || 'N/A',
                            state: mapSettingsCatalogState(status.state),
                            lastReported: status.lastReportedDateTime,
                            errorDescription: status.errorDescription || null,
                            settingStates: [] // Settings Catalog doesn't provide detailed setting states in this endpoint
                        }));
                        
                        // Cache the results
                        if (deviceStates.length > 0) {
                            policyDeviceStates[policyId] = deviceStates;
                        }
                    }
                } catch (error) {
                    console.error('Error fetching Settings Catalog device status:', error);
                }
            }
            
            if (!deviceStates || deviceStates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #6b7280;">
                            No device status data available. Click "Load Device Status" to fetch device compliance information.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = deviceStates.map(state => {
                const statusClass = (state.state === 'compliant' || state.state === 'succeeded') ? 
                    'compliant' : (state.state === 'noncompliant' || state.state === 'failed') ? 
                    'noncompliant' : 'unknown';
                
                // Count failed settings
                let failedSettingsCount = 0;
                if (state.settingStates && Array.isArray(state.settingStates)) {
                    failedSettingsCount = state.settingStates.filter(s => 
                        s.state === 'noncompliant' || s.state === 'failed' || s.state === 'error'
                    ).length;
                }
                
                return `
                    <tr>
                        <td>${state.deviceName || state.deviceDisplayName || 'N/A'}</td>
                        <td>${state.userPrincipalName || 'N/A'}</td>
                        <td>
                            <span class="status-badge status-${statusClass}">
                                ${state.state}
                            </span>
                        </td>
                        <td>${formatDate(state.lastReported)}</td>
                        <td>${failedSettingsCount > 0 ? failedSettingsCount : '-'}</td>
                        <td>
                            ${state.deviceId ? `
                                <button class="btn btn-primary" onclick="viewDeviceDetails('${state.deviceId}')">
                                    View Details
                                </button>
                            ` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Scroll to the device status section
            container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Dashboard functions
        function updateDashboard() {
    // This function now primarily serves as a trigger for its child components.
    // Ensure data is available before updating.
    if (complianceData.length > 0) {
        const totalPolicies = policyData.length + configurationProfiles.length +
            settingsCatalog.length + adminTemplates.length;

        const complianceRate = complianceData.length > 0 ?
            Math.round((complianceData.filter(d => d.complianceState === 'compliant').length / complianceData.length) * 100) : 0;

        document.getElementById('dashComplianceRate').textContent = complianceRate + '%';
        document.getElementById('dashNonCompliant').textContent = complianceData.filter(d => d.complianceState === 'noncompliant').length;
        document.getElementById('dashTotalPolicies').textContent = totalPolicies;
        document.getElementById('dashLastUpdate').textContent = new Date().toLocaleTimeString();

        // Update all dashboard components
        updatePlatformBreakdown();
        updateNonCompliantDevicesList();
        updatePolicySuccessRates(); // This will now work correctly
        updateTopFailedPolicies(); // This will also now work correctly
        updateSyncStatusBreakdown();
    }
}

        function updatePolicySuccessRates() {
    const container = document.getElementById('policySuccessRate');
    const allPolicies = [
        ...policyData,
        ...configurationProfiles,
        ...settingsCatalog,
        ...adminTemplates
    ];

    let policiesWithStates = allPolicies.map(policy => {
        let overview = policy.deviceStatusOverview;
        let summaryState = policyDeviceStates[policy.id];

        if (overview) {
            const total = overview.successCount + overview.errorCount + overview.pendingCount + overview.notApplicableCount;
            if (total === 0) return null; // Don't show unassigned policies
            const successfulCount = overview.successCount + overview.notApplicableCount;
            return {
                name: policy.displayName || policy.name,
                total: total,
                success: successfulCount,
                rate: Math.round((successfulCount / total) * 100)
            };
        } else if (summaryState && summaryState[0].state === 'summary') {
            const summary = summaryState[0];
            if (summary.total === 0 || summary.total === 'Error') return null;
            return {
                name: policy.displayName || policy.name,
                total: summary.total,
                success: summary.compliant,
                rate: Math.round((summary.compliant / summary.total) * 100)
            };
        }
        return null;
    }).filter(Boolean); // Remove null entries

    if (policiesWithStates.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>Load policy data to view success rates.</p></div>';
        return;
    }

    policiesWithStates.sort((a, b) => a.rate - b.rate); // Sort with lowest success rate first

    container.innerHTML = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Policy Name</th>
                    <th>Success Rate</th>
                    <th>Successful / Total</th>
                </tr>
            </thead>
            <tbody>
                ${policiesWithStates.slice(0, 10).map(policy => `
                    <tr>
                        <td>${policy.name}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="flex: 1; background: #e5e7eb; height: 20px; border-radius: 10px; overflow: hidden;">
                                    <div style="width: ${policy.rate}%; background: ${policy.rate >= 90 ? '#16a34a' : policy.rate >= 60 ? '#d97706' : '#dc2626'}; height: 100%;"></div>
                                </div>
                                <span style="font-weight: 600; min-width: 45px;">${policy.rate}%</span>
                            </div>
                        </td>
                        <td>${policy.success} of ${policy.total}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>`;
}

        function updateTopFailedPolicies() {
    const container = document.getElementById('topFailedPolicies');
    const allPolicies = [
        ...policyData,
        ...configurationProfiles,
        ...settingsCatalog,
        ...adminTemplates
    ];

    let failedPolicies = allPolicies.map(policy => {
        let failedCount = 0;
        let totalCount = 0;
        let overview = policy.deviceStatusOverview;
        let summaryState = policyDeviceStates[policy.id];

        if (overview) {
            failedCount = overview.errorCount;
            totalCount = overview.successCount + overview.errorCount + overview.pendingCount + overview.notApplicableCount;
        } else if (summaryState && summaryState[0].state === 'summary' && summaryState[0].total !== 'Error') {
            failedCount = summaryState[0].noncompliant;
            totalCount = summaryState[0].total;
        }

        if (failedCount === 0) return null;

        return {
            name: policy.displayName || policy.name,
            type: policy.policyType,
            failed: failedCount,
            total: totalCount,
            rate: totalCount > 0 ? Math.round((failedCount / totalCount) * 100) : 0
        };
    }).filter(Boolean);

    if (failedPolicies.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No failed policies found.</p></div>';
        return;
    }

    failedPolicies.sort((a, b) => b.failed - a.failed);

    container.innerHTML = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>Policy Name</th>
                    <th>Policy Type</th>
                    <th>Failed Devices</th>
                    <th>Failure Rate</th>
                </tr>
            </thead>
            <tbody>
                ${failedPolicies.slice(0, 10).map(policy => `
                    <tr>
                        <td>${policy.name}</td>
                        <td><span class="policy-tag">${policy.type}</span></td>
                        <td>${policy.failed} of ${policy.total}</td>
                        <td><span style="color: #dc2626; font-weight: 600;">${policy.rate}%</span></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>`;
}

        function updateSyncStatusBreakdown() {
            const container = document.getElementById('syncStatusBreakdown');
            
            if (complianceData.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No sync data available</p></div>';
                return;
            }
            
            // Group devices by last sync time
            const now = new Date();
            const syncGroups = {
                'Last 24 hours': 0,
                '2-7 days': 0,
                '8-30 days': 0,
                'Over 30 days': 0,
                'Never synced': 0
            };
            
            complianceData.forEach(device => {
                if (!device.lastSyncDateTime) {
                    syncGroups['Never synced']++;
                    return;
                }
                
                const lastSync = new Date(device.lastSyncDateTime);
                const daysDiff = Math.floor((now - lastSync) / (1000 * 60 * 60 * 24));
                
                if (daysDiff <= 1) {
                    syncGroups['Last 24 hours']++;
                } else if (daysDiff <= 7) {
                    syncGroups['2-7 days']++;
                } else if (daysDiff <= 30) {
                    syncGroups['8-30 days']++;
                } else {
                    syncGroups['Over 30 days']++;
                }
            });
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    ${Object.entries(syncGroups).map(([period, count]) => {
                        const percentage = complianceData.length > 0 ? Math.round((count / complianceData.length) * 100) : 0;
                        const color = period === 'Last 24 hours' ? '#16a34a' : 
                                        period === '2-7 days' ? '#3b82f6' :
                                        period === '8-30 days' ? '#d97706' : '#dc2626';
                        
                        return `
                            <div style="text-align: center; padding: 15px; background: #f9fafb; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: ${color};">${count}</div>
                                <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">${period}</div>
                                <div style="font-size: 14px; color: #374151; margin-top: 3px;">${percentage}%</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function updatePlatformBreakdown() {
            const platformBreakdown = document.getElementById('platformBreakdown');
            
            if (complianceData.length === 0) {
                platformBreakdown.innerHTML = '<div class="empty-state"><p>No data available</p></div>';
                return;
            }
            
            const platforms = {};
            complianceData.forEach(device => {
                const platform = device.operatingSystem || 'Unknown';
                if (!platforms[platform]) {
                    platforms[platform] = {
                        total: 0,
                        compliant: 0,
                        noncompliant: 0
                    };
                }
                platforms[platform].total++;
                if (device.complianceState === 'compliant') {
                    platforms[platform].compliant++;
                } else if (device.complianceState === 'noncompliant') {
                    platforms[platform].noncompliant++;
                }
            });
            
            platformBreakdown.innerHTML = Object.entries(platforms).map(([platform, stats]) => `
                <div class="platform-card">
                    <div class="platform-name">${platform}</div>
                    <div class="platform-stats">
                        <div class="platform-stat">
                            <span style="color: #16a34a;">✓ ${stats.compliant}</span>
                        </div>
                        <div class="platform-stat">
                            <span style="color: #dc2626;">✗ ${stats.noncompliant}</span>
                        </div>
                        <div class="platform-stat">
                            <span style="color: #6b7280;">Total: ${stats.total}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateNonCompliantDevicesList() {
            const nonCompliantList = document.getElementById('nonCompliantDevicesList');
            
            const nonCompliantDevices = complianceData
                .filter(d => d.complianceState === 'noncompliant')
                .slice(0, 10);
            
            if (nonCompliantDevices.length === 0) {
                nonCompliantList.innerHTML = '<div class="empty-state"><p>No non-compliant devices</p></div>';
                return;
            }
            
            nonCompliantList.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Device Name</th>
                            <th>User</th>
                            <th>Platform</th>
                            <th>Last Sync</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${nonCompliantDevices.map(device => `
                            <tr>
                                <td>${device.deviceName}</td>
                                <td>${device.userPrincipalName || 'N/A'}</td>
                                <td>${device.operatingSystem}</td>
                                <td>${formatDate(device.lastSyncDateTime)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Helper functions
        function showLoading(type, show) {
            const loadingId = type + 'Loading';
            const tableId = type + 'TableContainer';
            const emptyId = type + 'Empty';
            
            document.getElementById(loadingId).style.display = show ? 'block' : 'none';
            
            if (show) {
                document.getElementById(tableId).style.display = 'none';
                document.getElementById(emptyId).style.display = 'none';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function formatBytes(bytes) {
            if (!bytes) return 'N/A';
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 Bytes';
            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
        }

        function formatGracePeriod(dateString) {
            if (!dateString) return 'Not configured';
            
            const date = new Date(dateString);
            const year = date.getFullYear();
            
            // Check if it's the max date (year 9999)
            if (year === 9999) {
                return 'No expiration / Not applicable';
            }
            
            // Check if the date is in the past
            if (date < new Date()) {
                return 'Expired on ' + date.toLocaleDateString();
            }
            
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

function getComplianceClass(state) {
    if (!state) return 'unknown';
    
    switch(state.toLowerCase()) {
        case 'compliant':
            return 'compliant';
        case 'noncompliant':
            return 'noncompliant';
        case 'unknown':
            return 'unknown';
        case 'ingracePeriod':
        case 'configmanager':
            return 'pending';
        default:
            return 'unknown';
    }
}
        
        function getAppType(odataType) {
            if (!odataType) return 'Unknown';
            
            const typeMap = {
                'win32LobApp': 'Win32',
                'windowsMobileMSI': 'MSI',
                'microsoftStoreForBusinessApp': 'Microsoft Store',
                'webApp': 'Web App',
                'iosStoreApp': 'iOS',
                'androidStoreApp': 'Android',
                'managedIOSStoreApp': 'iOS',
                'managedAndroidStoreApp': 'Android',
                'androidLobApp': 'Android LOB',
                'macOSMicrosoftDefenderApp': 'macOS Defender',
                'macOSOfficeSuiteApp': 'macOS Office',
                'macOSApp': 'macOS',
                'iosVppApp': 'iOS VPP',
                'microsoftAppStoreApp': 'Microsoft Store App', // New Graph type for some store apps
                'winAppX': 'Windows AppX/MSIX'
            };
            
            const typeName = odataType.split('.').pop();
            return typeMap[typeName] || typeName.replace(/([A-Z])/g, ' $1').trim(); // Basic camelCase to space conversion
        }

        function updateSummaryStats() {
            const now = new Date();
            const compliantCount = complianceData.filter(d => d.complianceState === 'compliant').length;
            
            document.getElementById('totalDevices').textContent = complianceData.length;
            document.getElementById('compliantDevices').textContent = compliantCount;
            document.getElementById('totalApps').textContent = applicationData.length;
            document.getElementById('lastSync').textContent = now.toLocaleTimeString();
        }

        function toggleExportMenu(type) {
            const menuId = type + 'ExportMenu';
            const menu = document.getElementById(menuId);
            menu.classList.toggle('show');
            
            document.querySelectorAll('.export-dropdown').forEach(m => {
                if (m.id !== menuId) {
                    m.classList.remove('show');
                }
            });
        }

        function exportData(type, format) {
            let data;
            if (type === 'compliance') {
                data = filteredComplianceData;
            } else if (type === 'applications') {
                data = filteredApplicationData;
            } else if (type === 'policies') {
                // Combine all policy types for export
                data = [
                    ...policyData.map(p => ({...p, policyType: 'Compliance Policy'})),
                    ...configurationProfiles.map(p => ({...p, policyType: 'Device Configuration'})),
                    ...settingsCatalog.map(p => ({...p, policyType: 'Settings Catalog'})),
                    ...adminTemplates.map(p => ({...p, policyType: 'Administrative Template'}))
                ];
            }
            
            const now = new Date();
            const timestamp = now.toISOString().replace(/:/g, '-').split('.')[0];
            const dateStr = now.toLocaleDateString().replace(/\//g, '-');
            const orgName = account ? account.username.split('@')[1] : 'export';
            
            const filename = `${orgName}_intune_${type}_${dateStr}_${timestamp}`;
            
            if (format === 'csv') {
                exportToCSV(data, `${filename}.csv`, type);
            } else if (format === 'json') {
                exportToJSON(data, `${filename}.json`, type);
            }
            
            document.getElementById(type + 'ExportMenu').classList.remove('show');
        }

        function exportSelectedData(format) {
            const includeCompliance = document.getElementById('exportCompliance').checked;
            const includeApplications = document.getElementById('exportApplications').checked;
            const includePolicies = document.getElementById('exportPolicies').checked;
            const includeConfigurations = document.getElementById('exportConfigurations').checked;
            const includeDashboard = document.getElementById('exportDashboard').checked;
            
            if (!includeCompliance && !includeApplications && !includePolicies && 
                !includeConfigurations && !includeDashboard) {
                alert('Please select at least one data type to export');
                return;
            }
            
            const now = new Date();
            const timestamp = now.toISOString().replace(/:/g, '-').split('.')[0];
            const dateStr = now.toLocaleDateString().replace(/\//g, '-');
            const orgName = account ? account.username.split('@')[1] : 'export';
            
            if (format === 'json') {
                const exportData = {
                    metadata: {
                        exportType: 'selected',
                        organization: orgName,
                        exportedBy: account ? account.username : 'Unknown',
                        exportDate: now.toISOString(),
                        dataTypes: []
                    }
                };
                
                if (includeCompliance) {
                    exportData.compliance = complianceData;
                    exportData.metadata.dataTypes.push('compliance');
                }
                
                if (includeApplications) {
                    exportData.applications = applicationData;
                    exportData.metadata.dataTypes.push('applications');
                }
                
                if (includePolicies) {
                    exportData.compliancePolicies = policyData;
                    exportData.metadata.dataTypes.push('compliancePolicies');
                }
                
                if (includeConfigurations) {
                    exportData.configurations = {
                        deviceConfigurations: configurationProfiles,
                        settingsCatalog: settingsCatalog,
                        administrativeTemplates: adminTemplates
                    };
                    exportData.metadata.dataTypes.push('configurations');
                }
                
                const filename = `${orgName}_intune_export_${dateStr}_${timestamp}.json`;
                const jsonContent = JSON.stringify(exportData, null, 2);
                downloadFile(jsonContent, filename, 'application/json');
                
            } else if (format === 'csv') {
                // Export multiple CSV files for different data types
                if (includeCompliance) {
                    exportToCSV(complianceData, `${orgName}_compliance_${dateStr}_${timestamp}.csv`, 'compliance');
                }
                
                if (includeApplications) {
                    setTimeout(() => {
                        exportToCSV(applicationData, `${orgName}_applications_${dateStr}_${timestamp}.csv`, 'applications');
                    }, 500);
                }
                
                if (includePolicies || includeConfigurations) {
                    const allPolicies = [
                        ...policyData.map(p => ({...p, policyType: 'Compliance Policy'})),
                        ...configurationProfiles.map(p => ({...p, policyType: 'Device Configuration'})),
                        ...settingsCatalog.map(p => ({...p, policyType: 'Settings Catalog'})),
                        ...adminTemplates.map(p => ({...p, policyType: 'Administrative Template'}))
                    ];
                    setTimeout(() => {
                        exportToCSV(allPolicies, `${orgName}_policies_${dateStr}_${timestamp}.csv`, 'policies');
                    }, 1000);
                }
            }
        }

        function exportDashboardPDF() {
    if (complianceData.length === 0) {
        alert('No data available to export. Please refresh compliance data first.');
        return;
    }

    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    const orgName = account ? account.username.split('@')[1] : 'Intune Environment';

    // --- Gather all data for the report ---

    // Overall Compliance
    const complianceStats = {
        total: complianceData.length,
        compliant: complianceData.filter(d => d.complianceState === 'compliant').length,
        noncompliant: complianceData.filter(d => d.complianceState === 'noncompliant').length,
        ingrace: complianceData.filter(d => d.complianceState === 'inGracePeriod').length,
        unknown: complianceData.filter(d => d.complianceState === 'unknown').length,
    };
    const complianceRate = complianceStats.total > 0 ? Math.round((complianceStats.compliant / complianceStats.total) * 100) : 0;

    // Platform Breakdown
    const platforms = {};
    complianceData.forEach(device => {
        const platform = device.operatingSystem || 'Unknown';
        if (!platforms[platform]) {
            platforms[platform] = { total: 0, compliant: 0, noncompliant: 0 };
        }
        platforms[platform].total++;
        if (device.complianceState === 'compliant') platforms[platform].compliant++;
        if (device.complianceState === 'noncompliant') platforms[platform].noncompliant++;
    });

    // Policy Status Aggregation
    let totalPolicyAssignments = 0;
    let totalSuccessfulAssignments = 0;
    const allPolicies = [...policyData, ...configurationProfiles, ...settingsCatalog, ...adminTemplates];
    allPolicies.forEach(policy => {
        let overview = policy.deviceStatusOverview;
        let summaryState = policyDeviceStates[policy.id];
        if (overview) {
            const total = overview.successCount + overview.errorCount + overview.pendingCount + overview.notApplicableCount;
            totalPolicyAssignments += total;
            totalSuccessfulAssignments += overview.successCount + overview.notApplicableCount;
        } else if (summaryState && summaryState[0].state === 'summary' && summaryState[0].total !== 'Error') {
            totalPolicyAssignments += summaryState[0].total;
            totalSuccessfulAssignments += summaryState[0].compliant;
        }
    });
    const policySuccessRate = totalPolicyAssignments > 0 ? Math.round((totalSuccessfulAssignments / totalPolicyAssignments) * 100) : 100;

    // --- Start Building the PDF HTML ---

    const pdfContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Intune Environment Report</title>
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap');
                body { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; background: #f8f9fa; color: #212529; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                .report-container { max-width: 800px; margin: auto; padding: 30px; background: white; }
                .report-header { text-align: center; border-bottom: 2px solid #dee2e6; padding-bottom: 20px; margin-bottom: 30px; }
                .report-header h1 { font-size: 28px; color: #0078D4; margin: 0; }
                .report-header p { font-size: 16px; color: #6c757d; margin: 5px 0 0; }
                .section { margin-bottom: 30px; break-inside: avoid; page-break-inside: avoid; }
                .section-title { font-size: 20px; font-weight: 600; color: #343a40; border-bottom: 1px solid #dee2e6; padding-bottom: 8px; margin-bottom: 15px; }
                .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
                .kpi-card { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; text-align: center; }
                .kpi-value { font-size: 36px; font-weight: 700; color: #0078D4; margin: 0; }
                .kpi-label { font-size: 14px; color: #6c757d; margin-top: 5px; }
                .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                .data-table th, .data-table td { padding: 10px; text-align: left; border-bottom: 1px solid #dee2e6; }
                .data-table th { background-color: #e9ecef; font-weight: 600; font-size: 14px; }
                .data-table td { font-size: 14px; }
                .data-table tr:nth-child(even) { background-color: #f8f9fa; }
                .progress-bar { display: flex; height: 25px; border-radius: 5px; overflow: hidden; background: #e9ecef; margin-bottom: 15px; }
                .progress-segment { color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
                .footer { text-align: center; font-size: 12px; color: #6c757d; margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; }
                @media print { 
                    .no-print { display: none !important; }
                    body { background: white; }
                    .report-container { padding: 20px; }
                }
                @page { margin: 0.5in; }
            </style>
        </head>
        <body>
            <div class="report-container">
                <div class="report-header">
                    <h1>Intune Environment Report</h1>
                    <p><strong>${orgName}</strong></p>
                    <p>Report Generated: ${dateStr}</p>
                </div>

                <div class="section">
                    <h2 class="section-title">Executive Summary</h2>
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-value">${complianceRate}%</div>
                            <div class="kpi-label">Device Compliance</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value">${policySuccessRate}%</div>
                            <div class="kpi-label">Policy Success Rate</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value">${complianceStats.total}</div>
                            <div class="kpi-label">Total Managed Devices</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Device Compliance Breakdown</h2>
                    <div class="progress-bar">
                        <div class="progress-segment" style="background-color: #28a745; width: ${(complianceStats.compliant / complianceStats.total) * 100}%;" title="Compliant">${complianceStats.compliant}</div>
                        <div class="progress-segment" style="background-color: #dc3545; width: ${(complianceStats.noncompliant / complianceStats.total) * 100}%;" title="Non-Compliant">${complianceStats.noncompliant}</div>
                        <div class="progress-segment" style="background-color: #ffc107; color: #212529; width: ${(complianceStats.ingrace / complianceStats.total) * 100}%;" title="In Grace Period">${complianceStats.ingrace}</div>
                        <div class="progress-segment" style="background-color: #6c757d; width: ${(complianceStats.unknown / complianceStats.total) * 100}%;" title="Unknown">${complianceStats.unknown}</div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Count</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Compliant</td><td>${complianceStats.compliant}</td><td>${Math.round((complianceStats.compliant / complianceStats.total) * 100)}%</td></tr>
                            <tr><td>Non-Compliant</td><td>${complianceStats.noncompliant}</td><td>${Math.round((complianceStats.noncompliant / complianceStats.total) * 100)}%</td></tr>
                            <tr><td>In Grace Period</td><td>${complianceStats.ingrace}</td><td>${Math.round((complianceStats.ingrace / complianceStats.total) * 100)}%</td></tr>
                            <tr><td>Unknown</td><td>${complianceStats.unknown}</td><td>${Math.round((complianceStats.unknown / complianceStats.total) * 100)}%</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="section">
                    <h2 class="section-title">Compliance by Platform</h2>
                    <table class="data-table">
                        <thead><tr><th>Platform</th><th>Compliant</th><th>Non-Compliant</th><th>Total</th><th>Compliance Rate</th></tr></thead>
                        <tbody>
                            ${Object.entries(platforms).map(([platform, data]) => `
                                <tr>
                                    <td>${platform}</td>
                                    <td>${data.compliant}</td>
                                    <td>${data.noncompliant}</td>
                                    <td>${data.total}</td>
                                    <td>${data.total > 0 ? Math.round(data.compliant / data.total * 100) : 100}%</td>
                                </tr>`).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="section">
                    <h2 class="section-title">Policy Application Success Rate</h2>
                    <table class="data-table">
                        <thead><tr><th>Policy Name</th><th>Type</th><th>Success Rate</th><th>Applied Devices</th></tr></thead>
                        <tbody>
                            ${(() => {
                                const policyRows = [];
                                allPolicies.forEach(policy => {
                                    let successRate = 'N/A';
                                    let deviceCount = 0;
                                    let policyType = policy.policyType || 'Configuration';
                                    let overview = policy.deviceStatusOverview;
                                    let summaryState = policyDeviceStates[policy.id];
                                    
                                    if (overview) {
                                        const total = overview.successCount + overview.errorCount + overview.pendingCount + overview.notApplicableCount;
                                        deviceCount = total;
                                        if (total > 0) {
                                            const successful = overview.successCount + overview.notApplicableCount;
                                            successRate = Math.round((successful / total) * 100) + '%';
                                        }
                                    } else if (summaryState && summaryState.length > 0 && summaryState[0].state === 'summary' && summaryState[0].total !== 'Error') {
                                        deviceCount = summaryState[0].total;
                                        if (deviceCount > 0) {
                                            successRate = Math.round((summaryState[0].compliant / deviceCount) * 100) + '%';
                                        }
                                    }
                                    
                                    if (deviceCount > 0) {
                                        policyRows.push({
                                            name: policy.displayName || policy.name || 'Unnamed',
                                            type: policyType,
                                            successRate: successRate,
                                            deviceCount: deviceCount
                                        });
                                    }
                                });
                                
                                policyRows.sort((a, b) => {
                                    const aRate = parseInt(a.successRate) || 100;
                                    const bRate = parseInt(b.successRate) || 100;
                                    return aRate - bRate;
                                });
                                
                                return policyRows.slice(0, 10).map(row => `
                                    <tr>
                                        <td>${row.name}</td>
                                        <td>${row.type}</td>
                                        <td>${row.successRate}</td>
                                        <td>${row.deviceCount}</td>
                                    </tr>
                                `).join('');
                            })()}
                        </tbody>
                    </table>
                </div>

                <div class="section">
                    <h2 class="section-title">Top Failed Policies</h2>
                    <table class="data-table">
                        <thead><tr><th>Policy Name</th><th>Failed Devices</th><th>Total Devices</th><th>Failure Rate</th></tr></thead>
                        <tbody>
                            ${(() => {
                                const failedPolicies = [];
                                allPolicies.forEach(policy => {
                                    let failedCount = 0;
                                    let totalCount = 0;
                                    let overview = policy.deviceStatusOverview;
                                    let summaryState = policyDeviceStates[policy.id];
                                    
                                    if (overview) {
                                        failedCount = overview.errorCount;
                                        totalCount = overview.successCount + overview.errorCount + overview.pendingCount + overview.notApplicableCount;
                                    } else if (summaryState && summaryState.length > 0 && summaryState[0].state === 'summary' && summaryState[0].total !== 'Error') {
                                        failedCount = summaryState[0].noncompliant;
                                        totalCount = summaryState[0].total;
                                    }
                                    
                                    if (failedCount > 0) {
                                        failedPolicies.push({
                                            name: policy.displayName || policy.name || 'Unnamed',
                                            failed: failedCount,
                                            total: totalCount,
                                            rate: totalCount > 0 ? Math.round((failedCount / totalCount) * 100) : 0
                                        });
                                    }
                                });
                                
                                failedPolicies.sort((a, b) => b.failed - a.failed);
                                
                                if (failedPolicies.length === 0) {
                                    return '<tr><td colspan="4" style="text-align: center;">No failed policies found</td></tr>';
                                }
                                
                                return failedPolicies.slice(0, 10).map(policy => `
                                    <tr>
                                        <td>${policy.name}</td>
                                        <td>${policy.failed}</td>
                                        <td>${policy.total}</td>
                                        <td>${policy.rate}%</td>
                                    </tr>
                                `).join('');
                            })()}
                        </tbody>
                    </table>
                </div>

                <div class="section">
                    <h2 class="section-title">Device Sync Status</h2>
                    ${(() => {
                        const now = new Date();
                        const syncGroups = {
                            'Last 24 hours': 0,
                            '2-7 days': 0,
                            '8-30 days': 0,
                            'Over 30 days': 0,
                            'Never synced': 0
                        };
                        
                        complianceData.forEach(device => {
                            if (!device.lastSyncDateTime) {
                                syncGroups['Never synced']++;
                                return;
                            }
                            
                            const lastSync = new Date(device.lastSyncDateTime);
                            const daysDiff = Math.floor((now - lastSync) / (1000 * 60 * 60 * 24));
                            
                            if (daysDiff <= 1) syncGroups['Last 24 hours']++;
                            else if (daysDiff <= 7) syncGroups['2-7 days']++;
                            else if (daysDiff <= 30) syncGroups['8-30 days']++;
                            else syncGroups['Over 30 days']++;
                        });
                        
                        return `
                            <table class="data-table">
                                <thead><tr><th>Sync Period</th><th>Device Count</th><th>Percentage</th></tr></thead>
                                <tbody>
                                    ${Object.entries(syncGroups).map(([period, count]) => {
                                        const percentage = complianceData.length > 0 ? Math.round((count / complianceData.length) * 100) : 0;
                                        return `
                                            <tr>
                                                <td>${period}</td>
                                                <td>${count}</td>
                                                <td>${percentage}%</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        `;
                    })()}
                </div>

                <div class="section">
                    <h2 class="section-title">Recent Non-Compliant Devices</h2>
                    <table class="data-table">
                        <thead><tr><th>Device Name</th><th>User</th><th>Last Sync</th><th>Days Since Sync</th></tr></thead>
                        <tbody>
                            ${(() => {
                                const nonCompliantDevices = complianceData
                                    .filter(d => d.complianceState === 'noncompliant')
                                    .slice(0, 10);
                                
                                if (nonCompliantDevices.length === 0) {
                                    return '<tr><td colspan="4" style="text-align: center;">No non-compliant devices found</td></tr>';
                                }
                                
                                return nonCompliantDevices.map(device => {
                                    const lastSync = device.lastSyncDateTime ? new Date(device.lastSyncDateTime) : null;
                                    const daysSince = lastSync ? Math.floor((new Date() - lastSync) / (1000 * 60 * 60 * 24)) : 'N/A';
                                    return `
                                        <tr>
                                            <td>${device.deviceName}</td>
                                            <td>${device.userPrincipalName || 'N/A'}</td>
                                            <td>${formatDate(device.lastSyncDateTime)}</td>
                                            <td>${daysSince}</td>
                                        </tr>
                                    `;
                                }).join('');
                            })()}
                        </tbody>
                    </table>
                </div>
                
                <div class="footer">
                    Generated by Intune Compliance Manager<br>
                    ${new Date().toLocaleString()}
                </div>
            </div>
            <div style="position: fixed; top: 10px; right: 10px; z-index: 1000;">
                <button onclick="window.print()" style="padding: 10px 20px; background: #0078D4; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Print Report</button>
            </div>
        </body>
        </html>
    `;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(pdfContent);
    printWindow.document.close();
}

        function exportToCSV(data, filename, type) {
            if (data.length === 0) {
                alert('No data to export');
                return;
            }
            
            let csvContent = '';
            
            csvContent += `"Intune Compliance Manager Export"\n`;
            csvContent += `"Export Type","${type.charAt(0).toUpperCase() + type.slice(1)} Data"\n`;
            csvContent += `"Organization","${account ? account.username.split('@')[1] : 'Unknown'}"\n`;
            csvContent += `"Exported By","${account ? account.username : 'Unknown'}"\n`;
            csvContent += `"Export Date","${new Date().toLocaleString()}"\n`;
            csvContent += `"Total Records","${data.length}"\n`;
            csvContent += `\n`;
            
            if (type === 'compliance') {
                const headers = ['Device Name', 'User', 'Platform', 'OS Version', 'Compliance Status', 'Last Sync', 'Model', 'Manufacturer', 'Serial Number', 'Enrolled Date'];
                csvContent += headers.map(h => `"${h}"`).join(',') + '\n';
                
                data.forEach(device => {
                    const row = [
                        device.deviceName || '',
                        device.userPrincipalName || '',
                        device.operatingSystem || '',
                        device.osVersion || '',
                        device.complianceState || '',
                        formatDate(device.lastSyncDateTime) || '',
                        device.model || '',
                        device.manufacturer || '',
                        device.serialNumber || '',
                        formatDate(device.enrolledDateTime) || ''
                    ];
                    csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
                });
            } else if (type === 'applications') {
                const headers = ['Application Name', 'Publisher', 'Version', 'Type', 'Created Date', 'Modified Date', 'Description'];
                csvContent += headers.map(h => `"${h}"`).join(',') + '\n';
                
                data.forEach(app => {
                    const row = [
                        app.displayName || '',
                        app.publisher || '',
                        app.displayVersion || '',
                        getAppType(app['@odata.type']) || '',
                        formatDate(app.createdDateTime) || '',
                        formatDate(app.lastModifiedDateTime) || '',
                        (app.description || '').replace(/"/g, '""')
                    ];
                    csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
                });
            } else if (type === 'policies') {
                const headers = ['Policy Name', 'Type', 'Description', 'Platform', 'Created Date', 'Modified Date'];
                csvContent += headers.map(h => `"${h}"`).join(',') + '\n';
                
                data.forEach(policy => {
                    const row = [
                        policy.displayName || policy.name || '',
                        policy.policyType || '',
                        (policy.description || '').replace(/"/g, '""'),
                        policy.platform || policy.platforms || '',
                        formatDate(policy.createdDateTime) || '',
                        formatDate(policy.lastModifiedDateTime) || ''
                    ];
                    csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
                });
            }
            
            downloadFile(csvContent, filename, 'text/csv');
        }

        function exportToJSON(data, filename, type) {
            const exportData = {
                metadata: {
                    exportType: type,
                    organization: account ? account.username.split('@')[1] : 'Unknown',
                    exportedBy: account ? account.username : 'Unknown',
                    exportDate: new Date().toISOString(),
                    totalRecords: data.length
                },
                data: data
            };
            
            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadFile(jsonContent, filename, 'application/json');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Modal functions
        async function viewDeviceDetails(deviceId) {
            let device = complianceData.find(d => d.id === deviceId);
            if (!device) return;
            
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = `Device Details: ${device.deviceName}`;
            
            modalBody.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading compliance details...</p></div>';
            showModal();
            
            // Always try to fetch detailed compliance information
            device = await fetchDeviceComplianceDetails(deviceId) || device;
            
            let complianceDetails = '';
            
            // Check if device has compliance policy violations
            if (device.complianceState === 'noncompliant' || device.complianceState === 'configManager') {
                if (device.compliancePolicies && device.compliancePolicies.length > 0) {
                    const nonCompliantPolicies = device.compliancePolicies.filter(p => 
                        p.state === 'noncompliant' || p.state === 'failed' || p.state === 'error' // Ensure 'noncompliant' matches
                    );
                    
                    if (nonCompliantPolicies.length > 0) {
                        complianceDetails = `
                            <div class="detail-item" style="grid-column: 1 / -1;">
                                <div class="detail-label" style="color: #dc2626; font-size: 16px; margin-bottom: 10px;">Non-Compliant Policies</div>
                                <div style="background: #fee2e2; padding: 15px; border-radius: 4px;">
                                    ${nonCompliantPolicies.map(policy => {
                                        let policyHtml = `
                                            <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #fecaca;">
                                                <strong style="color: #b91c1c;">${policy.displayName || 'Unknown Policy'}</strong>
                                                <div style="margin-top: 5px; color: #666;">
                                                    Policy Status: <span style="color: #dc2626; font-weight: 600;">${policy.state}</span>
                                                </div>
                                        `;
                                        
                                        if (policy.settingStates && policy.settingStates.length > 0) {
                                            const failedSettings = policy.settingStates.filter(s => 
                                                s.state === 'noncompliant' || s.state === 'failed' || s.state === 'error' // Ensure 'noncompliant' matches
                                            );
                                            
                                            if (failedSettings.length > 0) {
                                                policyHtml += `
                                                    <div style="margin-top: 10px;">
                                                        <strong>Failed Settings:</strong>
                                                        <ul style="margin: 8px 0 0 20px; line-height: 1.6;">
                                                            ${failedSettings.map(setting => `
                                                                <li>
                                                                    <strong>${setting.setting || setting.settingName || 'Unknown setting'}</strong>
                                                                    ${setting.instanceDisplayName ? `<br><small style="color: #666;">${setting.instanceDisplayName}</small>` : ''}
                                                                    <br><span style="color: #dc2626;">Status: ${setting.state}</span>
                                                                    ${setting.errorDescription ? `<br><small style="color: #ef4444;">${setting.errorDescription}</small>` : ''}
                                                                </li>
                                                            `).join('')}
                                                        </ul>
                                                    </div>
                                                `;
                                            }
                                        }
                                        
                                        policyHtml += `</div>`;
                                        return policyHtml;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }
                } else if (device.configurationStates && device.configurationStates.length > 0) { // Check for device config states
                    const nonCompliantConfigs = device.configurationStates.filter(c =>
                        c.settingStates.some(s => s.settingState === 'failed' || s.settingState === 'error')
                    );
                    if (nonCompliantConfigs.length > 0) {
                        complianceDetails += `
                            <div class="detail-item" style="grid-column: 1 / -1;">
                                <div class="detail-label" style="color: #dc2626; font-size: 16px; margin-bottom: 10px;">Failed Device Configurations</div>
                                <div style="background: #fee2e2; padding: 15px; border-radius: 4px;">
                                    ${nonCompliantConfigs.map(config => {
                                        const failedSettings = config.settingStates.filter(s =>
                                            s.settingState === 'failed' || s.settingState === 'error'
                                        );
                                        return `
                                            <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #fecaca;">
                                                <strong style="color: #b91c1c;">${config.displayName || 'Unknown Configuration'}</strong>
                                                <div style="margin-top: 5px; color: #666;">
                                                    <span style="color: #dc2626; font-weight: 600;">${config.state}</span>
                                                </div>
                                                <div style="margin-top: 10px;">
                                                    <strong>Failed Settings:</strong>
                                                    <ul style="margin: 8px 0 0 20px; line-height: 1.6;">
                                                        ${failedSettings.map(setting => `
                                                            <li>
                                                                <strong>${setting.settingName || 'Unknown setting'}</strong>
                                                                <br><span style="color: #dc2626;">Status: ${setting.settingState}</span>
                                                                ${setting.errorMessage ? `<br><small style="color: #ef4444;">${setting.errorMessage}</small>` : ''}
                                                            </li>
                                                        `).join('')}
                                                    </ul>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Also check for Settings Catalog states
                if (device.settingsCatalogStates && device.settingsCatalogStates.length > 0) {
                    const nonCompliantSettingsCatalog = device.settingsCatalogStates.filter(s =>
                        s.settingStates.some(ss => mapSettingsCatalogState(ss.settingState) === 'noncompliant')
                    );
                    if (nonCompliantSettingsCatalog.length > 0) {
                        complianceDetails += `
                            <div class="detail-item" style="grid-column: 1 / -1;">
                                <div class="detail-label" style="color: #dc2626; font-size: 16px; margin-bottom: 10px;">Failed Settings Catalog Policies</div>
                                <div style="background: #fee2e2; padding: 15px; border-radius: 4px;">
                                    ${nonCompliantSettingsCatalog.map(policy => {
                                        const failedSettings = policy.settingStates.filter(s =>
                                            mapSettingsCatalogState(s.settingState) === 'noncompliant'
                                        );
                                        return `
                                            <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #fecaca;">
                                                <strong style="color: #b91c1c;">${policy.displayName || 'Unknown Policy'}</strong>
                                                <div style="margin-top: 5px; color: #666;">
                                                    <span style="color: #dc2626; font-weight: 600;">${policy.state}</span>
                                                </div>
                                                <div style="margin-top: 10px;">
                                                    <strong>Failed Settings:</strong>
                                                    <ul style="margin: 8px 0 0 20px; line-height: 1.6;">
                                                        ${failedSettings.map(setting => `
                                                            <li>
                                                                <strong>${setting.settingName || 'Unknown setting'}</strong>
                                                                <br><span style="color: #dc2626;">Status: ${setting.settingState}</span>
                                                                ${setting.errorCode ? `<br><small style="color: #ef4444;">Error Code: ${setting.errorCode}</small>` : ''}
                                                            </li>
                                                        `).join('')}
                                                    </ul>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }
                }

                // Generic message if no specific policy/config violations found but still non-compliant
                if (complianceDetails === '') {
                    complianceDetails = `
                        <div class="detail-item" style="grid-column: 1 / -1;">
                            <div class="detail-label" style="color: #d97706; font-size: 16px; margin-bottom: 10px;">Compliance Status Information</div>
                            <div style="background: #fef3c7; padding: 15px; border-radius: 4px;">
                                <p><strong>Device is marked as non-compliant</strong></p>
                                <p style="margin-top: 10px;">No specific policy violations were found. This can occur when:</p>
                                <ul style="margin: 8px 0 0 20px; line-height: 1.6;">
                                    <li>The device hasn't synced compliance status recently</li>
                                    <li>Compliance evaluation is still in progress</li>
                                    <li>The device is managed by Configuration Manager (co-management)</li>
                                    <li>Policy details require additional Graph API permissions</li>
                                    <li>The compliance state is being evaluated against conditional access policies</li>
                                </ul>
                                <p style="margin-top: 10px;"><strong>Last sync:</strong> ${formatDate(device.lastSyncDateTime)}</p>
                                <p style="margin-top: 5px;"><strong>Recommendation:</strong> Request the device user to sync their device or check the Intune portal for detailed compliance information.</p>
                            </div>
                        </div>
                    `;
                }
            }
            
            modalBody.innerHTML = `
                <div class="detail-grid">
                    ${complianceDetails}
                    <div class="detail-item">
                        <div class="detail-label">Device Name</div>
                        <div class="detail-value">${device.deviceName}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">User</div>
                        <div class="detail-value">${device.userPrincipalName || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Operating System</div>
                        <div class="detail-value">${device.operatingSystem} ${device.osVersion || ''}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Compliance Status</div>
                        <div class="detail-value">
                            <span class="status-badge status-${getComplianceClass(device.complianceState)}">
                                ${device.complianceState}
                            </span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Last Sync</div>
                        <div class="detail-value">${formatDate(device.lastSyncDateTime)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Model</div>
                        <div class="detail-value">${device.model || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Manufacturer</div>
                        <div class="detail-value">${device.manufacturer || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Serial Number</div>
                        <div class="detail-value">${device.serialNumber || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Enrollment Date</div>
                        <div class="detail-value">${formatDate(device.enrolledDateTime)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Management State</div>
                        <div class="detail-value">${device.managementState || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Compliance Grace Period</div>
                        <div class="detail-value">${formatGracePeriod(device.complianceGracePeriodExpirationDateTime)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Azure AD Registered</div>
                        <div class="detail-value">${device.azureADRegistered ? 'Yes' : 'No'}</div>
                    </div>
                </div>
            `;
        }

        async function viewAppDetails(appId) {
            const app = applicationData.find(a => a.id === appId);
            if (!app) return;
            
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = `Application Details: ${app.displayName}`;
            
            modalBody.innerHTML = `
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Application Name</div>
                        <div class="detail-value">${app.displayName}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Publisher</div>
                        <div class="detail-value">${app.publisher || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Version</div>
                        <div class="detail-value">${app.displayVersion || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Type</div>
                        <div class="detail-value">${getAppType(app['@odata.type'])}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Description</div>
                        <div class="detail-value">${app.description || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Created Date</div>
                        <div class="detail-value">${formatDate(app.createdDateTime)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Last Modified</div>
                        <div class="detail-value">${formatDate(app.lastModifiedDateTime)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Application ID</div>
                        <div class="detail-value" style="font-family: monospace; font-size: 12px;">${app.id}</div>
                    </div>
                    ${app.notes ? `
                    <div class="detail-item" style="grid-column: 1 / -1;">
                        <div class="detail-label">Notes</div>
                        <div class="detail-value">${app.notes}</div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            showModal();
        }

        async function viewPolicyDetails(policyId, policyType) {
            const allPolicies = [
                ...policyData.map(p => ({...p, policyType: 'Compliance Policy'})),
                ...configurationProfiles.map(p => ({...p, policyType: 'Device Configuration'})),
                ...settingsCatalog.map(p => ({...p, policyType: 'Settings Catalog'})),
                ...adminTemplates.map(p => ({...p, policyType: 'Administrative Template'}))
            ];
            
            const policy = allPolicies.find(p => p.id === policyId);
            if (!policy) return;
            
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = `Policy Details: ${policy.displayName || policy.name}`;
            
            modalBody.innerHTML = `
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Policy Name</div>
                        <div class="detail-value">${policy.displayName || policy.name || 'Unnamed'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Policy Type</div>
                        <div class="detail-value"><span class="policy-tag">${policy.policyType}</span></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Description</div>
                        <div class="detail-value">${policy.description || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Platform</div>
                        <div class="detail-value">${policy.platform || policy.platforms || 'All'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Created Date</div>
                        <div class="detail-value">${formatDate(policy.createdDateTime)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Last Modified</div>
                        <div class="detail-value">${formatDate(policy.lastModifiedDateTime)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Version</div>
                        <div class="detail-value">${policy.version || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Policy ID</div>
                        <div class="detail-value" style="font-family: monospace; font-size: 12px;">${policy.id}</div>
                    </div>
                </div>
            `;
            
            showModal();
        }

        function showModal() {
            document.getElementById('detailModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const detailModal = document.getElementById('detailModal');
            
            if (event.target === detailModal) {
                closeModal();
            }
            
            // Close export dropdowns if clicked outside
            if (!event.target.closest('.export-menu')) { // Use .closest to check if click is within the menu
                document.querySelectorAll('.export-dropdown').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        }
    </script>
</body>
</html>
