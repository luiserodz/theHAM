<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows Update Report Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section.dragover {
            border-color: #0078d4;
            background: #e7f3ff;
        }

        .upload-icon {
            font-size: 3em;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .upload-section h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .btn {
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,120,212,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .data-preview {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .data-preview.show {
            display: block;
        }

        .preview-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
        }

        .preview-content {
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .preview-table th,
        .preview-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .report-options {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
            display: none;
        }

        .report-options.show {
            display: block;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0,120,212,0.1);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
        }

        .status-section {
            background: #e7f3ff;
            border: 1px solid #0078d4;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .status-section.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .sample-format {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
        }

        .charts-preview {
            display: none;
            margin: 20px 0;
        }

        .charts-preview.show {
            display: block;
        }

        .chart-container {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }

        #downloadSection {
            text-align: center;
            margin: 30px 0;
            display: none;
        }

        #downloadSection.show {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #0078d4;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        .severity-critical { color: #dc3545; }
        .severity-important { color: #fd7e14; }
        .severity-moderate { color: #ffc107; }
        .severity-low { color: #28a745; }
        .severity-none { color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Windows Update Report Generator</h1>
            <p>Upload your CSV data and generate comprehensive PDF reports with charts and analytics</p>
        </div>

        <div class="main-content">
            <!-- File Upload Section -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">üìÅ</div>
                <h3>Upload Your Windows Update CSV File</h3>
                <p>Drag and drop your CSV file here, or click to browse</p>
                
                <div class="file-input-wrapper">
                    <button class="btn" id="chooseFileBtn">Choose CSV File</button>
                    <input type="file" id="csvFile" accept=".csv" style="display: none;" />
                </div>

                <div class="sample-format">
                    <strong>Expected CSV Format:</strong><br>
                    Update Name, Version, Security Severity, Release Date, Updates Missing, Recently Deployed, Details
                </div>

                <button class="btn btn-secondary" id="downloadSample">Download Sample CSV</button>
            </div>

            <!-- Data Preview Section -->
            <div class="data-preview" id="dataPreview">
                <div class="preview-header">
                    üìã Data Preview
                </div>
                <div class="preview-content">
                    <div id="dataStats" class="stats-grid"></div>
                    <table class="preview-table" id="previewTable"></table>
                </div>
            </div>

            <!-- Report Options Section -->
            <div class="report-options" id="reportOptions">
                <h3>üìã Report Configuration</h3>
                
                <div class="options-grid">
                    <div class="form-group">
                        <label for="reportTitle">Report Title</label>
                        <input type="text" id="reportTitle" value="Windows Update Compliance Report" />
                    </div>
                    
                    <div class="form-group">
                        <label for="organizationName">Organization Name</label>
                        <input type="text" id="organizationName" placeholder="Your Organization" />
                    </div>
                    
                    <div class="form-group">
                        <label for="reportPeriod">Report Period</label>
                        <input type="text" id="reportPeriod" placeholder="e.g., July 2025" />
                    </div>
                    
                    <div class="form-group">
                        <label for="reportTheme">Report Theme</label>
                        <select id="reportTheme">
                            <option value="professional">Professional Blue</option>
                            <option value="corporate">Corporate Gray</option>
                            <option value="modern">Modern Purple</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Include in Report</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeSummary" checked />
                            <label for="includeSummary">Executive Summary</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeSeverityChart" checked />
                            <label for="includeSeverityChart">Security Severity Chart</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeDeploymentChart" checked />
                            <label for="includeDeploymentChart">Deployment Status Chart</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeTrendChart" checked />
                            <label for="includeTrendChart">Monthly Trend Chart</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeDetailTable" checked />
                            <label for="includeDetailTable">Detailed Update Table</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeRecommendations" checked />
                            <label for="includeRecommendations">Recommendations</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="additionalNotes">Additional Notes</label>
                    <textarea id="additionalNotes" rows="3" placeholder="Add any custom notes or observations for this report period..."></textarea>
                </div>

                <button class="btn btn-success" id="generateReport" disabled>
                    üéØ Generate PDF Report
                </button>
            </div>

            <!-- Charts Preview Section -->
            <div class="charts-preview" id="chartsPreview">
                <h3>üìà Report Preview</h3>
                
                <div class="chart-container" style="height: 350px;">
                    <div class="chart-title">Security Severity Distribution</div>
                    <canvas id="severityChart"></canvas>
                </div>
                
                <div class="chart-container" style="height: 500px;">
                    <div class="chart-title">Deployment Status Overview</div>
                    <canvas id="deploymentChart"></canvas>
                </div>
                
                <div class="chart-container" style="height: 400px;">
                    <div class="chart-title">Updates by Release Month</div>
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Status Section -->
            <div class="status-section" id="statusSection">
                <h4>üîÑ Generating Report...</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <p id="statusText">Preparing report generation...</p>
            </div>

            <!-- Download Section -->
            <div id="downloadSection">
                <div class="alert alert-success">
                    ‚úÖ Report generated successfully!
                </div>
                <a href="#" id="downloadLink" class="btn btn-success">
                    üì• Download PDF Report
                </a>
            </div>
        </div>
    </div>

    <!-- Include Chart.js for data visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Include jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Include jsPDF AutoTable plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // Global variables
        let csvData = [];
        let charts = {};
        
        // DOM elements
        const csvFile = document.getElementById('csvFile');
        const chooseFileBtn = document.getElementById('chooseFileBtn');
        const uploadSection = document.getElementById('uploadSection');
        const dataPreview = document.getElementById('dataPreview');
        const reportOptions = document.getElementById('reportOptions');
        const chartsPreview = document.getElementById('chartsPreview');
        const statusSection = document.getElementById('statusSection');
        const downloadSection = document.getElementById('downloadSection');
        const generateReportBtn = document.getElementById('generateReport');
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Windows Update Report Generator initializing...');
            setupEventListeners();
            loadSavedPreferences();
            console.log('Initialization complete');
        });
        
        function setupEventListeners() {
            // File upload button
            chooseFileBtn.addEventListener('click', () => {
                csvFile.click();
            });
            
            // File input change
            csvFile.addEventListener('change', handleFileUpload);
            
            // Drag and drop
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });
            
            uploadSection.addEventListener('dragleave', () => {
                uploadSection.classList.remove('dragover');
            });
            
            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.endsWith('.csv')) {
                    csvFile.files = files;
                    handleFileUpload();
                }
            });
            
            // Sample CSV download
            document.getElementById('downloadSample').addEventListener('click', downloadSampleCSV);
            
            // Generate report button
            generateReportBtn.addEventListener('click', generatePDFReport);
            
            // Save form data on change
            document.querySelectorAll('#reportOptions input, #reportOptions select, #reportOptions textarea').forEach(element => {
                element.addEventListener('change', saveFormData);
            });
        }
        
        function handleFileUpload() {
            const file = csvFile.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseCSVData(e.target.result);
                    showDataPreview();
                    showReportOptions();
                    generateCharts();
                    generateReportBtn.disabled = false;
                    showAlert('File uploaded successfully!', 'success');
                } catch (error) {
                    showAlert('Error parsing CSV file: ' + error.message, 'error');
                    console.error('Parse error:', error);
                }
            };
            reader.onerror = function() {
                showAlert('Error reading file', 'error');
            };
            reader.readAsText(file);
        }
        
        function parseCSVData(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) {
                throw new Error('CSV file must contain headers and at least one data row');
            }
            
            // Parse headers
            const headers = parseCSVLine(lines[0]);
            
            // Parse data rows
            csvData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index] || '';
                    });
                    if (row['Update Name']) { // Only add rows with update names
                        csvData.push(row);
                    }
                }
            }
            
            if (csvData.length === 0) {
                throw new Error('No valid data found in CSV');
            }
            
            console.log('Parsed CSV data:', csvData.length, 'rows');
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }
        
        function showDataPreview() {
            if (csvData.length === 0) return;
            
            // Generate statistics
            const stats = generateStatistics();
            displayStatistics(stats);
            
            // Show first 10 rows in table
            const table = document.getElementById('previewTable');
            const headers = Object.keys(csvData[0]);
            
            let tableHTML = '<thead><tr>';
            headers.forEach(h => {
                tableHTML += `<th>${h}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            csvData.slice(0, 10).forEach(row => {
                tableHTML += '<tr>';
                headers.forEach(h => {
                    const value = row[h];
                    const className = getSeverityClass(value);
                    tableHTML += `<td class="${className}">${value}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody>';
            table.innerHTML = tableHTML;
            
            dataPreview.classList.add('show');
        }
        
        function generateStatistics() {
            const totalUpdates = csvData.length;
            
            // Parse numbers correctly, removing any non-numeric characters
            const totalMissing = csvData.reduce((sum, row) => {
                const missing = parseInt(row['Updates Missing']?.toString().replace(/\D/g, '') || '0');
                return sum + (isNaN(missing) ? 0 : missing);
            }, 0);
            
            const totalDeployed = csvData.reduce((sum, row) => {
                const deployed = parseInt(row['Recently Deployed']?.toString().replace(/\D/g, '') || '0');
                return sum + (isNaN(deployed) ? 0 : deployed);
            }, 0);
            
            const severityCounts = csvData.reduce((acc, row) => {
                const severity = row['Security Severity'] || 'None';
                acc[severity] = (acc[severity] || 0) + 1;
                return acc;
            }, {});
            
            const criticalUpdates = severityCounts['Critical'] || 0;
            const importantUpdates = severityCounts['Important'] || 0;
            
            // Calculate compliance rate
            const totalDeploymentTargets = totalDeployed + totalMissing;
            const complianceRate = totalDeploymentTargets > 0 ? Math.round((totalDeployed / totalDeploymentTargets) * 100) : 100;
            
            return {
                totalUpdates,
                totalMissing,
                totalDeployed,
                criticalUpdates,
                importantUpdates,
                severityCounts,
                complianceRate
            };
        }
        
        function displayStatistics(stats) {
            const statsContainer = document.getElementById('dataStats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalUpdates}</div>
                    <div class="stat-label">Total Updates</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number severity-critical">${stats.criticalUpdates}</div>
                    <div class="stat-label">Critical Updates</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number severity-important">${stats.importantUpdates}</div>
                    <div class="stat-label">Important Updates</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.totalMissing}</div>
                    <div class="stat-label">Missing Deployments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.complianceRate}%</div>
                    <div class="stat-label">Compliance Rate</div>
                </div>
            `;
        }
        
        function getSeverityClass(value) {
            if (!value) return '';
            const severity = value.toString().toLowerCase();
            if (severity.includes('critical')) return 'severity-critical';
            if (severity.includes('important')) return 'severity-important';
            if (severity.includes('moderate')) return 'severity-moderate';
            if (severity.includes('low')) return 'severity-low';
            return '';
        }
        
        function showReportOptions() {
            reportOptions.classList.add('show');
        }
        
        function generateCharts() {
            generateSeverityChart();
            generateDeploymentChart();
            generateTrendChart();
            chartsPreview.classList.add('show');
        }
        
        function generateSeverityChart() {
            const ctx = document.getElementById('severityChart').getContext('2d');
            
            const severityCounts = csvData.reduce((acc, row) => {
                const severity = row['Security Severity'] || 'None';
                acc[severity] = (acc[severity] || 0) + 1;
                return acc;
            }, {});
            
            const colors = {
                'Critical': '#dc3545',
                'Important': '#fd7e14',
                'Moderate': '#ffc107',
                'Low': '#28a745',
                'None': '#6c757d'
            };
            
            if (charts.severity) {
                charts.severity.destroy();
            }
            
            // Calculate percentages for display
            const total = Object.values(severityCounts).reduce((a, b) => a + b, 0);
            const dataWithPercentages = Object.keys(severityCounts).map(key => {
                const value = severityCounts[key];
                const percentage = ((value / total) * 100).toFixed(1);
                return `${key} (${percentage}%)`;
            });
            
            charts.severity = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: dataWithPercentages,
                    datasets: [{
                        data: Object.values(severityCounts),
                        backgroundColor: Object.keys(severityCounts).map(s => colors[s] || '#6c757d'),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 14,
                                },
                                boxWidth: 25,
                                padding: 15,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: label,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    }));
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    return `${label}: ${value} updates`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function generateDeploymentChart() {
            const ctx = document.getElementById('deploymentChart').getContext('2d');
            
            const deploymentData = csvData.map(row => ({
                name: row['Update Name'],
                deployed: parseInt(row['Recently Deployed']?.toString().replace(/\D/g, '') || '0'),
                missing: parseInt(row['Updates Missing']?.toString().replace(/\D/g, '') || '0')
            }))
            .filter(d => d.deployed > 0 || d.missing > 0)
            .sort((a, b) => (b.deployed + b.missing) - (a.deployed + a.missing))
            .slice(0, 10);
            
            if (charts.deployment) {
                charts.deployment.destroy();
            }
            
            charts.deployment = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: deploymentData.map(d => {
                        // Better truncation with full name in tooltip
                        if (d.name.length > 50) {
                            return d.name.substring(0, 47) + '...';
                        }
                        return d.name;
                    }),
                    datasets: [
                        {
                            label: 'Deployed',
                            data: deploymentData.map(d => d.deployed),
                            backgroundColor: '#28a745',
                            borderWidth: 1,
                            borderColor: '#1e7e34'
                        },
                        {
                            label: 'Pending Updates',
                            data: deploymentData.map(d => d.missing),
                            backgroundColor: '#dc3545',
                            borderWidth: 1,
                            borderColor: '#bd2130'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                },
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 14,
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: (context) => {
                                    // Show full name in tooltip
                                    return [deploymentData[context[0].dataIndex].name];
                                },
                                label: (context) => {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    const total = deploymentData[context.dataIndex].deployed + deploymentData[context.dataIndex].missing;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} systems (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function generateTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // Group by month from Release Date
            const monthCounts = {};
            
            csvData.forEach(row => {
                const dateStr = row['Release Date'];
                if (dateStr) {
                    try {
                        const date = new Date(dateStr.replace(/-/g, '/')); // More reliable parsing
                        if (!isNaN(date.getTime())) {
                            const monthKey = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                            monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
                        }
                    } catch (e) {
                        console.warn(`Could not parse date: ${dateStr}`);
                    }
                }
            });
            
            if (charts.trend) {
                charts.trend.destroy();
            }
            
            const sortedMonths = Object.keys(monthCounts).sort((a, b) => new Date(a) - new Date(b));
            
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Updates Released',
                        data: sortedMonths.map(month => monthCounts[month]),
                        borderColor: '#0078d4',
                        backgroundColor: 'rgba(0, 120, 212, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#0078d4',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                         x: {
                            ticks: {
                                font: {
                                    size: 14,
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 14,
                                },
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    return `${context.dataset.label}: ${context.parsed.y} updates`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        async function generatePDFReport() {
            statusSection.classList.add('show');
            updateProgress(0, 'Initializing report generation...');
            
            try {
                // Initialize jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                updateProgress(10, 'Creating report structure...');
                
                // Get form values
                const reportTitle = document.getElementById('reportTitle').value;
                const orgName = document.getElementById('organizationName').value;
                const reportPeriod = document.getElementById('reportPeriod').value;
                const additionalNotes = document.getElementById('additionalNotes').value;
                
                // Generate report content
                await createPDFContent(pdf, {
                    title: reportTitle,
                    organization: orgName,
                    period: reportPeriod,
                    notes: additionalNotes
                });
                
                updateProgress(100, 'Report generation complete!');
                
                // Create download link
                const pdfBlob = pdf.output('blob');
                const url = URL.createObjectURL(pdfBlob);
                const downloadLink = document.getElementById('downloadLink');
                downloadLink.href = url;
                downloadLink.download = `${reportTitle.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;
                
                // Show download section
                downloadSection.classList.add('show');
                statusSection.classList.remove('show');
                
                // Scroll to download section
                downloadSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showAlert('Error generating PDF: ' + error.message, 'error');
                statusSection.classList.remove('show');
            }
        }
        
        async function createPDFContent(pdf, config) {
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            let currentPage = 1;
            
            // --- TITLE PAGE ---
            updateProgress(20, 'Creating title page...');
            
            // Header
            pdf.setFillColor(0, 120, 212);
            pdf.rect(0, 0, pageWidth, 40, 'F');
            
            // Title
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(24);
            pdf.text(config.title, pageWidth / 2, 20, { align: 'center' });
            
            // Organization
            if (config.organization) {
                pdf.setFontSize(14);
                pdf.text(config.organization, pageWidth / 2, 32, { align: 'center' });
            }
            
            pdf.setTextColor(0, 0, 0);
            
            // Info box
            pdf.setFillColor(248, 249, 250);
            pdf.rect(20, 50, pageWidth - 40, 25, 'F');
            
            pdf.setFontSize(11);
            pdf.text(`Period: ${config.period || 'Current'}`, pageWidth / 2, 58, { align: 'center' });
            pdf.text(`Generated: ${new Date().toLocaleDateString()}`, pageWidth / 2, 67, { align: 'center' });
            
            // Statistics
            const stats = generateStatistics();
            let y = 85;
            
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Executive Summary', pageWidth / 2, y, { align: 'center' });
            
            y += 12;
            
            // Metric boxes
            const metrics = [
                { label: 'Total Updates', value: stats.totalUpdates, color: [0, 120, 212] },
                { label: 'Critical', value: stats.criticalUpdates, color: [220, 53, 69] },
                { label: 'Compliance', value: stats.complianceRate + '%', color: [40, 167, 69] },
                { label: 'Pending Updates', value: stats.totalMissing, color: [253, 126, 20] },
                { label: 'Deployed', value: stats.totalDeployed, color: [40, 167, 69] }
            ];
            
            const boxWidth = 30;
            const boxHeight = 20;
            const cols = 3;
            const rows = Math.ceil(metrics.length / cols);
            
            for (let row = 0; row < rows; row++) {
                const rowMetrics = metrics.slice(row * cols, (row + 1) * cols);
                const startX = (pageWidth - (rowMetrics.length * boxWidth + (rowMetrics.length - 1) * 10)) / 2;
                
                rowMetrics.forEach((metric, i) => {
                    const x = startX + (i * (boxWidth + 10));
                    const boxY = y + (row * (boxHeight + 8));
                    
                    pdf.setFillColor(...metric.color);
                    pdf.rect(x, boxY, boxWidth, boxHeight, 'F');
                    
                    pdf.setTextColor(255, 255, 255);
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(metric.value.toString(), x + boxWidth / 2, boxY + 8, { align: 'center' });
                    
                    pdf.setFontSize(7);
                    pdf.setFont(undefined, 'normal');
                    pdf.text(metric.label, x + boxWidth / 2, boxY + 15, { align: 'center' });
                });
            }
            
            pdf.setTextColor(0, 0, 0);
            
            // Key Insights - Enhanced layout
            y += (rows * (boxHeight + 8)) + 15;
            
            // Add background for insights section
            pdf.setFillColor(248, 249, 250);
            pdf.rect(15, y - 5, pageWidth - 30, 40, 'F');
            
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('Key Insights', 20, y);
            y += 8;
            
            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            
            const insights = [
                `‚Ä¢ ${stats.totalUpdates} total updates tracked across systems`,
                `‚Ä¢ ${stats.complianceRate}% deployment compliance rate`,
                stats.criticalUpdates > 0 ? 
                    `‚Ä¢ ${stats.criticalUpdates} critical updates require immediate attention` :
                    `‚Ä¢ All critical updates deployed successfully`,
                `‚Ä¢ ${stats.totalMissing} deployments pending completion`
            ];
            
            insights.forEach((insight, index) => {
                if (y > pageHeight - 20) return;
                
                // Add icon or bullet with color coding
                if (insight.includes('critical') && stats.criticalUpdates > 0) {
                    pdf.setTextColor(220, 53, 69); // Red for critical
                } else if (insight.includes('compliance')) {
                    pdf.setTextColor(40, 167, 69); // Green for compliance
                } else {
                    pdf.setTextColor(0, 0, 0);
                }
                
                pdf.text(insight, 25, y);
                y += 6;
            });
            
            pdf.setTextColor(0, 0, 0);
            
            // Add note if additional notes exist
            if (config.notes) {
                y += 10;
                pdf.setFillColor(255, 243, 224); // Light yellow background
                pdf.rect(15, y - 5, pageWidth - 30, 30, 'F');
                
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                pdf.text('Additional Notes:', 20, y);
                y += 6;
                
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'normal');
                const noteLines = pdf.splitTextToSize(config.notes, pageWidth - 40);
                noteLines.forEach(line => {
                    if (y > pageHeight - 20) return;
                    pdf.text(line, 20, y);
                    y += 5;
                });
            }
            
            // --- CHARTS PAGE(S) ---
            updateProgress(40, 'Adding charts and analysis...');
            
            // Start new page for charts
            pdf.addPage();
            currentPage++;
            y = 25; // Increased from 20 to move content down
            
            // Add page header with gradient effect
            pdf.setFillColor(240, 248, 255);
            pdf.rect(0, 0, pageWidth, 18, 'F'); // Slightly taller header
            
            // Add accent line
            pdf.setDrawColor(0, 120, 212);
            pdf.setLineWidth(0.5);
            pdf.line(0, 18, pageWidth, 18);
            
            pdf.setFontSize(12); // Larger header font
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(51, 51, 51);
            pdf.text('Charts & Analysis', 15, 11);
            
            // Add page number
            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            pdf.setTextColor(108, 117, 125);
            pdf.text(`Page ${currentPage}`, pageWidth - 20, 11, { align: 'right' });
            
            pdf.setTextColor(0, 0, 0);
            
            // Chart dimensions optimized for better page usage
            const chartWidth = pageWidth - 40; // Slightly narrower for better margins
            const chartHeight = 65; // Optimized height
            
            // Security Severity Chart
            if (document.getElementById('includeSeverityChart').checked && charts.severity) {
                // Add subtle background for chart section
                pdf.setFillColor(250, 252, 255);
                pdf.rect(10, y - 5, pageWidth - 20, chartHeight + 100, 'F');
                
                // Chart title with better styling
                pdf.setFontSize(13);
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(0, 78, 120);
                pdf.text('Security Severity Distribution ‚Äì Weekly Summary', 15, y);
                pdf.setTextColor(0, 0, 0);
                y += 10;
                
                // Add the chart with border
                pdf.setDrawColor(220, 220, 220);
                pdf.setLineWidth(0.5);
                pdf.rect(20, y - 2, chartWidth - 10, chartHeight + 4);
                
                await addCompactChartToPDF(pdf, 'severityChart', '', 20, y, chartWidth - 10, chartHeight);
                y += chartHeight + 8;
                
                // Detailed explanation with better formatting
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                
                // Introduction with background
                pdf.setFillColor(248, 249, 250);
                pdf.rect(15, y - 2, pageWidth - 30, 20, 'F');
                
                const lines1 = pdf.splitTextToSize('For the updates released or discovered this week, the following breakdown was observed:', pageWidth - 35);
                lines1.forEach(line => {
                    pdf.text(line, 18, y + 3);
                    y += 5;
                });
                y += 8;
                
                // Breakdown details in a styled box
                pdf.setFillColor(255, 255, 255);
                pdf.rect(20, y - 2, pageWidth - 40, 20, 'F');
                pdf.setDrawColor(0, 120, 212);
                pdf.setLineWidth(0.3);
                pdf.rect(20, y - 2, pageWidth - 40, 20);
                
                pdf.setFont(undefined, 'bold');
                const criticalCount = stats.criticalUpdates;
                const criticalPercent = Math.round((criticalCount / stats.totalUpdates) * 100);
                pdf.setTextColor(220, 53, 69); // Red for critical
                pdf.text(`‚Ä¢ Critical: ${criticalCount} updates (${criticalPercent}%)`, 25, y + 3);
                y += 6;
                
                const importantCount = stats.importantUpdates;
                const importantPercent = Math.round((importantCount / stats.totalUpdates) * 100);
                pdf.setTextColor(253, 126, 20); // Orange for important
                pdf.text(`‚Ä¢ Important: ${importantCount} updates (${importantPercent}%)`, 25, y + 3);
                y += 6;
                
                const otherCount = stats.totalUpdates - criticalCount - importantCount;
                const otherPercent = Math.round((otherCount / stats.totalUpdates) * 100);
                pdf.setTextColor(108, 117, 125); // Gray for other
                pdf.text(`‚Ä¢ Unspecified or Low: ${otherCount} updates (${otherPercent}%)`, 25, y + 3);
                y += 10;
                
                pdf.setTextColor(0, 0, 0);
                pdf.setFont(undefined, 'normal');
                pdf.setFontSize(9);
                
                const cvssExplanation = [
                    'The severity of each update is assessed using the Common Vulnerability Scoring System (CVSS).',
                    '‚Ä¢ Critical updates are typically reserved for vulnerabilities that could allow remote code execution without user interaction.',
                    '‚Ä¢ Important updates address serious but less severe issues, such as privilege escalation or denial of service.',
                    '‚Ä¢ Unspecified or Low refers to updates that either lack a published CVSS score at the time of reporting or are not classified as high-impact. These often include updates related to feature improvements, stability fixes, or pending vendor analysis.',
                    'We continue to monitor and triage these updates as part of your Intune Maintenance plan.'
                ];
                
            cvssExplanation.forEach((text, index) => {
                if (y > pageHeight - 30) {
                    pdf.addPage();
                    currentPage++;
                    y = 25;
                    // Add page header
                    pdf.setFillColor(240, 248, 255);
                    pdf.rect(0, 0, pageWidth, 18, 'F');
                    pdf.setDrawColor(0, 120, 212);
                    pdf.setLineWidth(0.5);
                    pdf.line(0, 18, pageWidth, 18);
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'bold');
                    pdf.setTextColor(51, 51, 51);
                    pdf.text('Charts & Analysis (continued)', 15, 11);
                    pdf.setFontSize(9);
                    pdf.setFont(undefined, 'normal');
                    pdf.setTextColor(108, 117, 125);
                    pdf.text(`Page ${currentPage}`, pageWidth - 20, 11, { align: 'right' });
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFontSize(9);
                    pdf.setFont(undefined, 'normal');
                }
                
                // Emphasize the first line
                if (index === 0) {
                    pdf.setFont(undefined, 'bold');
                } else {
                    pdf.setFont(undefined, 'normal');
                }
                
                const lines = pdf.splitTextToSize(text, pageWidth - 35);
                lines.forEach(line => {
                    pdf.text(line, text.startsWith('‚Ä¢') ? 25 : 18, y);
                    y += 5;
                });
            });
                y += 15; // Space before next chart
            }
            
            // Check if we need a new page
            if (y > pageHeight - 140) {
                pdf.addPage();
                currentPage++;
                y = 25;
                
                // Add page header
                pdf.setFillColor(240, 248, 255);
                pdf.rect(0, 0, pageWidth, 18, 'F');
                pdf.setDrawColor(0, 120, 212);
                pdf.setLineWidth(0.5);
                pdf.line(0, 18, pageWidth, 18);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(51, 51, 51);
                pdf.text('Charts & Analysis (continued)', 15, 11);
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'normal');
                pdf.setTextColor(108, 117, 125);
                pdf.text(`Page ${currentPage}`, pageWidth - 20, 11, { align: 'right' });
                pdf.setTextColor(0, 0, 0);
            }
            
            // Deployment Status Chart
            if (document.getElementById('includeDeploymentChart').checked && charts.deployment) {
                // Add subtle background for chart section
                pdf.setFillColor(250, 252, 255);
                pdf.rect(10, y - 5, pageWidth - 20, chartHeight + 100, 'F');
                
                // Chart title
                pdf.setFontSize(13);
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(0, 78, 120);
                pdf.text('Deployment Summary ‚Äì Top 10 Updates by Volume', 15, y);
                pdf.setTextColor(0, 0, 0);
                y += 10;
                
                // Add the chart with border
                pdf.setDrawColor(220, 220, 220);
                pdf.setLineWidth(0.5);
                pdf.rect(20, y - 2, chartWidth - 10, chartHeight + 4);
                
                await addCompactChartToPDF(pdf, 'deploymentChart', '', 20, y, chartWidth - 10, chartHeight);
                y += chartHeight + 8;
                
                // Detailed explanation
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                
                // Introduction with background
                pdf.setFillColor(248, 249, 250);
                pdf.rect(15, y - 2, pageWidth - 30, 20, 'F');
                
                const deploymentIntro = pdf.splitTextToSize('For this reporting period, the following deployment data was observed across the top 10 updates with the highest number of assigned devices:', pageWidth - 35);
                deploymentIntro.forEach(line => {
                    pdf.text(line, 18, y + 3);
                    y += 5;
                });
                y += 8;
                
                // Deployment stats in styled box
                pdf.setFillColor(255, 255, 255);
                pdf.rect(20, y - 2, pageWidth - 40, 14, 'F');
                pdf.setDrawColor(40, 167, 69);
                pdf.setLineWidth(0.3);
                pdf.rect(20, y - 2, pageWidth - 40, 14);
                
                pdf.setFont(undefined, 'bold');
                pdf.text(`‚Ä¢ Total missing deployments: ${stats.totalMissing}`, 25, y + 3);
                y += 6;
                pdf.text(`‚Ä¢ Overall compliance rate: ${stats.complianceRate}%`, 25, y + 3);
                y += 10;
                
                pdf.setFont(undefined, 'normal');
                pdf.setFontSize(9);
                
                // Find the update with most missing deployments
                const topMissingUpdate = csvData
                    .map(row => ({
                        name: row['Update Name'],
                        missing: parseInt(row['Updates Missing']?.toString().replace(/\D/g, '') || '0')
                    }))
                    .sort((a, b) => b.missing - a.missing)[0];
                
                const deploymentExplanation = [
                    'This chart highlights updates with the largest number of total targets (both successful and pending). Green bars represent successfully deployed updates, while red bars indicate devices where the update is still pending or failed.',
                    topMissingUpdate && topMissingUpdate.missing > 0 ? 
                        `High-miss updates such as "${topMissingUpdate.name.substring(0, 60)}${topMissingUpdate.name.length > 60 ? '...' : ''}" may require review of deployment assignments, application version conflicts, or device connectivity status.` :
                        'All updates show good deployment coverage with minimal missing installations.',
                    'This data is used to help identify:',
                    '‚Ä¢ Trends in common deployment failures',
                    '‚Ä¢ Apps with wide install footprints but low coverage',
                    '‚Ä¢ Potential priorities for remediation in the next patch cycle'
                ];
                
                deploymentExplanation.forEach((text, index) => {
                    if (y > pageHeight - 30) {
                        pdf.addPage();
                        currentPage++;
                        y = 25;
                        // Add page header
                        pdf.setFillColor(240, 248, 255);
                        pdf.rect(0, 0, pageWidth, 18, 'F');
                        pdf.setDrawColor(0, 120, 212);
                        pdf.setLineWidth(0.5);
                        pdf.line(0, 18, pageWidth, 18);
                        pdf.setFontSize(12);
                        pdf.setFont(undefined, 'bold');
                        pdf.setTextColor(51, 51, 51);
                        pdf.text('Charts & Analysis (continued)', 15, 11);
                        pdf.setFontSize(9);
                        pdf.setFont(undefined, 'normal');
                        pdf.setTextColor(108, 117, 125);
                        pdf.text(`Page ${currentPage}`, pageWidth - 20, 11, { align: 'right' });
                        pdf.setTextColor(0, 0, 0);
                        pdf.setFontSize(9);
                        pdf.setFont(undefined, 'normal');
                    }
                    
                    // Emphasize the identification section
                    if (text === 'This data is used to help identify:') {
                        pdf.setFont(undefined, 'bold');
                    } else {
                        pdf.setFont(undefined, 'normal');
                    }
                    
                    const lines = pdf.splitTextToSize(text, pageWidth - 35);
                    lines.forEach(line => {
                        pdf.text(line, text.startsWith('‚Ä¢') ? 25 : 18, y);
                        y += 5;
                    });
                });
                
                y += 15;
            }
            
            // Check if we need a new page for trend chart
            if (y > pageHeight - 140) {
                pdf.addPage();
                currentPage++;
                y = 25;
                
                // Add page header
                pdf.setFillColor(240, 248, 255);
                pdf.rect(0, 0, pageWidth, 18, 'F');
                pdf.setDrawColor(0, 120, 212);
                pdf.setLineWidth(0.5);
                pdf.line(0, 18, pageWidth, 18);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(51, 51, 51);
                pdf.text('Charts & Analysis (continued)', 15, 11);
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'normal');
                pdf.setTextColor(108, 117, 125);
                pdf.text(`Page ${currentPage}`, pageWidth - 20, 11, { align: 'right' });
                pdf.setTextColor(0, 0, 0);
            }
            
            // Trend Chart
            if (document.getElementById('includeTrendChart').checked && charts.trend) {
                // Add subtle background for chart section
                pdf.setFillColor(250, 252, 255);
                pdf.rect(10, y - 5, pageWidth - 20, chartHeight + 100, 'F');
                
                // Chart title
                pdf.setFontSize(13);
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(0, 78, 120);
                pdf.text('Update Release Timeline ‚Äì Overview', 15, y);
                pdf.setTextColor(0, 0, 0);
                y += 10;
                
                // Add the chart with border
                pdf.setDrawColor(220, 220, 220);
                pdf.setLineWidth(0.5);
                pdf.rect(20, y - 2, chartWidth - 10, chartHeight + 4);
                
                await addCompactChartToPDF(pdf, 'trendChart', '', 20, y, chartWidth - 10, chartHeight);
                y += chartHeight + 8;
                
                // Detailed explanation
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                
                // Get trend data
                const monthCounts = {};
                csvData.forEach(row => {
                    const dateStr = row['Release Date'];
                    if (dateStr) {
                        try {
                            const date = new Date(dateStr.replace(/-/g, '/'));
                            if (!isNaN(date.getTime())) {
                                const monthKey = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                                monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
                            }
                        } catch (e) {
                            // Ignore parse errors
                        }
                    }
                });
                
                const sortedMonths = Object.keys(monthCounts).sort((a, b) => new Date(a) - new Date(b));
                const latestMonth = sortedMonths[sortedMonths.length - 1];
                const latestCount = monthCounts[latestMonth] || 0;
                const firstMonth = sortedMonths[0];
                
                // Determine trend
                let trendDescription = 'Consistent month-over-month';
                if (sortedMonths.length >= 3) {
                    const recentCounts = sortedMonths.slice(-3).map(m => monthCounts[m]);
                    const avgRecent = recentCounts.reduce((a, b) => a + b, 0) / recentCounts.length;
                    const olderCounts = sortedMonths.slice(0, -3).map(m => monthCounts[m]);
                    const avgOlder = olderCounts.length > 0 ? olderCounts.reduce((a, b) => a + b, 0) / olderCounts.length : avgRecent;
                    
                    if (avgRecent > avgOlder * 1.3) {
                        trendDescription = 'Significant increase';
                    } else if (avgRecent > avgOlder * 1.1) {
                        trendDescription = 'Gradual rise';
                    } else if (avgRecent < avgOlder * 0.7) {
                        trendDescription = 'Notable decrease';
                    }
                }
                
                // Introduction with background
                pdf.setFillColor(248, 249, 250);
                pdf.rect(15, y - 2, pageWidth - 30, 20, 'F');
                
                const trendIntro = pdf.splitTextToSize('This chart shows the number of updates released over time, reflecting ongoing maintenance and security operations:', pageWidth - 35);
                trendIntro.forEach(line => {
                    pdf.text(line, 18, y + 3);
                    y += 5;
                });
                y += 8;
                
                // Trend stats in styled box
                pdf.setFillColor(255, 255, 255);
                pdf.rect(20, y - 2, pageWidth - 40, 20, 'F');
                pdf.setDrawColor(0, 120, 212);
                pdf.setLineWidth(0.3);
                pdf.rect(20, y - 2, pageWidth - 40, 20);
                
                pdf.setFont(undefined, 'bold');
                pdf.text(`‚Ä¢ Update count (latest month): ${latestCount}`, 25, y + 3);
                y += 6;
                pdf.text(`‚Ä¢ Trend: ${trendDescription}`, 25, y + 3);
                y += 6;
                pdf.text(`‚Ä¢ Observation period: ${firstMonth} to ${latestMonth}`, 25, y + 3);
                y += 10;
                
                pdf.setFont(undefined, 'normal');
                pdf.setFontSize(9);
                
                const trendExplanation = [
                    'All updates are reviewed and addressed as part of our structured patch management process.',
                    '‚Ä¢ Releases follow Microsoft\'s Patch Tuesday schedule and include both first-party and third-party updates.',
                    '‚Ä¢ Elevated activity in certain months corresponds to major cumulative or security update cycles.',
                    '‚Ä¢ A consistent release pattern confirms that systems are being actively maintained in alignment with organizational policies and security standards.',
                    'We continue to take timely action on all identified updates to maintain compliance and minimize risk across your environment as part of your Intune Maintenance plan.'
                ];
                
                trendExplanation.forEach((text, index) => {
                    if (y > pageHeight - 30) {
                        pdf.addPage();
                        currentPage++;
                        y = 25;
                        // Add page header
                        pdf.setFillColor(240, 248, 255);
                        pdf.rect(0, 0, pageWidth, 18, 'F');
                        pdf.setDrawColor(0, 120, 212);
                        pdf.setLineWidth(0.5);
                        pdf.line(0, 18, pageWidth, 18);
                        pdf.setFontSize(12);
                        pdf.setFont(undefined, 'bold');
                        pdf.setTextColor(51, 51, 51);
                        pdf.text('Charts & Analysis (continued)', 15, 11);
                        pdf.setFontSize(9);
                        pdf.setFont(undefined, 'normal');
                        pdf.setTextColor(108, 117, 125);
                        pdf.text(`Page ${currentPage}`, pageWidth - 20, 11, { align: 'right' });
                        pdf.setTextColor(0, 0, 0);
                        pdf.setFontSize(9);
                        pdf.setFont(undefined, 'normal');
                    }
                    
                    // Emphasize the first line
                    if (index === 0) {
                        pdf.setFont(undefined, 'bold');
                    } else {
                        pdf.setFont(undefined, 'normal');
                    }
                    
                    const lines = pdf.splitTextToSize(text, pageWidth - 35);
                    lines.forEach(line => {
                        pdf.text(line, text.startsWith('‚Ä¢') ? 25 : 18, y);
                        y += 5;
                    });
                });
            }
        
        // Detailed table
        if (document.getElementById('includeDetailTable').checked) {
            updateProgress(70, 'Adding detailed table...');
            addDetailedTable(pdf);
        }
        
        updateProgress(90, 'Finalizing report...');
        // --- END OF CHARTS & ANALYSIS SECTION ---
        // Finalize PDF
    } // <-- Add this closing brace to end createPDFContent

    async function addCompactChartToPDF(pdf, chartId, title, x, y, width, height) {
            // Title is now added separately, so skip if empty
            if (title) {
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                pdf.text(title, x, y - 2);
            }
            
            // Get chart canvas
            const canvas = document.getElementById(chartId);
            if (!canvas) return;
            
            // Wait for chart to render
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Convert chart to image
            const imgData = canvas.toDataURL('image/png');
            
            // Calculate proper dimensions maintaining aspect ratio
            const aspectRatio = canvas.width / canvas.height;
            let imgWidth = width;
            let imgHeight = height;
            
            if (imgWidth / imgHeight > aspectRatio) {
                imgWidth = imgHeight * aspectRatio;
            } else {
                imgHeight = imgWidth / aspectRatio;
            }
            // Add image to PDF
            pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
        }
        
        function addDetailedTable(pdf) {
            pdf.addPage();
            const tableStartPage = pdf.internal.getNumberOfPages();
            
            // Enhanced header with gradient effect
            pdf.setFillColor(240, 248, 255);
            pdf.rect(0, 0, pdf.internal.pageSize.getWidth(), 18, 'F');
            
            // Add accent line
            pdf.setDrawColor(0, 120, 212);
            pdf.setLineWidth(0.5);
            pdf.line(0, 18, pdf.internal.pageSize.getWidth(), 18);
            
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(51, 51, 51);
            pdf.text('Detailed Update List', 15, 11);
            
            // Add page number
            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            pdf.setTextColor(108, 117, 125);
            pdf.text(`Page ${tableStartPage}`, pdf.internal.pageSize.getWidth() - 20, 11, { align: 'right' });
            
            pdf.setTextColor(0, 0, 0);
            
            // Add table description
            pdf.setFontSize(9);
            pdf.setFont(undefined, 'normal');
            pdf.text('Complete listing of all Windows updates tracked during this reporting period.', 15, 25);
            
            // Prepare table data - show full update names
            const tableData = csvData.map(row => {
                return [
                    row['Update Name'] || '',
                    row['Version'] || '',
                    row['Security Severity'] || 'Unspecified',
                    row['Release Date'] || '',
                    row['Updates Missing'] || '0',
                    row['Recently Deployed'] || '0'
                ];
            });
            
            // Add table with corrected column widths to fit page
            pdf.autoTable({
                head: [['Update Name', 'Version', 'Severity', 'Date', 'Pending Updates', 'Deployed']],
                body: tableData,
                startY: 32,
                theme: 'striped',
                headStyles: {
                    fillColor: [0, 120, 212],
                    fontSize: 8,
                    fontStyle: 'bold',
                    cellPadding: 2,
                    halign: 'center'
                },
                bodyStyles: {
                    fontSize: 7,
                    cellPadding: 1.5
                },
                alternateRowStyles: {
                    fillColor: [248, 249, 250]
                },
                columnStyles: {
                    0: { 
                        cellWidth: 80,  // Reduced to fit page
                        overflow: 'linebreak',
                        halign: 'left'
                    },
                    1: { 
                        cellWidth: 25,
                        halign: 'center'
                    },
                    2: { 
                        cellWidth: 22,
                        halign: 'center'
                    },
                    3: { 
                        cellWidth: 22,
                        halign: 'center'
                    },
                    4: { 
                        cellWidth: 15, 
                        halign: 'center',
                        fontStyle: 'bold'
                    },
                    5: { 
                        cellWidth: 15, 
                        halign: 'center',
                        fontStyle: 'bold'
                    }
                },
                margin: { left: 15, right: 15 },
                showHead: 'everyPage',
                tableWidth: 'auto', // Let autoTable calculate the width
                didDrawPage: function(data) {
                    // Add page header on continuation pages
                    if (data.pageNumber > 1) {
                        pdf.setFillColor(240, 248, 255);
                        pdf.rect(0, 0, pdf.internal.pageSize.getWidth(), 18, 'F');
                        
                        pdf.setDrawColor(0, 120, 212);
                        pdf.setLineWidth(0.5);
                        pdf.line(0, 18, pdf.internal.pageSize.getWidth(), 18);
                        
                        pdf.setFontSize(12);
                        pdf.setFont(undefined, 'bold');
                        pdf.setTextColor(51, 51, 51);
                        pdf.text('Detailed Update List (continued)', 15, 11);
                        
                        const currentPage = tableStartPage + data.pageNumber - 1;
                        pdf.setFontSize(9);
                        pdf.setFont(undefined, 'normal');
                        pdf.setTextColor(108, 117, 125);
                        pdf.text(`Page ${currentPage}`, pdf.internal.pageSize.getWidth() - 20, 11, { align: 'right' });
                        
                        pdf.setTextColor(0, 0, 0);
                    }
                },
                didParseCell: function(data) {
                    // Color code severity cells
                    if (data.column.index === 2 && data.cell.raw) {
                        const severity = data.cell.raw.toLowerCase();
                        if (severity.includes('critical')) {
                            data.cell.styles.textColor = [220, 53, 69];
                            data.cell.styles.fontStyle = 'bold';
                        } else if (severity.includes('important')) {
                            data.cell.styles.textColor = [253, 126, 20];
                            data.cell.styles.fontStyle = 'bold';
                        } else if (severity.includes('moderate')) {
                            data.cell.styles.textColor = [255, 193, 7];
                        } else if (severity.includes('low')) {
                            data.cell.styles.textColor = [40, 167, 69];
                        }
                    }
                    
                    // Highlight high missing counts
                    if (data.column.index === 4 && data.cell.raw) {
                        const missing = parseInt(data.cell.raw);
                        if (missing > 20) {
                            data.cell.styles.textColor = [220, 53, 69];
                        } else if (missing > 10) {
                            data.cell.styles.textColor = [253, 126, 20];
                        }
                    }
                    
                    // Highlight high deployment counts
                    if (data.column.index === 5 && data.cell.raw) {
                        const deployed = parseInt(data.cell.raw);
                        if (deployed >= 90) {
                            data.cell.styles.textColor = [40, 167, 69];
                        }
                    }
                }
            });
            
            // Add summary at the end of the table
            const finalY = pdf.lastAutoTable.finalY || pdf.internal.pageSize.getHeight() - 50;
            if (finalY < pdf.internal.pageSize.getHeight() - 40) {
                pdf.setFillColor(248, 249, 250);
                pdf.rect(15, finalY + 10, pdf.internal.pageSize.getWidth() - 30, 25, 'F');
                
                pdf.setFontSize(8);
                pdf.setFont(undefined, 'italic');
                pdf.text(`Table contains ${csvData.length} total updates. Updates are sorted by original data order.`, 18, finalY + 18);
                pdf.text('Color coding: Critical (Red), Important (Orange), Moderate (Yellow), Low (Green)', 18, finalY + 25);
                pdf.text('High missing counts (>10) are highlighted for attention.', 18, finalY + 32);
            }
        }
        
        function updateProgress(percentage, text) {
            const progressFill = document.getElementById('progressFill');
            const statusText = document.getElementById('statusText');
            
            progressFill.style.width = percentage + '%';
            progressFill.textContent = percentage + '%';
            statusText.textContent = text;
        }
        
        function downloadSampleCSV() {
            const sampleData = [
                ['Update Name', 'Version', 'Security Severity', 'Release Date', 'Updates Missing', 'Recently Deployed', 'Details'],
                ['Windows Security Update KB5034441', '2025-01', 'Critical', '2025-01-10', '15', '85', '1'],
                ['Microsoft Defender Definition Update', '1.403.2956.0', 'Important', '2025-01-12', '3', '97', '1'],
                ['Microsoft Edge Security Update', '120.0.2210.144', 'Important', '2025-01-08', '8', '92', '1'],
                ['Windows Cumulative Update KB5034439', '2025-01', 'Moderate', '2025-01-10', '22', '78', '1'],
                ['.NET Framework Security Update', '4.8.1', 'Important', '2025-02-09', '12', '88', '1'],
                ['Office Security Update KB5035552', '16.0.17425', 'Critical', '2025-02-11', '5', '95', '1'],
                ['Windows Defender Update', '1.404.123.0', 'Important', '2025-02-14', '10', '90', '1'],
                ['Visual C++ Redistributable Update', '14.38.33130', 'Moderate', '2024-12-05', '30', '70', '1'],
                ['Windows Malicious Software Removal Tool', '5.119', 'Low', '2024-12-12', '0', '100', '1'],
                ['SQL Server Security Update', '15.0.4360.1', 'Critical', '2024-12-12', '18', '82', '1']
            ];
            
            const csvContent = sampleData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample_update_data.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(alertDiv, mainContent.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        function saveFormData() {
            const formData = {
                reportTitle: document.getElementById('reportTitle').value,
                organizationName: document.getElementById('organizationName').value,
                reportPeriod: document.getElementById('reportPeriod').value,
                reportTheme: document.getElementById('reportTheme').value,
                additionalNotes: document.getElementById('additionalNotes').value,
                options: {
                    includeSummary: document.getElementById('includeSummary').checked,
                    includeSeverityChart: document.getElementById('includeSeverityChart').checked,
                    includeDeploymentChart: document.getElementById('includeDeploymentChart').checked,
                    includeTrendChart: document.getElementById('includeTrendChart').checked,
                    includeDetailTable: document.getElementById('includeDetailTable').checked,
                    includeRecommendations: document.getElementById('includeRecommendations').checked
                }
            };
            localStorage.setItem('updateReportFormData', JSON.stringify(formData));
        }
        
        function loadSavedPreferences() {
            // Auto-populate current month
            const currentMonth = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('reportPeriod').value = currentMonth;
            
            // Load saved form data
            const saved = localStorage.getItem('updateReportFormData');
            if (saved) {
                try {
                    const formData = JSON.parse(saved);
                    if (formData.organizationName) {
                        document.getElementById('organizationName').value = formData.organizationName;
                    }
                } catch (e) {
                    console.error('Error loading saved form data:', e);
                }
            }
        }
        
        // Test function to simulate the process
        function testPDFGeneration() {
            console.log('Testing PDF generation...');
            
            // Create test data
            csvData = [
                {'Update Name': 'Test Update 1', 'Version': '1.0', 'Security Severity': 'Critical', 'Release Date': '2025-01-01', 'Updates Missing': '10', 'Recently Deployed': '90'},
                {'Update Name': 'Test Update 2', 'Version': '2.0', 'Security Severity': 'Important', 'Release Date': '2025-01-15', 'Updates Missing': '5', 'Recently Deployed': '95'}
            ];
            
            // Enable the generate button
            generateReportBtn.disabled = false;
            
            // Show sections
            dataPreview.classList.add('show');
            reportOptions.classList.add('show');
            chartsPreview.classList.add('show');
            
            // Generate charts
            generateCharts();
            
            console.log('Test setup complete. Click "Generate PDF Report" to test.');
        }
        
        console.log('Windows Update Report Generator initialized successfully');
    </script>
</body>
</html>
