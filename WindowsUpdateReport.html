<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows Update Report Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section.dragover {
            border-color: #0078d4;
            background: #e7f3ff;
        }

        .upload-icon {
            font-size: 3em;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .upload-section h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .btn {
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,120,212,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .data-preview {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .data-preview.show {
            display: block;
        }

        .preview-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
        }

        .preview-content {
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .preview-table th,
        .preview-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .report-options {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
            display: none;
        }

        .report-options.show {
            display: block;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0,120,212,0.1);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
        }

        .status-section {
            background: #e7f3ff;
            border: 1px solid #0078d4;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .status-section.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .sample-format {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
        }

        .charts-preview {
            display: none;
            margin: 20px 0;
        }

        .charts-preview.show {
            display: block;
        }

        .chart-container {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
            height: 400px; /* Fix for stretching bug */
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }

        #downloadLink {
            display: none;
        }

        #downloadLink.show {
            display: inline-block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #0078d4;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        .severity-critical { color: #dc3545; }
        .severity-important { color: #fd7e14; }
        .severity-moderate { color: #ffc107; }
        .severity-low { color: #28a745; }
        .severity-none { color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Windows Update Report Generator</h1>
            <p>Upload your CSV data and generate comprehensive PDF reports with charts and analytics</p>
        </div>

        <div class="main-content">
            <!-- File Upload Section -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">üìÅ</div>
                <h3>Upload Your Windows Update CSV File</h3>
                <p>Drag and drop your CSV file here, or click to browse</p>
                
                <div class="file-input-wrapper">
                    <button class="btn" id="chooseFileBtn">Choose CSV File</button>
                    <input type="file" id="csvFile" accept=".csv" style="display: none;" />
                </div>

                <div class="sample-format">
                    <strong>Expected CSV Format:</strong><br>
                    Update Name, Version, Security Severity, Release Date, Updates Missing, Recently Deployed, Details
                </div>

                <button class="btn btn-secondary" id="downloadSample">Download Sample CSV</button>
            </div>

            <!-- Data Preview Section -->
            <div class="data-preview" id="dataPreview">
                <div class="preview-header">
                    üìã Data Preview
                </div>
                <div class="preview-content">
                    <div id="dataStats" class="stats-grid"></div>
                    <table class="preview-table" id="previewTable"></table>
                </div>
            </div>

            <!-- Report Options Section -->
            <div class="report-options" id="reportOptions">
                <h3>üìã Report Configuration</h3>
                
                <div class="options-grid">
                    <div class="form-group">
                        <label for="reportTitle">Report Title</label>
                        <input type="text" id="reportTitle" value="Windows Update Compliance Report" />
                    </div>
                    
                    <div class="form-group">
                        <label for="organizationName">Organization Name</label>
                        <input type="text" id="organizationName" placeholder="Your Organization" />
                    </div>
                    
                    <div class="form-group">
                        <label for="reportPeriod">Report Period</label>
                        <input type="text" id="reportPeriod" placeholder="e.g., July 2025" />
                    </div>
                    
                    <div class="form-group">
                        <label for="reportTheme">Report Theme</label>
                        <select id="reportTheme">
                            <option value="professional">Professional Blue</option>
                            <option value="corporate">Corporate Gray</option>
                            <option value="modern">Modern Purple</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Include in Report</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeSummary" checked />
                            <label for="includeSummary">Executive Summary</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeSeverityChart" checked />
                            <label for="includeSeverityChart">Security Severity Chart</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeDeploymentChart" checked />
                            <label for="includeDeploymentChart">Deployment Status Chart</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeTrendChart" checked />
                            <label for="includeTrendChart">Monthly Trend Chart</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeDetailTable" checked />
                            <label for="includeDetailTable">Detailed Update Table</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeRecommendations" checked />
                            <label for="includeRecommendations">Recommendations</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="additionalNotes">Additional Notes</label>
                    <textarea id="additionalNotes" rows="3" placeholder="Add any custom notes or observations for this report period..."></textarea>
                </div>

                <button class="btn btn-success" id="generateReport" disabled>
                    üéØ Generate PDF Report
                </button>
            </div>

            <!-- Charts Preview Section -->
            <div class="charts-preview" id="chartsPreview">
                <h3>üìà Report Preview</h3>
                
                <div class="chart-container">
                    <div class="chart-title">Security Severity Distribution</div>
                    <canvas id="severityChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">Deployment Status Overview</div>
                    <canvas id="deploymentChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">Updates by Release Month</div>
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Status Section -->
            <div class="status-section" id="statusSection">
                <h4>üîÑ Generating Report...</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <p id="statusText">Preparing report generation...</p>
            </div>

            <!-- Download Section -->
            <div id="downloadSection" style="text-align: center; margin: 30px 0; display: none;">
                <div class="alert alert-success">
                    ‚úÖ Report generated successfully!
                </div>
                <a href="#" id="downloadLink" class="btn btn-success">
                    üì• Download PDF Report
                </a>
            </div>
        </div>
    </div>

    <!-- Include Chart.js for data visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Include jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Include jsPDF AutoTable plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // Global variables
        let csvData = [];
        let charts = {};
        
        // DOM elements
        const csvFile = document.getElementById('csvFile');
        const chooseFileBtn = document.getElementById('chooseFileBtn');
        const uploadSection = document.getElementById('uploadSection');
        const dataPreview = document.getElementById('dataPreview');
        const reportOptions = document.getElementById('reportOptions');
        const chartsPreview = document.getElementById('chartsPreview');
        const statusSection = document.getElementById('statusSection');
        const downloadSection = document.getElementById('downloadSection');
        const generateReportBtn = document.getElementById('generateReport');
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Windows Update Report Generator initializing...');
            
            // Setup event listeners
            setupEventListeners();
            
            // Load saved preferences
            loadSavedPreferences();
            
            console.log('Initialization complete');
        });
        
        function setupEventListeners() {
            // File upload button
            chooseFileBtn.addEventListener('click', () => {
                csvFile.click();
            });
            
            // File input change
            csvFile.addEventListener('change', handleFileUpload);
            
            // Drag and drop
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });
            
            uploadSection.addEventListener('dragleave', () => {
                uploadSection.classList.remove('dragover');
            });
            
            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.endsWith('.csv')) {
                    csvFile.files = files;
                    handleFileUpload();
                }
            });
            
            // Sample CSV download
            document.getElementById('downloadSample').addEventListener('click', downloadSampleCSV);
            
            // Generate report button
            generateReportBtn.addEventListener('click', generatePDFReport);
            
            // Save form data on change
            document.querySelectorAll('#reportOptions input, #reportOptions select, #reportOptions textarea').forEach(element => {
                element.addEventListener('change', saveFormData);
            });
        }
        
        function handleFileUpload() {
            const file = csvFile.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseCSVData(e.target.result);
                    showDataPreview();
                    showReportOptions();
                    generateCharts();
                    generateReportBtn.disabled = false;
                    showAlert('File uploaded successfully!', 'success');
                } catch (error) {
                    showAlert('Error parsing CSV file: ' + error.message, 'error');
                    console.error('Parse error:', error);
                }
            };
            reader.onerror = function() {
                showAlert('Error reading file', 'error');
            };
            reader.readAsText(file);
        }
        
        function parseCSVData(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) {
                throw new Error('CSV file must contain headers and at least one data row');
            }
            
            // Parse headers
            const headers = parseCSVLine(lines[0]);
            
            // Parse data rows
            csvData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index] || '';
                    });
                    if (row['Update Name']) { // Only add rows with update names
                        csvData.push(row);
                    }
                }
            }
            
            if (csvData.length === 0) {
                throw new Error('No valid data found in CSV');
            }
            
            console.log('Parsed CSV data:', csvData.length, 'rows');
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }
        
        function showDataPreview() {
            if (csvData.length === 0) return;
            
            // Generate statistics
            const stats = generateStatistics();
            displayStatistics(stats);
            
            // Show first 10 rows in table
            const table = document.getElementById('previewTable');
            const headers = Object.keys(csvData[0]);
            
            let tableHTML = '<thead><tr>';
            headers.forEach(h => {
                tableHTML += `<th>${h}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            csvData.slice(0, 10).forEach(row => {
                tableHTML += '<tr>';
                headers.forEach(h => {
                    const value = row[h];
                    const className = getSeverityClass(value);
                    tableHTML += `<td class="${className}">${value}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody>';
            table.innerHTML = tableHTML;
            
            dataPreview.classList.add('show');
        }
        
        function generateStatistics() {
            const totalUpdates = csvData.length;
            
            // Parse numbers correctly, removing any non-numeric characters
            const totalMissing = csvData.reduce((sum, row) => {
                const missing = parseInt(row['Updates Missing']?.toString().replace(/\D/g, '') || '0');
                return sum + (isNaN(missing) ? 0 : missing);
            }, 0);
            
            const totalDeployed = csvData.reduce((sum, row) => {
                const deployed = parseInt(row['Recently Deployed']?.toString().replace(/\D/g, '') || '0');
                return sum + (isNaN(deployed) ? 0 : deployed);
            }, 0);
            
            const severityCounts = csvData.reduce((acc, row) => {
                const severity = row['Security Severity'] || 'None';
                acc[severity] = (acc[severity] || 0) + 1;
                return acc;
            }, {});
            
            const criticalUpdates = severityCounts['Critical'] || 0;
            const importantUpdates = severityCounts['Important'] || 0;
            
            // Calculate compliance rate
            const totalDeploymentTargets = totalDeployed + totalMissing;
            const complianceRate = totalDeploymentTargets > 0 ? Math.round((totalDeployed / totalDeploymentTargets) * 100) : 100;
            
            return {
                totalUpdates,
                totalMissing,
                totalDeployed,
                criticalUpdates,
                importantUpdates,
                severityCounts,
                complianceRate
            };
        }
        
        function displayStatistics(stats) {
            const statsContainer = document.getElementById('dataStats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalUpdates}</div>
                    <div class="stat-label">Total Updates</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number severity-critical">${stats.criticalUpdates}</div>
                    <div class="stat-label">Critical Updates</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number severity-important">${stats.importantUpdates}</div>
                    <div class="stat-label">Important Updates</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.totalMissing}</div>
                    <div class="stat-label">Missing Deployments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.complianceRate}%</div>
                    <div class="stat-label">Compliance Rate</div>
                </div>
            `;
        }
        
        function getSeverityClass(value) {
            if (!value) return '';
            const severity = value.toString().toLowerCase();
            if (severity.includes('critical')) return 'severity-critical';
            if (severity.includes('important')) return 'severity-important';
            if (severity.includes('moderate')) return 'severity-moderate';
            if (severity.includes('low')) return 'severity-low';
            return '';
        }
        
        function showReportOptions() {
            reportOptions.classList.add('show');
        }
        
        function generateCharts() {
            generateSeverityChart();
            generateDeploymentChart();
            generateTrendChart();
            chartsPreview.classList.add('show');
        }
        
        // =================================================================
        // === SCALING FIX: This function has been updated for better scaling ===
        // =================================================================
        function generateSeverityChart() {
            const ctx = document.getElementById('severityChart').getContext('2d');
            
            const severityCounts = csvData.reduce((acc, row) => {
                const severity = row['Security Severity'] || 'None';
                acc[severity] = (acc[severity] || 0) + 1;
                return acc;
            }, {});
            
            const colors = {
                'Critical': '#dc3545',
                'Important': '#fd7e14',
                'Moderate': '#ffc107',
                'Low': '#28a745',
                'None': '#6c757d'
            };
            
            if (charts.severity) {
                charts.severity.destroy();
            }
            
            charts.severity = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(severityCounts),
                    datasets: [{
                        data: Object.values(severityCounts),
                        backgroundColor: Object.keys(severityCounts).map(s => colors[s] || '#6c757d')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                boxWidth: 25,
                                padding: 20
                            }
                        }
                    }
                }
            });
        }
        
        // =================================================================
        // === SCALING FIX: This function has been updated for better scaling ===
        // =================================================================
        function generateDeploymentChart() {
            const ctx = document.getElementById('deploymentChart').getContext('2d');
            
            const deploymentData = csvData.map(row => ({
                name: row['Update Name'],
                deployed: parseInt(row['Recently Deployed']?.toString().replace(/\D/g, '') || '0'),
                missing: parseInt(row['Updates Missing']?.toString().replace(/\D/g, '') || '0')
            }))
            .filter(d => d.deployed > 0 || d.missing > 0)
            .sort((a, b) => (b.deployed + b.missing) - (a.deployed + a.missing))
            .slice(0, 10);
            
            if (charts.deployment) {
                charts.deployment.destroy();
            }
            
            charts.deployment = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: deploymentData.map(d => d.name),
                    datasets: [
                        {
                            label: 'Deployed',
                            data: deploymentData.map(d => d.deployed),
                            backgroundColor: '#28a745'
                        },
                        {
                            label: 'Missing',
                            data: deploymentData.map(d => d.missing),
                            backgroundColor: '#dc3545'
                        }
                    ]
                },
                options: {
                    indexAxis: 'y', // This makes it a horizontal bar chart
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            stacked: false, 
                             ticks: {
                                font: {
                                    size: 14, // Increased font size
                                    weight: 'bold'
                                }
                            }
                        },
                        y: {
                            stacked: false,
                            ticks: {
                                font: {
                                    size: 12, // Increased font size
                                },
                                autoSkip: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14, // Increased font size
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        }

        // =================================================================
        // === SCALING FIX: This function has been updated for better scaling ===
        // =================================================================
        function generateTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // Group by month from Release Date
            const monthCounts = {};
            
            csvData.forEach(row => {
                const dateStr = row['Release Date'];
                if (dateStr) {
                    try {
                        // More robust date parsing
                        const dateParts = dateStr.split(/[-/]/); // handles YYYY-MM-DD and YYYY/MM/DD
                        if (dateParts.length === 3) {
                            const year = parseInt(dateParts[0]);
                            const month = parseInt(dateParts[1]) - 1; // JS months are 0-indexed
                            const day = parseInt(dateParts[2]);
                            const date = new Date(year, month, day);

                            if (!isNaN(date.getTime())) {
                                const monthKey = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                                monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
                            }
                        }
                    } catch (e) {
                        console.warn(`Could not parse date: ${dateStr}`);
                    }
                }
            });
            
            if (charts.trend) {
                charts.trend.destroy();
            }
            
            const sortedMonths = Object.keys(monthCounts).sort((a, b) => new Date(a) - new Date(b));
            
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Updates Released',
                        data: sortedMonths.map(month => monthCounts[month]),
                        borderColor: '#0078d4',
                        backgroundColor: 'rgba(0, 120, 212, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                         x: {
                            ticks: {
                                font: {
                                    size: 14, // Increased font size
                                    weight: 'bold'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 14, // Increased font size
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14, // Increased font size
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        }
        
        async function generatePDFReport() {
            statusSection.classList.add('show');
            updateProgress(0, 'Initializing report generation...');
            
            try {
                // Initialize jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                updateProgress(10, 'Creating report structure...');
                
                // Get form values
                const reportTitle = document.getElementById('reportTitle').value;
                const orgName = document.getElementById('organizationName').value;
                const reportPeriod = document.getElementById('reportPeriod').value;
                const additionalNotes = document.getElementById('additionalNotes').value;
                
                // Generate report content
                await createPDFContent(pdf, {
                    title: reportTitle,
                    organization: orgName,
                    period: reportPeriod,
                    notes: additionalNotes
                });
                
                updateProgress(100, 'Report generation complete!');
                
                // Create download link
                const pdfBlob = pdf.output('blob');
                const url = URL.createObjectURL(pdfBlob);
                const downloadLink = document.getElementById('downloadLink');
                downloadLink.href = url;
                downloadLink.download = `${reportTitle.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;
                downloadLink.classList.add('show');
                
                downloadSection.style.display = 'block';
                statusSection.classList.remove('show');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showAlert('Error generating PDF: ' + error.message, 'error');
                statusSection.classList.remove('show');
            }
        }
        
        async function createPDFContent(pdf, config) {
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            let currentPage = 1;
            
            // --- Title page ---
            updateProgress(20, 'Creating title page...');
            
            // Add logo/header background
            pdf.setFillColor(0, 120, 212);
            pdf.rect(0, 0, pageWidth, 60, 'F');
            
            // Title
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(28);
            pdf.text(config.title, pageWidth / 2, 30, { align: 'center' });
            
            // Organization
            if (config.organization) {
                pdf.setFontSize(18);
                pdf.text(config.organization, pageWidth / 2, 45, { align: 'center' });
            }
            
            // Reset text color
            pdf.setTextColor(0, 0, 0);
            
            // Report info box
            pdf.setFillColor(248, 249, 250);
            pdf.rect(20, 80, pageWidth - 40, 40, 'F');
            
            pdf.setFontSize(12);
            pdf.text(`Report Period: ${config.period || 'Current'}`, pageWidth / 2, 95, { align: 'center' });
            pdf.text(`Generated: ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`, pageWidth / 2, 105, { align: 'center' });
            
            // Statistics summary on first page
            const stats = generateStatistics();
            let y = 140;
            
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('Key Metrics', pageWidth / 2, y, { align: 'center' });
            
            y += 15;
            pdf.setFont(undefined, 'normal');
            pdf.setFontSize(11);
            
            // Create metric boxes
            const metrics = [
                { label: 'Total Updates', value: stats.totalUpdates, color: [0, 120, 212] },
                { label: 'Critical Updates', value: stats.criticalUpdates, color: [220, 53, 69] },
                { label: 'Compliance Rate', value: stats.complianceRate + '%', color: [40, 167, 69] }
            ];
            
            const boxWidth = 50;
            const boxHeight = 25;
            const startX = (pageWidth - (metrics.length * boxWidth + (metrics.length - 1) * 10)) / 2;
            
            metrics.forEach((metric, i) => {
                const x = startX + (i * (boxWidth + 10));
                
                pdf.setFillColor(...metric.color);
                pdf.rect(x, y, boxWidth, boxHeight, 'F');
                
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text(metric.value.toString(), x + boxWidth / 2, y + 10, { align: 'center' });
                
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'normal');
                pdf.text(metric.label, x + boxWidth / 2, y + 18, { align: 'center' });
            });
            
            pdf.setTextColor(0, 0, 0);
            
            // --- Executive Summary (if enabled) ---
            if (document.getElementById('includeSummary').checked) {
                updateProgress(30, 'Adding executive summary...');
                
                pdf.addPage();
                currentPage++;
                
                addPageHeader(pdf, 'Executive Summary', currentPage);
                
                let y = 40;
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'normal');
                
                const summary = [
                    `This report analyzes ${stats.totalUpdates} Windows updates across the organization. ` +
                    `Currently, ${stats.complianceRate}% of required updates have been deployed successfully.`,
                    '',
                    `Security Overview: ${stats.criticalUpdates} critical and ${stats.importantUpdates} important security updates ` +
                    `have been identified. ${stats.totalMissing} total deployments are pending across all systems.`,
                    '',
                    stats.criticalUpdates > 0 ? 
                        `ATTENTION: ${stats.criticalUpdates} critical security updates require immediate deployment to maintain security posture.` :
                        'All critical security updates have been successfully deployed.',
                    '',
                    config.notes || ''
                ];
                
                summary.forEach(paragraph => {
                    if (paragraph) {
                        const lines = pdf.splitTextToSize(paragraph, pageWidth - 40);
                        lines.forEach(line => {
                            if (y > pageHeight - 30) {
                                pdf.addPage();
                                currentPage++;
                                addPageHeader(pdf, 'Executive Summary (continued)', currentPage);
                                y = 40;
                            }
                            pdf.text(line, 20, y);
                            y += 6;
                        });
                        y += 4;
                    }
                });
            }
            
            // --- Charts ---
            updateProgress(50, 'Adding charts...');
            
            if (document.getElementById('includeSeverityChart').checked) {
                currentPage = await addChartToPDF(pdf, 'severityChart', 'Security Severity Distribution', currentPage);
            }
            
            if (document.getElementById('includeDeploymentChart').checked) {
                currentPage = await addChartToPDF(pdf, 'deploymentChart', 'Top 10 Updates - Deployment Status', currentPage);
            }
            
            if (document.getElementById('includeTrendChart').checked) {
                currentPage = await addChartToPDF(pdf, 'trendChart', 'Update Release Timeline', currentPage);
            }
            
            // --- Detailed table ---
            updateProgress(70, 'Adding detailed tables...');
            
            if (document.getElementById('includeDetailTable').checked) {
                currentPage = addDetailedTable(pdf, currentPage);
            }
            
            // --- Recommendations ---
            updateProgress(85, 'Adding recommendations...');
            
            if (document.getElementById('includeRecommendations').checked) {
                currentPage = addRecommendations(pdf, stats, currentPage);
            }
            
            updateProgress(95, 'Finalizing report...');
        }
        
        function addPageHeader(pdf, title, pageNum) {
            const pageWidth = pdf.internal.pageSize.getWidth();
            
            // Header bar
            pdf.setFillColor(240, 248, 255);
            pdf.rect(0, 0, pageWidth, 25, 'F');
            
            // Title
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(51, 51, 51);
            pdf.text(title, 20, 15);
            
            // Page number
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.setTextColor(108, 117, 125);
            pdf.text(`Page ${pageNum}`, pageWidth - 20, 15, { align: 'right' });
            
            // Line
            pdf.setDrawColor(0, 120, 212);
            pdf.setLineWidth(0.5);
            pdf.line(0, 25, pageWidth, 25);

            // Reset text color for content
            pdf.setTextColor(0, 0, 0);
        }
        
        async function addChartToPDF(pdf, chartId, title, pageNum) {
            pdf.addPage();
            pageNum++;
            addPageHeader(pdf, title, pageNum);
            
            const canvas = document.getElementById(chartId);
            // Ensure chart animation is complete before getting data URL
            await new Promise(resolve => setTimeout(resolve, 500));
            const imgData = canvas.toDataURL('image/png', 1.0); 
            
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 20;
            const contentWidth = pageWidth - margin * 2;
            const maxHeight = 160; // Increased max height for better readability
            
            // Calculate image dimensions to fit within a bounding box, preserving aspect ratio
            const aspectRatio = canvas.width / canvas.height;
            let finalWidth = contentWidth;
            let finalHeight = finalWidth / aspectRatio;

            // If the calculated height is too big, we cap it and recalculate width to maintain aspect ratio
            if (finalHeight > maxHeight) {
                finalHeight = maxHeight;
                finalWidth = finalHeight * aspectRatio;
            }
            
            // If the calculated width is still too wide for the page, shrink it and the height again.
            if (finalWidth > contentWidth) {
                finalWidth = contentWidth;
                finalHeight = finalWidth / aspectRatio;
            }

            // Center the final image horizontally and place it vertically after the header
            const x = (pageWidth - finalWidth) / 2;
            const y = 40;
            
            pdf.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);
            
            // Add chart insights below the chart
            const insights = getChartInsights(chartId);
            if (insights) {
                let textY = y + finalHeight + 15;
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'normal');
                
                insights.forEach(insight => {
                    const lines = pdf.splitTextToSize(`‚Ä¢ ${insight}`, contentWidth);
                    lines.forEach(line => {
                         if (textY > pageHeight - 30) { // Check for page overflow
                            pdf.addPage();
                            pageNum++;
                            addPageHeader(pdf, `${title} (continued)`, pageNum);
                            textY = 40;
                        }
                        pdf.text(line, margin, textY);
                        textY += 6;
                    });
                    textY += 4; // Add a little space between bullet points
                });
            }
            
            return pdf.internal.getNumberOfPages();
        }

        function getChartInsights(chartId) {
            const stats = generateStatistics();
            
            switch(chartId) {
                case 'severityChart':
                    return [
                        `${Math.round((stats.criticalUpdates / stats.totalUpdates) * 100)}% of updates are classified as Critical severity.`,
                        `${Object.keys(stats.severityCounts).length} different severity levels identified across all updates.`,
                        stats.criticalUpdates > 5 ? 'High number of critical updates indicates elevated security risk.' : 'Critical update count is within acceptable range.'
                    ];
                case 'deploymentChart':
                    const deploymentData = csvData.filter(d => parseInt(d['Recently Deployed'] || '0') > 0 || parseInt(d['Updates Missing'] || '0') > 0);
                    return [
                        `The chart shows the top ${Math.min(10, deploymentData.length)} updates with the highest deployment volumes.`,
                        `A total of ${stats.totalMissing} deployments are pending across all updates.`,
                        `The overall deployment compliance rate is ${stats.complianceRate}%.`
                    ];
                case 'trendChart':
                    return [
                        'This chart illustrates the volume of updates released over time, reflecting Microsoft\'s regular patch cycle.',
                        'Peaks in the timeline typically align with "Patch Tuesday" releases.',
                        'A consistent flow of updates indicates active security maintenance from the vendor.'
                    ];
                default:
                    return null;
            }
        }
        
        function addDetailedTable(pdf, currentPage) {
            pdf.addPage();
            currentPage++;
            addPageHeader(pdf, 'Detailed Update List', currentPage);
            const firstTablePage = currentPage;
            
            // Prepare table data - Use ALL data, not just a slice
            const tableData = csvData.map(row => [
                row['Update Name'] || '',
                row['Version']?.substring(0, 20) || '',
                row['Security Severity'] || '',
                row['Release Date'] || '',
                row['Updates Missing'] || '0',
                row['Recently Deployed'] || '0'
            ]);
            
            // Add table using autoTable
            pdf.autoTable({
                head: [['Update Name', 'Version', 'Severity', 'Release Date', 'Missing', 'Deployed']],
                body: tableData,
                startY: 35,
                theme: 'striped',
                headStyles: {
                    fillColor: [0, 120, 212],
                    fontSize: 9,
                    fontStyle: 'bold'
                },
                bodyStyles: {
                    fontSize: 8,
                    cellPadding: 2,
                },
                columnStyles: {
                    // A4 page width is 210mm. Margins are 20mm each side. Content width = 170mm.
                    // New widths add up to 170mm.
                    0: { cellWidth: 65 }, 
                    1: { cellWidth: 25 },
                    2: { cellWidth: 20 },
                    3: { cellWidth: 25 },
                    4: { cellWidth: 15, halign: 'center' },
                    5: { cellWidth: 20, halign: 'center' }
                },
                didDrawPage: function(data) {
                    // Add our custom header to all pages created by autoTable after the first one.
                    if (data.pageNumber > firstTablePage) {
                        addPageHeader(pdf, 'Detailed Update List (continued)', data.pageNumber);
                    }
                }
            });
            
            // Return the new total page count
            return pdf.internal.getNumberOfPages();
        }
        
        function addRecommendations(pdf, stats, currentPage) {
            pdf.addPage();
            currentPage++;
            addPageHeader(pdf, 'Recommendations & Action Items', currentPage);
            
            let y = 40;
            pdf.setFontSize(11);
            
            const recommendations = [
                {
                    priority: 'CRITICAL',
                    condition: stats.criticalUpdates > 0,
                    title: 'Deploy Critical Security Updates',
                    text: `Immediately deploy ${stats.criticalUpdates} critical security updates to prevent potential security breaches. These updates address vulnerabilities that could be actively exploited.`,
                    color: [220, 53, 69]
                },
                {
                    priority: 'HIGH',
                    condition: stats.complianceRate < 90,
                    title: 'Improve Compliance Rate',
                    text: `Current ${stats.complianceRate}% compliance is below the 90% target. Implement automated deployment policies and expand maintenance windows to improve update adoption.`,
                    color: [253, 126, 20]
                },
                {
                    priority: 'MEDIUM',
                    condition: stats.totalMissing > 100,
                    title: 'Address Deployment Backlog',
                    text: `${stats.totalMissing} missing deployments indicate a significant backlog. Consider phased deployment approach prioritizing critical systems first.`,
                    color: [255, 193, 7]
                },
                {
                    priority: 'STANDARD',
                    condition: true,
                    title: 'Regular Review Process',
                    text: 'Maintain monthly update compliance reviews and quarterly security posture assessments to ensure continued system health.',
                    color: [40, 167, 69]
                }
            ];
            
            recommendations.filter(r => r.condition).forEach(rec => {
                if (y > 240) {
                    pdf.addPage();
                    currentPage++;
                    addPageHeader(pdf, 'Recommendations & Action Items (continued)', currentPage);
                    y = 40;
                }
                
                // Priority badge
                pdf.setFillColor(...rec.color);
                pdf.rect(20, y - 5, 35, 8, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(8);
                pdf.setFont(undefined, 'bold');
                pdf.text(rec.priority, 37.5, y, { align: 'center' });
                
                // Title
                pdf.setTextColor(0, 0, 0);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text(rec.title, 60, y);
                
                y += 8;
                
                // Description
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                const lines = pdf.splitTextToSize(rec.text, 150);
                lines.forEach(line => {
                    pdf.text(line, 25, y);
                    y += 5;
                });
                
                y += 10;
            });
            
            return pdf.internal.getNumberOfPages();
        }
        
        function updateProgress(percentage, text) {
            const progressFill = document.getElementById('progressFill');
            const statusText = document.getElementById('statusText');
            
            progressFill.style.width = percentage + '%';
            progressFill.textContent = percentage + '%';
            statusText.textContent = text;
        }
        
        function downloadSampleCSV() {
            const sampleData = [
                ['Update Name', 'Version', 'Security Severity', 'Release Date', 'Updates Missing', 'Recently Deployed', 'Details'],
                ['Windows Security Update KB5034441', '2025-01', 'Critical', '2025-01-10', '15', '85', '1'],
                ['Microsoft Defender Definition Update', '1.403.2956.0', 'Important', '2025-01-12', '3', '97', '1'],
                ['Microsoft Edge Security Update', '120.0.2210.144', 'Important', '2025-01-08', '8', '92', '1'],
                ['Windows Cumulative Update KB5034439', '2025-01', 'Moderate', '2025-01-10', '22', '78', '1'],
                ['.NET Framework Security Update', '4.8.1', 'Important', '2025-01-09', '12', '88', '1'],
                ['Office Security Update KB5034442', '16.0.17328', 'Critical', '2025-01-10', '5', '95', '1'],
                ['Windows Defender Update', '1.403.2958.0', 'Important', '2025-01-14', '10', '90', '1'],
                ['Visual C++ Redistributable Update', '14.38.33130', 'Moderate', '2025-01-05', '30', '70', '1'],
                ['Windows Malicious Software Removal Tool', '5.120', 'Low', '2025-01-10', '0', '100', '1'],
                ['SQL Server Security Update', '15.0.4365.2', 'Critical', '2025-01-08', '18', '82', '1']
            ];
            
            const csvContent = sampleData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample_update_data.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(alertDiv, mainContent.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        function saveFormData() {
            const formData = {
                reportTitle: document.getElementById('reportTitle').value,
                organizationName: document.getElementById('organizationName').value,
                reportPeriod: document.getElementById('reportPeriod').value,
                reportTheme: document.getElementById('reportTheme').value,
                additionalNotes: document.getElementById('additionalNotes').value,
                options: {
                    includeSummary: document.getElementById('includeSummary').checked,
                    includeSeverityChart: document.getElementById('includeSeverityChart').checked,
                    includeDeploymentChart: document.getElementById('includeDeploymentChart').checked,
                    includeTrendChart: document.getElementById('includeTrendChart').checked,
                    includeDetailTable: document.getElementById('includeDetailTable').checked,
                    includeRecommendations: document.getElementById('includeRecommendations').checked
                }
            };
            localStorage.setItem('updateReportFormData', JSON.stringify(formData));
        }
        
        function loadSavedPreferences() {
            // Load organization name
            const orgName = localStorage.getItem('updateReportOrgName');
            if (orgName) {
                document.getElementById('organizationName').value = orgName;
            }
            
            // Save organization name on change
            document.getElementById('organizationName').addEventListener('change', (e) => {
                localStorage.setItem('updateReportOrgName', e.target.value);
            });
            
            // Auto-populate current month
            const currentMonth = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('reportPeriod').value = currentMonth;
            
            // Load saved form data
            const saved = localStorage.getItem('updateReportFormData');
            if (saved) {
                try {
                    const formData = JSON.parse(saved);
                    if (csvData.length === 0) { // Only load if no file uploaded yet
                        document.getElementById('reportTitle').value = formData.reportTitle || 'Windows Update Compliance Report';
                        document.getElementById('reportTheme').value = formData.reportTheme || 'professional';
                        document.getElementById('additionalNotes').value = formData.additionalNotes || '';
                        
                        if (formData.options) {
                            Object.keys(formData.options).forEach(key => {
                                const checkbox = document.getElementById(key);
                                if (checkbox) {
                                    checkbox.checked = formData.options[key];
                                }
                            });
                        }
                    }
                } catch (e) {
                    console.error('Error loading saved form data:', e);
                }
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + O to open file
            if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
                e.preventDefault();
                csvFile.click();
            }
            
            // Ctrl/Cmd + G to generate report
            if ((e.ctrlKey || e.metaKey) && e.key === 'g' && !generateReportBtn.disabled) {
                e.preventDefault();
                generateReportBtn.click();
            }
        });
        
        console.log('Windows Update Report Generator initialized successfully');
    </script>
</body>
</html>
